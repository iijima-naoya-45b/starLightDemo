---
title: Dockerネットワーク完全ガイド
sidebar:
    label: Dockerネットワーク
---

# Dockerネットワーク完全ガイド

Dockerのネットワーク機能を、実務で使える実装例とともに詳しく解説します。

## 1. Dockerネットワークとは

### ネットワークの役割

Dockerネットワークは、コンテナ間の通信を可能にし、コンテナを外部からアクセス可能にします。

```
コンテナ1
   ↓（ネットワーク）
コンテナ2
   ↓（ネットワーク）
外部（インターネット）
```

### なぜネットワークが必要か

**❌ 不正確な説明:**

```markdown
# ❌ 誤解: 「ネットワークがないとコンテナ間で通信できない」
# 厳密には、デフォルトで bridge という共通ネットワークに繋がっているため、
# IPアドレスを直接指定すれば通信は可能です。
```

**🪓 コードレビューでの指摘文例:**

```
【指摘】「なぜネットワークが必要か」の解説が不正確です。
【問題】「ネットワークがないとコンテナ間で通信できない」という説明がありますが、
       厳密にはデフォルトで bridge という共通ネットワークに繋がっているため、
       IPアドレスを直接指定すれば通信は可能です。
【影響】ネットワークを作る真の目的が理解されない
【推奨】ネットワークを作る真の目的は、「通信できないことの解消」ではなく、
       「名前解決（Service Discovery）」と「ネットワーク的隔離」です。
       「ユーザー定義ネットワークを作成することで、コンテナ名（dbなど）で通信できるようになり、
       IPアドレスの変動を意識しなくて済むようになる」というメリットを強調すべきです。
```

**✅ 正確な説明:**

**問題のある構成（デフォルトネットワークの限界）:**

```bash
# ❌ 問題: IPアドレスを直接指定する必要がある
docker run -d --name app my-app:latest
docker run -d --name db postgres:14

# 問題点:
# 1. IPアドレスを直接指定する必要がある（例: 172.17.0.2:5432）
# 2. コンテナの再起動でIPアドレスが変わる可能性がある
# 3. ネットワーク的隔離ができない（すべてのコンテナが同じネットワークに接続）
# 4. サービス名（db）で通信できない
```

**解決: ユーザー定義ネットワークによる名前解決と隔離**

```bash
# ✅ 解決: ユーザー定義ネットワークの作成
docker network create my-network
docker run -d --name app --network my-network my-app:latest
docker run -d --name db --network my-network postgres:14

# メリット:
# 1. ✅ 名前解決（Service Discovery）: コンテナ名（db）で通信できる
#    appコンテナから: DATABASE_URL=postgresql://postgres:password@db:5432/mydb
#    IPアドレスの変動を意識しなくて済む
# 2. ✅ ネットワーク的隔離: 異なるネットワークのコンテナは通信できない
# 3. ✅ セキュリティ: 必要なコンテナのみを同じネットワークに接続できる
```

**真の目的:**

1. **名前解決（Service Discovery）**: コンテナ名で通信できるようになり、IPアドレスの変動を意識しなくて済む
2. **ネットワーク的隔離**: 異なるネットワークのコンテナは通信できないため、セキュリティが向上
3. **管理の容易さ**: ネットワークごとにコンテナをグループ化できる

## 2. ネットワークの種類

### bridgeネットワーク（デフォルト）

```bash
# デフォルトのbridgeネットワーク
docker network ls

# カスタムbridgeネットワークの作成
docker network create my-bridge-network

# コンテナをネットワークに接続
docker run -d --name app --network my-bridge-network my-app:latest
```

### hostネットワーク（注意: 実務では「劇薬」）

**❌ 問題のある実装:**

```bash
# ❌ 問題: hostネットワークをポートマッピング不要な便利なものとして使用
docker run -d --name app --network host my-app:latest

# 問題点:
# 1. セキュリティ: ホストのポートを直接占有するため、ポート競合が避けられない
# 2. コンテナ間の隔離が失われる
# 3. プラットフォーム依存: macOS や Windows の Docker Desktop では、
#    host モードは期待通りに動作しません（仮想マシンを介しているため）
```

**🪓 コードレビューでの指摘文例:**

```
【指摘】host ネットワークの「副作用」への言及がないです。
【問題】host ネットワークをポートマッピング不要な便利なものとして紹介していますが、
       これは実務では「劇薬」です。
       セキュリティ: ホストのポートを直接占有するため、ポート競合が避けられず、
       コンテナ間の隔離も失われます。
       プラットフォーム依存: macOS や Windows の Docker Desktop では、
       host モードは期待通りに動作しません（仮想マシンを介しているため）。
【影響】セキュリティリスクの増大、プラットフォーム依存の問題、ポート競合
【推奨】特殊なパフォーマンス要件がない限り、原則 bridge を使うべきであるという
       ガードレールを引いてください。
```

**✅ 改善されたアプローチ（bridgeネットワークを推奨）:**

```bash
# ✅ 推奨: bridgeネットワークを使用（ポートマッピング）
docker run -d --name app -p 3000:3000 --network my-network my-app:latest

# メリット:
# 1. ✅ セキュリティ: コンテナ間の隔離が保たれる
# 2. ✅ ポート競合の回避: ホストのポートを直接占有しない
# 3. ✅ プラットフォーム互換性: macOS/Windows でも正常に動作
# 4. ✅ 柔軟性: 複数のコンテナを同じポートで実行できる（異なるホストポートにマッピング）
```

**hostネットワークを使用すべき特殊なケース:**

```bash
# ✅ 使用例: 特殊なパフォーマンス要件がある場合のみ
# 例: 高頻度のネットワークI/Oが必要なアプリケーション
# ただし、以下のリスクを理解した上で使用すること:
# 1. セキュリティリスク
# 2. プラットフォーム依存の問題
# 3. ポート競合のリスク

docker run -d --name app --network host my-app:latest

# 注意: macOS/Windows では期待通りに動作しない可能性がある
```

**推奨アプローチ:**

- **原則**: bridgeネットワークを使用し、ポートマッピングで外部アクセスを制御
- **例外**: 特殊なパフォーマンス要件がある場合のみ、hostネットワークを検討（リスクを理解した上で）

### noneネットワーク

```bash
# ネットワークを無効化
docker run -d --name app --network none my-app:latest

# 外部との通信ができない
```

## 3. Docker Composeでのネットワーク

### デフォルトネットワーク

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
  
  db:
    image: postgres:14-alpine

# 自動的に同じネットワークに接続される
```

### カスタムネットワーク

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    networks:
      - frontend
      - backend
  
  db:
    image: postgres:14-alpine
    networks:
      - backend

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
```

### 外部ネットワーク

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    networks:
      - existing-network

networks:
  existing-network:
    external: true
```

## 4. コンテナ間通信

### サービス名での通信

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/mydb
  
  db:
    image: postgres:14-alpine

# appコンテナからdbコンテナにアクセス可能
```

### リンクの使用（非推奨）

```bash
# リンクの使用（非推奨）
docker run -d --name app --link db:database my-app:latest
```

## 5. ポートの公開

### ポートマッピング

```yaml
# docker-compose.yml
services:
  app:
    build: .
    ports:
      - "3000:3000"  # ホスト:コンテナ
      - "8080:80"    # 複数ポート
```

### ポート範囲の公開

```yaml
services:
  app:
    build: .
    ports:
      - "3000-3010:3000-3010"
```

## 6. 実務でのベストプラクティス

### パターン1: マイクロサービスアーキテクチャ

```yaml
# docker-compose.yml
version: '3.8'

services:
  api:
    build: ./api
    networks:
      - app-network
  
  frontend:
    build: ./frontend
    networks:
      - app-network
    ports:
      - "3000:3000"
  
  db:
    image: postgres:14-alpine
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
```

### パターン2: ネットワークの分離（内部用ネットワークの活用）

**❌ 問題のある実装:**

```yaml
# docker-compose.yml
version: '3.8'

services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    networks:
      - app-network
  
  db:
    image: postgres:14-alpine
    networks:
      - app-network  # ❌ frontend と同じネットワークに入れている

networks:
  app-network:
    driver: bridge

# 問題点:
# 1. frontend が侵害された際に db への攻撃経路が生まれる
# 2. 誤って DB ポートを外部公開してしまうリスクがある
# 3. セキュリティが「デフォルトで許可」の状態になっている
```

**🪓 コードレビューでの指摘文例:**

```
【指摘】「内部用（internal）」ネットワークの活用不足です。
【問題】実装例では db を frontend と同じネットワークに入れていますが、
       これでは frontend が侵害された際に db への攻撃経路が生まれます
       （あるいは誤って DB ポートを公開してしまうリスクがあります）。
【影響】セキュリティリスクの増大、攻撃面の拡大
【推奨】internal: true オプションを紹介しているのは良いですが、さらに一歩進めて
       「外部インターネット接続すら不要な DB 専用ネットワーク」を構築し、
       セキュリティを「デフォルトで拒否」の状態にする設計を推奨すべきです。
```

**✅ 改善された実装（内部用ネットワークの活用）:**

```yaml
# docker-compose.yml
version: '3.8'

services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    networks:
      - frontend-network
      - app-network  # ✅ アプリケーション層のネットワーク
  
  backend:
    build: ./backend
    networks:
      - app-network
      - db-network  # ✅ DB層のネットワーク（frontend からは直接アクセス不可）
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/mydb
  
  db:
    image: postgres:14-alpine
    networks:
      - db-network  # ✅ DB専用ネットワーク（internal: true）
    # ✅ ポートは公開しない（コンテナ間通信のみ）
    # ports:
    #   - "5432:5432"  # 公開しない

networks:
  frontend-network:
    driver: bridge
    # ✅ フロントエンドは外部からアクセス可能
  
  app-network:
    driver: bridge
    # ✅ アプリケーション層（frontend と backend の間）
  
  db-network:
    driver: bridge
    internal: true  # ✅ 外部インターネット接続を完全に拒否
    # メリット:
    # - DB は外部からアクセス不可（セキュリティ向上）
    # - frontend から直接 DB にアクセスできない（攻撃経路の遮断）
    # - セキュリティが「デフォルトで拒否」の状態

# ネットワーク構造:
# frontend (3000) ←→ frontend-network ←→ app-network ←→ backend ←→ db-network ←→ db (5432)
#                                                                                    ↑
#                                                                         internal: true で外部接続不可
```

**セキュリティの層別防御:**

1. **フロントエンド層**: 外部からアクセス可能（ポート3000を公開）
2. **アプリケーション層**: フロントエンドとバックエンドの間の通信のみ
3. **データベース層**: バックエンドからのみアクセス可能、外部接続を完全に拒否（`internal: true`）

**メリット:**

- **攻撃経路の遮断**: frontendが侵害されても、dbへの直接アクセスができない
- **デフォルトで拒否**: `internal: true`により、外部接続を完全に拒否
- **誤設定の防止**: DBポートを誤って公開しても、`internal: true`により外部からアクセスできない

## 7. よくある問題と解決策

### 問題1: コンテナ間で通信できない

**原因:**
- 同じネットワークに接続されていない
- サービス名が間違っている

**解決策:**
```bash
# ネットワークの確認
docker network inspect network_name

# コンテナのネットワーク確認
docker inspect container_name | grep NetworkMode
```

### 問題2: ポートが公開されない

**原因:**
- ポートマッピングが正しく設定されていない
- ファイアウォールでブロックされている

**解決策:**
```yaml
# ポートマッピングの確認
services:
  app:
    ports:
      - "3000:3000"  # 正しい形式
```

## まとめ

Dockerネットワークの適切な設計は、セキュリティ、保守性、パフォーマンスに大きく影響します。

**シニアエンジニアとして考慮すべき点:**

1. **ネットワークの真の目的**: 「通信できないことの解消」ではなく、「名前解決（Service Discovery）」と「ネットワーク的隔離」です。ユーザー定義ネットワークを作成することで、コンテナ名（dbなど）で通信できるようになり、IPアドレスの変動を意識しなくて済むようになります。
2. **hostネットワークの使用**: 特殊なパフォーマンス要件がない限り、原則bridgeを使うべきです。hostネットワークは、セキュリティリスク、プラットフォーム依存の問題、ポート競合のリスクがあるため、「劇薬」として扱うべきです。
3. **内部用（internal）ネットワークの活用**: DBを外から隠すため、「外部インターネット接続すら不要なDB専用ネットワーク」を構築し、セキュリティを「デフォルトで拒否」の状態にする設計を推奨します。
4. **層別防御**: フロントエンド層、アプリケーション層、データベース層を分離し、必要な通信のみを許可します。

#### コードレビューで指摘すべきポイント

1. **ネットワークの目的の誤解**: 「ネットワークがないと通信できない」という説明がある場合は、名前解決とネットワーク的隔離の重要性を指摘
2. **hostネットワークの無条件使用**: hostネットワークを使用している場合は、bridgeネットワークへの変更を推奨
3. **内部用ネットワークの活用不足**: DBをfrontendと同じネットワークに入れている場合は、`internal: true`オプションを使用したDB専用ネットワークの構築を推奨

これで、Dockerネットワークの基礎知識と実務での使い方を理解できるようになりました。

