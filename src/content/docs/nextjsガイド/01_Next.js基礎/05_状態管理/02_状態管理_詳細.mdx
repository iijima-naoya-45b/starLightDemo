---
title: "Next.jsã®çŠ¶æ…‹ç®¡ç†"
label: "Next.jsã®çŠ¶æ…‹ç®¡ç†"
---

## ğŸ”„ Next.jsã®çŠ¶æ…‹ç®¡ç†

Next.jsã§ã¯ã€ã•ã¾ã–ã¾ãªæ–¹æ³•ã§çŠ¶æ…‹ç®¡ç†ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’åŠ¹ç‡çš„ã«ç®¡ç†ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

> **ğŸ“š çŠ¶æ…‹ç®¡ç†ã®åŸºç¤ã«ã¤ã„ã¦**: çŠ¶æ…‹ç®¡ç†ã®åŸºæœ¬æ¦‚å¿µï¼ˆä¸‰æ¨©åˆ†ç«‹ã€Context APIã€SWR vs TanStack Queryãªã©ï¼‰ã«ã¤ã„ã¦ã¯ã€[çŠ¶æ…‹ç®¡ç†](/nextjsã‚¬ã‚¤ãƒ‰/01_Next.jsåŸºç¤/05_çŠ¶æ…‹ç®¡ç†/01_çŠ¶æ…‹ç®¡ç†)ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

> **âš›ï¸ Reactã§ã®çŠ¶æ…‹ç®¡ç†ã«ã¤ã„ã¦**: Reactã§ã®çŠ¶æ…‹ç®¡ç†ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[Reactã‚¬ã‚¤ãƒ‰ã®çŠ¶æ…‹ç®¡ç†](/Reactã‚¬ã‚¤ãƒ‰/02_çŠ¶æ…‹ç®¡ç†/01_Context_API/01_Context_API)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

---

---

## çŠ¶æ…‹ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

å„çŠ¶æ…‹ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †ã‚’ã€å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚’äº¤ãˆãªãŒã‚‰è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

---

## 1. Reactã®useStateã¨useReducer

> **ğŸ“š è©³ç´°**: Reactã§ã®useStateã¨useReducerã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[Reactã‚¬ã‚¤ãƒ‰ã®useStateã¨useEffect](/Reactã‚¬ã‚¤ãƒ‰/01_ReactåŸºç¤/03_ãƒ•ãƒƒã‚¯/01_useStateã¨useEffect)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

Reactã®`useState`ã¨`useReducer`ãƒ•ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚Œã‚‰ã¯Reactã«çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€**è¿½åŠ ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ä¸è¦**ã§ã™ã€‚

Next.jsã§ã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆ`'use client'`ï¼‰ã§ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

---

## 2. Context API

> **ğŸ“š è©³ç´°**: Context APIã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[Reactã‚¬ã‚¤ãƒ‰ã®Context API](/Reactã‚¬ã‚¤ãƒ‰/02_çŠ¶æ…‹ç®¡ç†/01_Context_API/01_Context_API)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

Context APIã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒ„ãƒªãƒ¼å…¨ä½“ã§çŠ¶æ…‹ã‚’å…±æœ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:**
- **è¿½åŠ ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**: ä¸è¦ï¼ˆReactã«çµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ï¼‰
- **ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®è¨­å®š**: å¿…è¦ï¼ˆNext.jsã®App Routerã§ã¯`app/layout.tsx`ã§`Provider`ã‚’é…ç½®ï¼‰

### Next.js App Routerã§ã®è¨­å®š

```typescript
// context/ThemeContext.tsx
'use client';

import { createContext, useContext, useState, ReactNode } from 'react';

type Theme = 'light' | 'dark';

interface ThemeContextType {
  theme: Theme;
  setTheme: (theme: Theme) => void;
}

const ThemeContext = createContext<ThemeContextType | undefined>(undefined);

export function ThemeProvider({ children }: { children: ReactNode }) {
  const [theme, setTheme] = useState<Theme>('light');
  
  return (
    <ThemeContext.Provider value={{ theme, setTheme }}>
      {children}
    </ThemeContext.Provider>
  );
}

export function useTheme() {
  const context = useContext(ThemeContext);
  if (context === undefined) {
    throw new Error('useTheme must be used within a ThemeProvider');
  }
  return context;
}

// app/layout.tsx
import { ThemeProvider } from '@/context/ThemeContext';

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <body>
        <ThemeProvider>
          {children}
        </ThemeProvider>
      </body>
    </html>
  );
}
```

**Next.jså›ºæœ‰ã®æ³¨æ„ç‚¹:**
- Contextã®ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯`'use client'`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ãŒå¿…è¦ã§ã™
- Next.js App Routerã§ã¯ã€`app/layout.tsx`ã§Providerã‚’é…ç½®ã—ã¾ã™

---

## 3. Zustand

> **ğŸ“š è©³ç´°**: Zustandã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[çŠ¶æ…‹ç®¡ç†](/nextjsã‚¬ã‚¤ãƒ‰/01_Next.jsåŸºç¤/05_çŠ¶æ…‹ç®¡ç†/01_çŠ¶æ…‹ç®¡ç†)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

Zustandã¯ã€è»½é‡ã§ã‚·ãƒ³ãƒ—ãƒ«ãªçŠ¶æ…‹ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚

**ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:**
- **ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**: `npm install zustand`
- **ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®è¨­å®š**: ä¸è¦ï¼ˆZustandã¯ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ä¸è¦ï¼‰
- **TypeScript**: å‹å®šç¾©ãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹

### Next.jsã§ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

#### ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install zustand
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¹ãƒˆã‚¢ã®ä½œæˆ

```typescript
// store/useCartStore.ts
'use client';

import { create } from 'zustand';

interface CartStore {
  items: CartItem[];
  addItem: (item: CartItem) => void;
}

export const useCartStore = create<CartStore>((set) => ({
  items: [],
  addItem: (item) => set((state) => ({ items: [...state.items, item] })),
}));
```

#### ã‚¹ãƒ†ãƒƒãƒ—3: Next.jsã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½¿ç”¨

```typescript
// app/products/[id]/page.tsx
'use client';

import { useCartStore } from '@/store/useCartStore';

export default function ProductPage({ params }: { params: Promise<{ id: string }> }) {
  const { id } = await params;
  const addItem = useCartStore((state) => state.addItem);
  
  return (
    <div>
      <button onClick={() => addItem({ id, name: 'å•†å“å', price: 1000 })}>
        ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
      </button>
    </div>
  );
}
```

**Next.jså›ºæœ‰ã®æ³¨æ„ç‚¹:**
- ã‚¹ãƒˆã‚¢ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯`'use client'`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ãŒå¿…è¦ã§ã™
- ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ã¯ç›´æ¥ä½¿ç”¨ã§ãã¾ã›ã‚“ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½¿ç”¨ï¼‰

---

## 4. Redux (Redux Toolkit)

> **ğŸ“š è©³ç´°**: Reduxã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[çŠ¶æ…‹ç®¡ç†](/nextjsã‚¬ã‚¤ãƒ‰/01_Next.jsåŸºç¤/05_çŠ¶æ…‹ç®¡ç†/01_çŠ¶æ…‹ç®¡ç†)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

Reduxã¯ã€å¤§è¦æ¨¡ã§è¤‡é›‘ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‘ã‘ã®çŠ¶æ…‹ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚Redux Toolkitã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒç°¡ç´ åŒ–ã•ã‚Œã¾ã™ã€‚

**ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:**
- **ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**: `npm install @reduxjs/toolkit react-redux`
- **ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®è¨­å®š**: å¿…è¦ï¼ˆNext.jsã®App Routerã§ã¯`app/providers.tsx`ã‚’ä½œæˆã—ã¦`Provider`ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ©ãƒƒãƒ—ï¼‰
- **TypeScript**: å‹å®šç¾©ãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹

### Next.jsã§ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

#### ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install @reduxjs/toolkit react-redux
# ã¾ãŸã¯
yarn add @reduxjs/toolkit react-redux
# ã¾ãŸã¯
pnpm add @reduxjs/toolkit react-redux
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: ã‚¹ãƒˆã‚¢ã®ä½œæˆ

```typescript
// store/store.ts
import { configureStore } from '@reduxjs/toolkit';
import cartReducer from './slices/cartSlice';
import userReducer from './slices/userSlice';

export const store = configureStore({
  reducer: {
    cart: cartReducer,
    user: userReducer,
  },
});

export type RootState = ReturnType<typeof store.getState>;
export type AppDispatch = typeof store.dispatch;
```

#### ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¹ãƒ©ã‚¤ã‚¹ã®ä½œæˆ

```typescript
// store/slices/cartSlice.ts
import { createSlice, PayloadAction } from '@reduxjs/toolkit';

interface CartItem {
  id: string;
  name: string;
  price: number;
  quantity: number;
}

interface CartState {
  items: CartItem[];
}

const initialState: CartState = {
  items: [],
};

const cartSlice = createSlice({
  name: 'cart',
  initialState,
  reducers: {
    addItem: (state, action: PayloadAction<Omit<CartItem, 'quantity'>>) => {
      const existingItem = state.items.find(
        (item) => item.id === action.payload.id
      );
      
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        state.items.push({ ...action.payload, quantity: 1 });
      }
    },
    removeItem: (state, action: PayloadAction<string>) => {
      state.items = state.items.filter((item) => item.id !== action.payload);
    },
    updateQuantity: (state, action: PayloadAction<{ id: string; quantity: number }>) => {
      const item = state.items.find((item) => item.id === action.payload.id);
      if (item) {
        if (action.payload.quantity <= 0) {
          state.items = state.items.filter((item) => item.id !== action.payload.id);
        } else {
          item.quantity = action.payload.quantity;
        }
      }
    },
    clearCart: (state) => {
      state.items = [];
    },
  },
});

export const { addItem, removeItem, updateQuantity, clearCart } = cartSlice.actions;
export default cartSlice.reducer;
```

#### ã‚¹ãƒ†ãƒƒãƒ—4: å‹å®‰å…¨ãªãƒ•ãƒƒã‚¯ã®ä½œæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€æ¨å¥¨ï¼‰

```typescript
// store/hooks.ts
import { useDispatch, useSelector, TypedUseSelectorHook } from 'react-redux';
import type { RootState, AppDispatch } from './store';

export const useAppDispatch = () => useDispatch<AppDispatch>();
export const useAppSelector: TypedUseSelectorHook<RootState> = useSelector;
```

#### ã‚¹ãƒ†ãƒƒãƒ—5: Next.js App Routerã§ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®è¨­å®š

```typescript
// app/providers.tsx
'use client';

import { Provider } from 'react-redux';
import { store } from '@/store/store';

export function Providers({ children }: { children: React.ReactNode }) {
  return <Provider store={store}>{children}</Provider>;
}

// app/layout.tsx
import { Providers } from './providers';

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <body>
        {/* Next.js App Routerã§ã¯ã€providers.tsxã§Providerã‚’é…ç½® */}
        <Providers>
          {children}
        </Providers>
      </body>
    </html>
  );
}
```

**Next.jså›ºæœ‰ã®æ³¨æ„ç‚¹:**
- `app/providers.tsx`ã‚’ä½œæˆã—ã€`'use client'`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’è¿½åŠ ã—ã¾ã™
- `app/layout.tsx`ã§`Providers`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™
- ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰ã¯ç›´æ¥ä½¿ç”¨ã§ãã¾ã›ã‚“ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½¿ç”¨ï¼‰

#### ã‚¹ãƒ†ãƒƒãƒ—6: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½¿ç”¨

```typescript
// components/Cart.tsx
'use client';

import { useAppSelector, useAppDispatch } from '@/store/hooks';
import { clearCart } from '@/store/slices/cartSlice';

export default function Cart() {
  const items = useAppSelector((state) => state.cart.items);
  const dispatch = useAppDispatch();

  const total = items.reduce(
    (sum, item) => sum + item.price * item.quantity,
    0
  );

  return (
    <div>
      <h2>ã‚«ãƒ¼ãƒˆ</h2>
      {items.length === 0 ? (
        <p>ã‚«ãƒ¼ãƒˆã¯ç©ºã§ã™</p>
      ) : (
        <>
          {items.map((item) => (
            <CartItem key={item.id} item={item} />
          ))}
          <p>åˆè¨ˆ: Â¥{total.toLocaleString()}</p>
          <button onClick={() => dispatch(clearCart())}>ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢</button>
        </>
      )}
    </div>
  );
}

// components/CartItem.tsx
'use client';

import { useAppDispatch } from '@/store/hooks';
import { updateQuantity, removeItem } from '@/store/slices/cartSlice';

export default function CartItem({ item }: { item: CartItem }) {
  const dispatch = useAppDispatch();

  return (
    <div>
      <span>{item.name}</span>
      <span>Â¥{item.price.toLocaleString()}</span>
      <input
        type="number"
        value={item.quantity}
        onChange={(e) =>
          dispatch(updateQuantity({ id: item.id, quantity: parseInt(e.target.value) }))
        }
        min="1"
      />
      <button onClick={() => dispatch(removeItem(item.id))}>å‰Šé™¤</button>
    </div>
  );
}
```

### å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹: å¤§è¦æ¨¡ECã‚µã‚¤ãƒˆã®çŠ¶æ…‹ç®¡ç†

**è¦ä»¶:**
- è¤‡æ•°ã®æ©Ÿèƒ½ï¼ˆã‚«ãƒ¼ãƒˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€å•†å“ãªã©ï¼‰ã®çŠ¶æ…‹ç®¡ç†
- ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒ™ãƒ«ãƒ‡ãƒãƒƒã‚°ãŒå¿…è¦
- å³æ ¼ãªçŠ¶æ…‹ç®¡ç†ãŒå¿…è¦
- è¤‡é›‘ãªçŠ¶æ…‹é·ç§»

**å®Ÿè£…:**

```typescript
// store/store.tsï¼ˆä¸Šè¨˜å‚ç…§ï¼‰

// store/slices/cartSlice.tsï¼ˆä¸Šè¨˜å‚ç…§ï¼‰

// store/slices/userSlice.ts
import { createSlice, PayloadAction } from '@reduxjs/toolkit';

interface User {
  id: string;
  name: string;
  email: string;
}

interface UserState {
  user: User | null;
  isAuthenticated: boolean;
}

const initialState: UserState = {
  user: null,
  isAuthenticated: false,
};

const userSlice = createSlice({
  name: 'user',
  initialState,
  reducers: {
    setUser: (state, action: PayloadAction<User>) => {
      state.user = action.payload;
      state.isAuthenticated = true;
    },
    logout: (state) => {
      state.user = null;
      state.isAuthenticated = false;
    },
  },
});

export const { setUser, logout } = userSlice.actions;
export default userSlice.reducer;

// app/providers.tsxï¼ˆä¸Šè¨˜å‚ç…§ï¼‰

// ä½¿ç”¨ä¾‹
// components/Header.tsx
'use client';

import { useAppSelector, useAppDispatch } from '@/store/hooks';
import { logout } from '@/store/slices/userSlice';

export default function Header() {
  const user = useAppSelector((state) => state.user.user);
  const dispatch = useAppDispatch();

  return (
    <header>
      {user ? (
        <div>
          <span>{user.name}</span>
          <button onClick={() => dispatch(logout())}>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      ) : (
        <a href="/login">ãƒ­ã‚°ã‚¤ãƒ³</a>
      )}
    </header>
  );
}
```

**æ³¨æ„ç‚¹:**
- Redux Toolkitã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒœã‚¤ãƒ©ãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆãŒå¤§å¹…ã«å‰Šæ¸›ã•ã‚Œã‚‹
- `Provider`ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- å‹å®‰å…¨ãªãƒ•ãƒƒã‚¯ï¼ˆ`useAppDispatch`ã€`useAppSelector`ï¼‰ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€TypeScriptã®å‹æ¨è«–ãŒåŠ¹ã

---

## 5. TanStack Query (React Query)

> **ğŸ“š è©³ç´°**: TanStack Queryã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[çŠ¶æ…‹ç®¡ç†](/nextjsã‚¬ã‚¤ãƒ‰/01_Next.jsåŸºç¤/05_çŠ¶æ…‹ç®¡ç†/01_çŠ¶æ…‹ç®¡ç†)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

TanStack Queryï¼ˆæ—§React Queryï¼‰ã¯ã€ã‚µãƒ¼ãƒãƒ¼çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãƒ³ã‚°ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€åŒæœŸãªã©ã®æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

**ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:**
- **ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**: `npm install @tanstack/react-query`
- **ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®è¨­å®š**: å¿…è¦ï¼ˆNext.jsã®App Routerã§ã¯`app/providers.tsx`ã§`QueryClientProvider`ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ©ãƒƒãƒ—ï¼‰
- **TypeScript**: å‹å®šç¾©ãŒçµ„ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹

### Next.jsã§ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

#### ã‚¹ãƒ†ãƒƒãƒ—1: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install @tanstack/react-query
# ã¾ãŸã¯
yarn add @tanstack/react-query
# ã¾ãŸã¯
pnpm add @tanstack/react-query
```

#### ã‚¹ãƒ†ãƒƒãƒ—2: Next.js App Routerã§ã®QueryClientã®ä½œæˆã¨ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®è¨­å®š

```typescript
// app/providers.tsx
'use client';

import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';
import { useState } from 'react';

export function Providers({ children }: { children: React.ReactNode }) {
  // Next.js App Routerã§ã¯ã€QueryClientã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹
  const [queryClient] = useState(
    () =>
      new QueryClient({
        defaultOptions: {
          queries: {
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®è¨­å®š
            staleTime: 60 * 1000, // 1åˆ†é–“ã¯æ–°é®®ã¨ã¿ãªã™
            gcTime: 5 * 60 * 1000, // 5åˆ†é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿æŒï¼ˆæ—§cacheTimeï¼‰
            refetchOnWindowFocus: false, // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã«å†å–å¾—ã—ãªã„
            retry: 1, // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒªãƒˆãƒ©ã‚¤å›æ•°
          },
        },
      })
  );

  return (
    <QueryClientProvider client={queryClient}>
      {children}
      {/* é–‹ç™ºç’°å¢ƒã§ã®ã¿DevToolsã‚’è¡¨ç¤º */}
      {process.env.NODE_ENV === 'development' && <ReactQueryDevtools />}
    </QueryClientProvider>
  );
}

// app/layout.tsx
import { Providers } from './providers';

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="ja">
      <body>
        {/* Next.js App Routerã§ã¯ã€providers.tsxã§QueryClientProviderã‚’é…ç½® */}
        <Providers>
          {children}
        </Providers>
      </body>
    </html>
  );
}
```

**ã‚ªãƒ—ã‚·ãƒ§ãƒ³: React Query DevToolsã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**

```bash
npm install @tanstack/react-query-devtools
# ã¾ãŸã¯
yarn add @tanstack/react-query-devtools
# ã¾ãŸã¯
pnpm add @tanstack/react-query-devtools
```

**Next.jså›ºæœ‰ã®æ³¨æ„ç‚¹:**
- `app/providers.tsx`ã‚’ä½œæˆã—ã€`'use client'`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’è¿½åŠ ã—ã¾ã™
- Next.js App Routerã§ã¯ã€`QueryClient`ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã¯å®Ÿè¡Œã§ããªã„ãŸã‚ï¼‰
- `app/layout.tsx`ã§`Providers`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™

#### ã‚¹ãƒ†ãƒƒãƒ—3: ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã®ä½œæˆï¼ˆæ¨å¥¨ï¼‰

```typescript
// hooks/useUsers.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';

interface User {
  id: string;
  name: string;
  email: string;
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
export function useUsers() {
  return useQuery({
    queryKey: ['users'],
    queryFn: async () => {
      const response = await fetch('/api/users');
      if (!response.ok) {
        throw new Error('Failed to fetch users');
      }
      return response.json() as Promise<User[]>;
    },
  });
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
export function useUser(userId: string) {
  return useQuery({
    queryKey: ['user', userId],
    queryFn: async () => {
      const response = await fetch(`/api/users/${userId}`);
      if (!response.ok) {
        throw new Error('Failed to fetch user');
      }
      return response.json() as Promise<User>;
    },
    enabled: !!userId, // userIdãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
  });
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
export function useCreateUser() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (data: Omit<User, 'id'>) => {
      const response = await fetch('/api/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      if (!response.ok) {
        throw new Error('Failed to create user');
      }
      return response.json() as Promise<User>;
    },
    onSuccess: () => {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å†å–å¾—
      queryClient.invalidateQueries({ queryKey: ['users'] });
    },
  });
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ›´æ–°ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯
export function useUpdateUser() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ id, ...data }: Partial<User> & { id: string }) => {
      const response = await fetch(`/api/users/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      if (!response.ok) {
        throw new Error('Failed to update user');
      }
      return response.json() as Promise<User>;
    },
    onSuccess: (data) => {
      // æ›´æ–°å¾Œã€è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å†å–å¾—
      queryClient.invalidateQueries({ queryKey: ['user', data.id] });
      queryClient.invalidateQueries({ queryKey: ['users'] });
    },
  });
}
```

#### ã‚¹ãƒ†ãƒƒãƒ—4: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½¿ç”¨

```typescript
// app/users/page.tsx
'use client';

import { useUsers, useCreateUser } from '@/hooks/useUsers';

export default function UsersPage() {
  const { data: users, isLoading, error } = useUsers();
  const createUser = useCreateUser();

  const handleCreate = async () => {
    try {
      await createUser.mutateAsync({
        name: 'æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼',
        email: 'newuser@example.com',
      });
    } catch (error) {
      console.error('Failed to create user:', error);
    }
  };

  if (isLoading) return <div>èª­ã¿è¾¼ã¿ä¸­...</div>;
  if (error) return <div>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>;

  return (
    <div>
      <h1>ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h1>
      <button onClick={handleCreate} disabled={createUser.isPending}>
        {createUser.isPending ? 'ä½œæˆä¸­...' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ'}
      </button>
      <ul>
        {users?.map((user) => (
          <li key={user.id}>
            <a href={`/users/${user.id}`}>{user.name}</a>
          </li>
        ))}
      </ul>
    </div>
  );
}

// app/users/[id]/page.tsx
'use client';

import { useUser, useUpdateUser } from '@/hooks/useUsers';
import { useParams } from 'next/navigation';

export default function UserDetailPage() {
  const params = useParams();
  const userId = params.id as string;
  const { data: user, isLoading, error } = useUser(userId);
  const updateUser = useUpdateUser();

  const handleUpdate = async () => {
    if (!user) return;
    
    try {
      await updateUser.mutateAsync({
        id: user.id,
        name: 'æ›´æ–°ã•ã‚ŒãŸåå‰',
      });
    } catch (error) {
      console.error('Failed to update user:', error);
    }
  };

  if (isLoading) return <div>èª­ã¿è¾¼ã¿ä¸­...</div>;
  if (error) return <div>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>;
  if (!user) return <div>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>;

  return (
    <div>
      <h1>{user.name}</h1>
      <p>Email: {user.email}</p>
      <button onClick={handleUpdate} disabled={updateUser.isPending}>
        {updateUser.isPending ? 'æ›´æ–°ä¸­...' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ›´æ–°'}
      </button>
    </div>
  );
}
```

### å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹: ãƒ–ãƒ­ã‚°ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚§ãƒƒãƒãƒ³ã‚°

**è¦ä»¶:**
- ãƒ–ãƒ­ã‚°è¨˜äº‹ã®ä¸€è¦§ã¨è©³ç´°ã®å–å¾—
- è¨˜äº‹ã®ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ç®¡ç†
- ã‚ªãƒ—ãƒ†ã‚£ãƒŸã‚¹ãƒ†ã‚£ãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ

**å®Ÿè£…:**

```typescript
// hooks/usePosts.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';

interface Post {
  id: string;
  title: string;
  content: string;
  author: string;
  createdAt: string;
}

export function usePosts() {
  return useQuery({
    queryKey: ['posts'],
    queryFn: async () => {
      const response = await fetch('/api/posts');
      if (!response.ok) throw new Error('Failed to fetch posts');
      return response.json() as Promise<Post[]>;
    },
  });
}

export function usePost(postId: string) {
  return useQuery({
    queryKey: ['post', postId],
    queryFn: async () => {
      const response = await fetch(`/api/posts/${postId}`);
      if (!response.ok) throw new Error('Failed to fetch post');
      return response.json() as Promise<Post>;
    },
    enabled: !!postId,
  });
}

export function useCreatePost() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (data: Omit<Post, 'id' | 'createdAt'>) => {
      const response = await fetch('/api/posts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      if (!response.ok) throw new Error('Failed to create post');
      return response.json() as Promise<Post>;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['posts'] });
    },
  });
}

export function useUpdatePost() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ id, ...data }: Partial<Post> & { id: string }) => {
      const response = await fetch(`/api/posts/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      if (!response.ok) throw new Error('Failed to update post');
      return response.json() as Promise<Post>;
    },
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ['post', data.id] });
      queryClient.invalidateQueries({ queryKey: ['posts'] });
    },
  });
}

// app/providers.tsxï¼ˆä¸Šè¨˜å‚ç…§ï¼‰

// app/posts/page.tsxï¼ˆä½¿ç”¨ä¾‹ï¼‰
'use client';

import { usePosts, useCreatePost } from '@/hooks/usePosts';

export default function PostsPage() {
  const { data: posts, isLoading } = usePosts();
  const createPost = useCreatePost();

  // ... å®Ÿè£…
}
```

**æ³¨æ„ç‚¹:**
- `QueryClientProvider`ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- App Routerã§ã¯ã€`QueryClient`ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå†…ã§ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- é–‹ç™ºç’°å¢ƒã§ã¯`ReactQueryDevtools`ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒãƒƒã‚°ãŒå®¹æ˜“ã«ãªã‚‹
- ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’ä½œæˆã™ã‚‹ã“ã¨ã§ã€ã‚³ãƒ¼ãƒ‰ã®å†åˆ©ç”¨æ€§ãŒå‘ä¸Šã™ã‚‹

---

## 6. Cookieæˆ¦ç•¥

Cookieã¯ã€ã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–“ã§çŠ¶æ…‹ã‚’å…±æœ‰ã™ã‚‹ãŸã‚ã®é‡è¦ãªä»•çµ„ã¿ã§ã™ã€‚èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šãªã©ã‚’ä¿å­˜ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚

> **ğŸ“š è©³ç´°**: Cookieã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[Cookieæˆ¦ç•¥](/nextjsã‚¬ã‚¤ãƒ‰/03_ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹/01_ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°/05_cookie)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Cookieã®çŠ¶æ…‹ç®¡ç†ã¨ã—ã¦ã®ä½ç½®ã¥ã‘

Cookieã¯ã€ä»¥ä¸‹ã®ç‰¹å¾´ã‹ã‚‰çŠ¶æ…‹ç®¡ç†ã®ä¸€ç¨®ã¨ã—ã¦æ‰±ãˆã¾ã™ï¼š

- **æ°¸ç¶šåŒ–**: ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã€ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰å¾Œã‚‚ä¿æŒã•ã‚Œã‚‹
- **ã‚µãƒ¼ãƒãƒ¼ãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–“ã®å…±æœ‰**: ã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä¸¡æ–¹ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
- **è‡ªå‹•é€ä¿¡**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«è‡ªå‹•çš„ã«é€ä¿¡ã•ã‚Œã‚‹

### Next.js App Routerã§ã®Cookieæ“ä½œ

#### 1. ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®Cookieèª­ã¿å–ã‚Š

```typescript
// app/dashboard/page.tsx
import { cookies } from 'next/headers';

export default async function DashboardPage() {
  const cookieStore = cookies();
  const token = cookieStore.get('auth_token')?.value;

  if (!token) {
    // èªè¨¼ã•ã‚Œã¦ã„ãªã„å ´åˆã®å‡¦ç†
    return <div>ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</div>;
  }

  // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ç”¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  // ...

  return (
    <div>
      <h1>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      {/* èªè¨¼æƒ…å ±ã«åŸºã¥ãã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
    </div>
  );
}
```

**æ³¨æ„ç‚¹:**
- `cookies()`é–¢æ•°ã¯å‹•çš„ï¼ˆdynamicï¼‰ãªé–¢æ•°ã§ã‚ã‚‹ãŸã‚ã€ã“ã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ãƒ“ãƒ«ãƒ‰æ™‚ã«é™çš„ã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¾ã›ã‚“
- ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™

#### 2. Route Handlerã§ã®Cookieæ“ä½œ

Route Handlerã§ã¯ã€Cookieã®èª­ã¿å–ã‚Šã¨è¨­å®šã®ä¸¡æ–¹ãŒå¯èƒ½ã§ã™ã€‚

```typescript
// app/api/login/route.ts
import { cookies } from 'next/headers';
import { NextResponse } from 'next/server';

export async function POST(req: Request) {
  const { username, password } = await req.json();
  
  // èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œ
  const token = 'generated_auth_token_123';

  // Cookieã‚’è¨­å®š
  cookies().set('auth_token', token, {
    httpOnly: true, // JavaScriptã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¦æ­¢ï¼ˆXSSå¯¾ç­–ï¼‰
    secure: process.env.NODE_ENV === 'production', // HTTPSæ¥ç¶šã§ã®ã¿é€ä¿¡
    maxAge: 60 * 60 * 24 * 7, // 1é€±é–“
    path: '/',
    sameSite: 'strict', // CSRFå¯¾ç­–
  });

  return NextResponse.json({ message: 'Login successful' });
}

// app/api/logout/route.ts
import { cookies } from 'next/headers';
import { NextResponse } from 'next/server';

export async function POST() {
  // Cookieã‚’å‰Šé™¤
  cookies().delete('auth_token');

  return NextResponse.json({ message: 'Logout successful' });
}
```

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã®èª¬æ˜:**
- **`httpOnly: true`**: JavaScriptã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¦æ­¢ã—ã€XSSæ”»æ’ƒã®ãƒªã‚¹ã‚¯ã‚’è»½æ¸›ã—ã¾ã™ã€‚èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã«ã¯å¿…é ˆã§ã™
- **`secure: true`**: HTTPSæ¥ç¶šã§ã®ã¿Cookieã‚’é€ä¿¡ã—ã¾ã™ã€‚æœ¬ç•ªç’°å¢ƒã§ã¯å¿…ãš`true`ã«è¨­å®šã™ã¹ãã§ã™
- **`sameSite: 'strict'`**: ã‚¯ãƒ­ã‚¹ã‚µã‚¤ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã®Cookieé€ä¿¡ã‚’é˜²ãã€CSRFæ”»æ’ƒã®ãƒªã‚¹ã‚¯ã‚’è»½æ¸›ã—ã¾ã™
- **`maxAge`**: Cookieã®æœ‰åŠ¹æœŸé™ã‚’ç§’å˜ä½ã§æŒ‡å®šã—ã¾ã™

#### 3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã®Cookieæ“ä½œ

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã¯ã€`js-cookie`ãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦Cookieã‚’æ“ä½œã—ã¾ã™ã€‚

**ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«:**

```bash
npm install js-cookie
npm install --save-dev @types/js-cookie
```

**ä½¿ç”¨ä¾‹:**

```typescript
// components/ThemeToggle.tsx
'use client';

import Cookies from 'js-cookie';
import { useState, useEffect } from 'react';

type Theme = 'light' | 'dark';

export default function ThemeToggle() {
  const [theme, setTheme] = useState<Theme>('light');

  useEffect(() => {
    // Cookieã‹ã‚‰ãƒ†ãƒ¼ãƒã‚’èª­ã¿å–ã‚Š
    const savedTheme = Cookies.get('theme') as Theme | undefined;
    if (savedTheme) {
      setTheme(savedTheme);
    }
  }, []);

  const toggleTheme = () => {
    const newTheme: Theme = theme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
    
    // Cookieã«ãƒ†ãƒ¼ãƒã‚’ä¿å­˜
    Cookies.set('theme', newTheme, {
      expires: 365, // 1å¹´é–“æœ‰åŠ¹
      path: '/',
      sameSite: 'lax',
    });
  };

  return (
    <button onClick={toggleTheme}>
      ãƒ†ãƒ¼ãƒ: {theme === 'light' ? 'ğŸŒ' : 'ğŸŒ™'}
    </button>
  );
}
```

**æ³¨æ„ç‚¹:**
- ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‹ã‚‰Cookieã‚’ç›´æ¥æ“ä½œã™ã‚‹ã®ã¯ã€èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚ˆã†ãªæ©Ÿå¯†æƒ…å ±ã«ã¯é©ã—ã¦ã„ã¾ã›ã‚“
- éæ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ãƒ¼ãƒè¨­å®šã€è¨€èªè¨­å®šãªã©ï¼‰ã«é™å®šã™ã¹ãã§ã™
- èªè¨¼ãŒå¿…è¦ãªå ´åˆã¯ã€`fetch`ã‚’ä½¿ã£ã¦APIãƒ«ãƒ¼ãƒˆã‚’å‘¼ã³å‡ºã—ã€Cookieã®æ“ä½œã¯ã‚µãƒ¼ãƒãƒ¼ã«ä»»ã›ã¾ã™

### Cookieã¨ä»–ã®çŠ¶æ…‹ç®¡ç†æ‰‹æ³•ã¨ã®ä½¿ã„åˆ†ã‘

| çŠ¶æ…‹ã®ç¨®é¡ | æ¨å¥¨ã•ã‚Œã‚‹æ–¹æ³• | ç†ç”± |
|-----------|--------------|------|
| **èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³** | Cookieï¼ˆHttpOnlyï¼‰ | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒæœ€é‡è¦ã€‚ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç®¡ç† |
| **ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±** | Cookieï¼ˆHttpOnlyï¼‰ | ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ |
| **ãƒ†ãƒ¼ãƒè¨­å®š** | Cookie + Context API | æ°¸ç¶šåŒ–ãŒå¿…è¦ã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ |
| **è¨€èªè¨­å®š** | Cookie + Context API | æ°¸ç¶šåŒ–ãŒå¿…è¦ã§ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ |
| **ã‚«ãƒ¼ãƒˆæƒ…å ±** | Zustand + Cookie | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§é »ç¹ã«æ›´æ–°ã—ã€æ°¸ç¶šåŒ–ã‚‚å¿…è¦ |
| **UIçŠ¶æ…‹ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«é–‹é–‰ãªã©ï¼‰** | useState / Zustand | æ°¸ç¶šåŒ–ä¸è¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã¿ã§ç®¡ç† |

### å®Ÿè·µçš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³: èªè¨¼çŠ¶æ…‹ã®ç®¡ç†

```typescript
// app/api/auth/me/route.ts
import { cookies } from 'next/headers';
import { NextResponse } from 'next/server';

export async function GET() {
  const cookieStore = cookies();
  const token = cookieStore.get('auth_token')?.value;

  if (!token) {
    return NextResponse.json({ user: null }, { status: 401 });
  }

  // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  // const user = await verifyToken(token);
  
  return NextResponse.json({ user: { id: '1', name: 'User' } });
}

// app/dashboard/page.tsx
import { cookies } from 'next/headers';
import { redirect } from 'next/navigation';

export default async function DashboardPage() {
  const cookieStore = cookies();
  const token = cookieStore.get('auth_token')?.value;

  if (!token) {
    redirect('/login');
  }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
  const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL}/api/auth/me`, {
    headers: {
      Cookie: `auth_token=${token}`,
    },
  });

  const { user } = await response.json();

  return (
    <div>
      <h1>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
      <p>ã‚ˆã†ã“ãã€{user.name}ã•ã‚“</p>
    </div>
  );
}
```

### ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

1. **æ©Ÿå¯†æƒ…å ±ã¯HttpOnly Cookieã«**: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãªã©ã¯å¿…ãš`httpOnly: true`ã‚’è¨­å®š
2. **æœ¬ç•ªç’°å¢ƒã§ã¯Secureã‚’æœ‰åŠ¹åŒ–**: `secure: process.env.NODE_ENV === 'production'`
3. **SameSiteå±æ€§ã‚’é©åˆ‡ã«è¨­å®š**: CSRFå¯¾ç­–ã®ãŸã‚ã€`sameSite: 'strict'`ã¾ãŸã¯`'lax'`ã‚’è¨­å®š
4. **ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã®Cookieæ“ä½œã¯éæ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã«é™å®š**: ãƒ†ãƒ¼ãƒã‚„è¨€èªè¨­å®šãªã©
5. **Cookieã®ã‚µã‚¤ã‚ºã«æ³¨æ„**: Cookieã¯4KBã®åˆ¶é™ãŒã‚ã‚‹ãŸã‚ã€å¤§ããªãƒ‡ãƒ¼ã‚¿ã¯é¿ã‘ã‚‹

### ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³

```typescript
// âŒ æ‚ªã„ä¾‹: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§Cookieã«ä¿å­˜
'use client';

import Cookies from 'js-cookie';

function LoginForm() {
  const handleLogin = async (token: string) => {
    // å•é¡Œ: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§Cookieã«ä¿å­˜
    Cookies.set('auth_token', token); // XSSæ”»æ’ƒã®ãƒªã‚¹ã‚¯
  };
}

// âœ… è‰¯ã„ä¾‹: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã¯ã‚µãƒ¼ãƒãƒ¼ã§Cookieã«ä¿å­˜
// app/api/login/route.ts
import { cookies } from 'next/headers';

export async function POST(req: Request) {
  const token = 'generated_token';
  
  cookies().set('auth_token', token, {
    httpOnly: true, // ã‚»ã‚­ãƒ¥ã‚¢
    secure: true,
    sameSite: 'strict',
  });
}
```

---

## ã¾ã¨ã‚ï¼šã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®é¸å®šåŸºæº–

çŠ¶æ…‹ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®é¸æŠã«è¿·ã£ãŸã‚‰ã€ä»¥ä¸‹ã®**ã€Œã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®é¸å®šåŸºæº–ã€**ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚

### ğŸ’¡ ã¾ã•ã‹ã‚Šï¼šè¿·ã£ãŸã‚‰ã€ã¾ãšã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å…¥ã‚Œã‚‹ãª

**ã‚¹ãƒ†ãƒƒãƒ—1: ã¾ãšã¯`useState`ã§é ‘å¼µã‚‹**

ãƒã‚±ãƒ„ãƒªãƒ¬ãƒ¼ï¼ˆProps Drillingï¼‰ãŒ2å±¤ã¾ã§ãªã‚‰ã€`useState`ã§ååˆ†ã§ã™ã€‚ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å°å…¥ã™ã‚‹å‰ã«ã€ã¾ãšã¯çµ„ã¿è¾¼ã¿ã®æ©Ÿèƒ½ã§è§£æ±ºã§ããªã„ã‹æ¤œè¨ã—ã¾ã—ã‚‡ã†ã€‚

```typescript
// âœ… è‰¯ã„ä¾‹: 2å±¤ã®Props Drillingãªã‚‰å•é¡Œãªã„
function App() {
  const [user, setUser] = useState(null);
  return <Layout user={user} setUser={setUser} />;
}

function Layout({ user, setUser }: { user: User | null; setUser: (user: User) => void }) {
  return <Header user={user} setUser={setUser} />;
}

function Header({ user, setUser }: { user: User | null; setUser: (user: User) => void }) {
  return <UserMenu user={user} setUser={setUser} />;
}
```

**ã‚¹ãƒ†ãƒƒãƒ—2: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ãªã‚‰ã€è¿·ã‚ãšTanStack Queryã‚’å…¥ã‚Œã‚‹**

ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒå¿…è¦ãªå ´åˆã€TanStack Queryï¼ˆã¾ãŸã¯SWRï¼‰ã‚’å°å…¥ã—ã¾ã—ã‚‡ã†ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€å†å–å¾—ã€åŒæœŸãªã©ã®æ©Ÿèƒ½ãŒè‡ªå‹•çš„ã«æä¾›ã•ã‚Œã¾ã™ã€‚

```typescript
// âœ… è‰¯ã„ä¾‹: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«ã¯TanStack Query
import { useQuery } from '@tanstack/react-query';

function UserProfile({ userId }: { userId: string }) {
  const { data: user } = useQuery({
    queryKey: ['user', userId],
    queryFn: () => fetchUser(userId),
  });
  
  return <div>{user?.name}</div>;
}
```

**ã‚¹ãƒ†ãƒƒãƒ—3: ãã‚Œã§ã‚‚ã€Œã©ã†ã—ã¦ã‚‚è¤‡æ•°ã®ç”»é¢ã§å…±æœ‰ã—ãŸã„UIçŠ¶æ…‹ï¼ˆã‚«ãƒ¼ãƒˆã®ä¸­èº«ãªã©ï¼‰ã€ãŒå‡ºã¦ããŸã‚‰ã€ãã“ã§åˆã‚ã¦Zustandã‚’å°å…¥ã™ã‚‹**

è¤‡æ•°ã®ç”»é¢ã§å…±æœ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹UIçŠ¶æ…‹ï¼ˆã‚«ãƒ¼ãƒˆã®ä¸­èº«ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‹é–‰çŠ¶æ…‹ãªã©ï¼‰ãŒã‚ã‚‹å ´åˆã€Zustandãªã©ã®çŠ¶æ…‹ç®¡ç†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å°å…¥ã—ã¾ã—ã‚‡ã†ã€‚

```typescript
// âœ… è‰¯ã„ä¾‹: è¤‡æ•°ç”»é¢ã§å…±æœ‰ã™ã‚‹UIçŠ¶æ…‹ã«ã¯Zustand
import { create } from 'zustand';

interface CartStore {
  items: CartItem[];
  addItem: (item: CartItem) => void;
  removeItem: (itemId: string) => void;
}

const useCartStore = create<CartStore>((set) => ({
  items: [],
  addItem: (item) => set((state) => ({ 
    items: [...state.items, item] 
  })),
  removeItem: (itemId) => set((state) => ({
    items: state.items.filter(item => item.id !== itemId)
  })),
}));
```

### é‡è¦ãªæ³¨æ„ç‚¹

**ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å¢—ã‚„ã™ = ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºãŒå¢—ãˆã€å­¦ç¿’ã‚³ã‚¹ãƒˆãŒä¸ŠãŒã‚‹ã“ã¨ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã—ã¾ã—ã‚‡ã†ã€‚**

- ä¸è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å°å…¥ã™ã‚‹ã¨ã€ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºãŒå¢—åŠ ã—ã¾ã™
- ãƒãƒ¼ãƒ ãƒ¡ãƒ³ãƒãƒ¼ãŒæ–°ã—ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å­¦ç¿’ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
- ä¿å®ˆã‚³ã‚¹ãƒˆãŒå¢—åŠ ã—ã¾ã™

### é¸å®šãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ

```
çŠ¶æ…‹ç®¡ç†ã®é¸å®š
â”‚
â”œâ”€ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼Ÿ
â”‚  â””â”€ YES â†’ TanStack Queryï¼ˆã¾ãŸã¯SWRï¼‰
â”‚
â”œâ”€ è¤‡æ•°ã®ç”»é¢ã§å…±æœ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼Ÿ
â”‚  â”œâ”€ YES â†’ Zustandï¼ˆã¾ãŸã¯Context APIï¼‰
â”‚  â””â”€ NO â†’ useState
â”‚
â””â”€ Props DrillingãŒ3å±¤ä»¥ä¸Šï¼Ÿ
   â””â”€ YES â†’ Context APIï¼ˆã¾ãŸã¯Zustandï¼‰
```

### æœ€çµ‚çš„ãªæ¨å¥¨äº‹é …

1. **Local Stateï¼ˆ`useState`ï¼‰**: ã¾ãšã¯ã“ã‚Œã§é ‘å¼µã‚‹
2. **Server Stateï¼ˆTanStack Queryï¼‰**: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«ã¯å¿…é ˆ
3. **Context API**: ã‚ã£ãŸã«å¤‰ã‚ã‚‰ãªã„é™çš„ãªå…±æœ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆèªè¨¼ã€ãƒ†ãƒ¼ãƒãªã©ï¼‰
4. **Zustand**: è¤‡æ•°ã®ç”»é¢ã§å…±æœ‰ã™ã‚‹UIçŠ¶æ…‹ï¼ˆã‚«ãƒ¼ãƒˆã€ãƒ¢ãƒ¼ãƒ€ãƒ«ãªã©ï¼‰
5. **Cookie**: èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã€æ°¸ç¶šåŒ–ãŒå¿…è¦ãªè¨­å®šï¼ˆãƒ†ãƒ¼ãƒã€è¨€èªãªã©ï¼‰

ã“ã‚Œã‚‰ã®æ–¹æ³•ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§ã®çŠ¶æ…‹ç®¡ç†ãŒåŠ¹ç‡çš„ã«è¡Œãˆã¾ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¦æ¨¡ã‚„è¦ä»¶ã«å¿œã˜ã¦ã€æœ€é©ãªæ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚

**çŠ¶æ…‹ç®¡ç†ã®é¸å®šãƒ•ãƒ­ãƒ¼ï¼ˆæ›´æ–°ç‰ˆï¼‰:**

```
çŠ¶æ…‹ç®¡ç†ã®é¸å®š
â”‚
â”œâ”€ èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ï¼Ÿ
â”‚  â””â”€ YES â†’ Cookieï¼ˆHttpOnlyã€ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç®¡ç†ï¼‰
â”‚
â”œâ”€ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼Ÿ
â”‚  â””â”€ YES â†’ TanStack Queryï¼ˆã¾ãŸã¯SWRï¼‰
â”‚
â”œâ”€ è¤‡æ•°ã®ç”»é¢ã§å…±æœ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼Ÿ
â”‚  â”œâ”€ YES â†’ Zustandï¼ˆã¾ãŸã¯Context APIï¼‰
â”‚  â””â”€ NO â†’ useState
â”‚
â””â”€ Props DrillingãŒ3å±¤ä»¥ä¸Šï¼Ÿ
   â””â”€ YES â†’ Context APIï¼ˆã¾ãŸã¯Zustandï¼‰
```
