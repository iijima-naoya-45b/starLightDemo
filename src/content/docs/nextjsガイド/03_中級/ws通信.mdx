---
title: "ws利用法"
label: "ws利用法"
---

## 🌐 WebSocket（WS）通信の概要

WebSocket（WS）通信は、クライアントとサーバー間で永続的な接続を確立し、双方向かつリアルタイムのデータ交換を可能にする技術です。これは、リアルタイムチャットや通知システム、オンラインゲームなどのアプリケーションに不可欠です。

### 1. Next.jsにおけるWebSocket通信

Next.jsは主にサーバーレス関数としてデプロイされるため、長期間の接続を維持するWebSocketサーバーを直接ホストするのには向いていません。代わりに、外部のWebSocketサーバーやサービスと連携するのが一般的です。

- **外部WebSocketサービスの利用**
  - Vercelのようなサーバーレスプラットフォームにデプロイする場合、PusherやAblyといったマネージドサービスを利用するのが最も現実的です。

- **仕組み**:
  - Next.jsのAPIルート（Route Handler）で、サービスの認証トークンを取得します。
  - クライアントサイドのコンポーネントで、取得したトークンを使ってサービスに接続します。
  - メッセージの送受信はすべてサービスを介して行われ、Next.jsサーバーは関与しません。

### 2. RailsにおけるWebSocket通信

Railsでは、Action Cableというフレームワークが組み込まれており、WebSocket通信を簡単に実装できます。

- **仕組み**:
  - **チャネル（Channel）の作成**: `bin/rails generate channel <channel_name>`コマンドで、サーバーサイドのロジックを管理するチャネルを生成します。
  - **ストリーム（Stream）への登録**: クライアントがチャネルに接続すると、特定のストリームに登録され、そのストリームにブロードキャストされたメッセージを受け取ります。
  - **メッセージのブロードキャスト**: サーバーサイドのどこからでも、`ActionCable.server.broadcast`を使って、特定のストリームに接続している全クライアントにメッセージを送ることができます。

- **Next.jsとの連携**:
  - **フロントエンド**: Next.jsのコンポーネントで、JavaScriptのActionCableクライアントライブラリを使用してRailsのWebSocketサーバーに接続します。
  - **バックエンド**: Railsのチャネルでメッセージを処理し、リアルタイムでNext.jsのクライアントにブロードキャストします。

### 3. PhoenixにおけるWebSocket通信

Phoenixは、Elixirで構築されたWebフレームワークで、**「Channel」**という独自のWebSocket実装をコア機能として持っています。PhoenixのWebSocketは、その優れたスケーラビリティと耐障害性で知られています。

- **仕組み**:
  - **チャネル（Channel）の定義**: Phoenixのチャネルは、Railsのチャネルと同様に、リアルタイムなロジックをカプセル化します。
  - **トピック（Topic）への参加**: クライアントは、特定のトピック（例: "room:lobby"）に参加することで、そのトピックにブロードキャストされるメッセージを購読します。
  - **メッセージのプッシュ**: サーバーサイドのチャネルは、`push`メソッドを使ってトピックにメッセージをプッシュし、接続中のクライアントすべてに配信されます。

- **Next.jsとの連携**:
  - **フロントエンド**: JavaScriptクライアントライブラリの`phoenix.js`をNext.jsプロジェクトにインストールし、Phoenixサーバーに接続します。
  - **バックエンド**: Phoenixチャネルでメッセージを処理し、Next.jsのクライアントに効率的にブロードキャストします。

### まとめ

| フレームワーク | 特徴 | 連携方法 |
|----------------|------|----------|
| Next.js        | サーバーレス向き。直接ホスティングは困難。 | 外部WebSocketサービス（Pusher, Ablyなど）を利用。 |
| Rails          | Action Cableが組み込み。WebSocketサーバーを簡単に立ち上げ可能。 | Next.jsからAction Cableクライアント経由で接続。 |
| Phoenix        | Channelがコア機能。極めて高いスケーラビリティが魅力。 | Next.jsから`phoenix.js`ライブラリ経由で接続。 |

Next.js単体ではWebSocketサーバーをホスティングするのに限界があるため、RailsやPhoenixのようなフルスタックなバックエンドと連携することで、リアルタイムな機能を堅牢に実装できます。