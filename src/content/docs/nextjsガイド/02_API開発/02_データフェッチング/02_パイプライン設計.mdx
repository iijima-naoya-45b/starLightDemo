---
title: "ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ"
label: "ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ"
---

## ğŸ”„ ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆï¼šãƒ‡ãƒ¼ã‚¿ã®å‹ç®¡ç†ã¨ç”»é¢æ¥ç¶šã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[è¨­è¨ˆã‚¬ã‚¤ãƒ‰ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ](../../../../../è¨­è¨ˆã‚¬ã‚¤ãƒ‰/02_apiè¨­è¨ˆ/04_ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€Next.jsï¼ˆApp Routerï¼‰ç‰¹æœ‰ã®å®Ÿè£…ä¾‹ã‚’ä¸­å¿ƒã«èª¬æ˜ã—ã¾ã™ã€‚

### Next.jsã§ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆã®å®Ÿè£…

Next.jsã§ã¯ã€Server Componentsã¨Server Actionsã‚’æ´»ç”¨ã—ã¦ã€ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆã‚’å®Ÿè£…ã§ãã¾ã™ã€‚

---

## Next.jsã§ã®å®Ÿè£…ä¾‹

### Schemaå±¤ã€DTOå±¤ã€Formå±¤ã®å®Ÿè£…

å„å±¤ã®è©³ç´°ãªå®Ÿè£…ã«ã¤ã„ã¦ã¯ã€[è¨­è¨ˆã‚¬ã‚¤ãƒ‰ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ](../../../../../è¨­è¨ˆã‚¬ã‚¤ãƒ‰/02_apiè¨­è¨ˆ/04_ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Pageå±¤: å¸ä»¤å¡”ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€Formã¸é…åˆ†

**å½¹å‰²**: ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆPageï¼‰ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€é©åˆ‡ãªå±¤ã‚’çµŒç”±ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«æ¸¡ã™ã€‚

### å®Ÿè£…ä¾‹ï¼ˆApp Routerï¼‰

```typescript
// app/users/[id]/edit/page.tsx
import { fetchUser } from '@/api/schema/userSchema';
import { userApiToDto } from '@/types/user';
import { userDtoToFormInput } from '@/components/UserForm/schema';
import UserForm from '@/components/UserForm/UserForm';
import { updateUserAction } from './actions';

type EditUserPageProps = {
  params: Promise<{
    id: string;
  }>;
};

export default async function EditUserPage({ params }: EditUserPageProps) {
  // Next.js 15ä»¥é™: paramsã‚’awaitã™ã‚‹å¿…è¦ãŒã‚ã‚‹
  const { id } = await params;

  // 1. APIå±¤: unknown -> Strict Schema
  const apiUser = await fetchUser(Number(id));

  // 2. DTOå±¤: APIå‹ -> UIå‹
  const user = userApiToDto(apiUser);

  // 3. Formå±¤: DTOå‹ -> Formå‹
  const formInitialValues = userDtoToFormInput(user);

  // 4. ãƒ•ã‚©ãƒ¼ãƒ ã«æ¸¡ã™
  return (
    <div>
      <h1>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç·¨é›†</h1>
      <UserForm
        initialValues={formInitialValues}
        userId={Number(id)}
        onSubmit={updateUserAction}
      />
    </div>
  );
}
```

### Server Actionã§ã®å®Ÿè£…

```typescript
// app/users/[id]/edit/actions.ts
'use server';

import { userFormInputToApiRequest } from '@/components/UserForm/schema';
import { createUserApiSchema } from '@/components/UserForm/schema';
import { userApiSchema } from '@/api/schema/userSchema';
import { revalidatePath } from 'next/cache';

// useActionStateç”¨ã®å‹å®šç¾©
type ActionState = {
  errors?: {
    firstName?: string;
    lastName?: string;
    email?: string;
    general?: string;
  };
  success?: boolean;
};

export async function updateUserAction(
  prevState: ActionState | null,
  formData: FormData
): Promise<ActionState> {
  // 1. FormDataã‹ã‚‰å€¤ã‚’å–å¾—
  const firstName = formData.get('firstName') as string;
  const lastName = formData.get('lastName') as string;
  const email = formData.get('email') as string;
  const userId = Number(formData.get('userId'));

  // 2. ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå½¢å¼ã«å¤‰æ›
  const apiRequest = userFormInputToApiRequest({
    firstName,
    lastName,
    email,
  });

  // 3. âœ… é‡è¦: APIã«é€ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚‚Zodã§ãƒ‘ãƒ¼ã‚¹ï¼ˆæ´—æµ„ï¼‰ã—ã¦ã‹ã‚‰é€ä¿¡
  // ã“ã‚Œã«ã‚ˆã‚Šã€DTOã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã«å¤‰æ›ã—ãŸéš›ã®ã‚´ãƒŸãƒ‡ãƒ¼ã‚¿ãŒAPIã«é£›ã¶ã®ã‚’é˜²ã
  const parseResult = createUserApiSchema.safeParse(apiRequest);
  
  if (!parseResult.success) {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™
    const errors: ActionState['errors'] = {};
    parseResult.error.errors.forEach((error) => {
      const field = error.path[0] as string;
      if (field === 'first_name') errors.firstName = error.message;
      else if (field === 'last_name') errors.lastName = error.message;
      else if (field === 'email') errors.email = error.message;
    });
    return { errors };
  }

  const validatedRequest = parseResult.data;

  try {
    // 4. APIã‚’å‘¼ã³å‡ºã™ï¼ˆæ´—æµ„æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ï¼‰
    const response = await fetch(`https://api.example.com/users/${userId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(validatedRequest), // âœ… æ´—æµ„æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      return {
        errors: {
          general: errorData.message || 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ',
        },
      };
    }

    const data: unknown = await response.json();

    // 5. âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚‚Zodã§ãƒ‘ãƒ¼ã‚¹ï¼ˆæ´—æµ„ï¼‰
    const validatedResponse = userApiSchema.parse(data);

    // 6. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç„¡åŠ¹åŒ–
    revalidatePath(`/users/${userId}/edit`);

    return { success: true };
  } catch (error) {
    return {
      errors: {
        general: error instanceof Error ? error.message : 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
      },
    };
  }
}
```

### Client Componentã§ã®å®Ÿè£…ï¼ˆuseActionStateä½¿ç”¨ï¼‰

```typescript
// components/UserForm/UserForm.tsx
'use client';

import { useActionState } from 'react';
import { updateUserAction } from '@/app/users/[id]/edit/actions';

type UserFormProps = {
  initialValues: {
    firstName: string;
    lastName: string;
    email: string;
  };
  userId: number;
};

export default function UserForm({
  initialValues,
  userId,
}: UserFormProps) {
  // useActionStateã§Server Actionã®çŠ¶æ…‹ã‚’ç®¡ç†
  // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ï¼ˆã€Œãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€ãªã©ï¼‰ã‚’UIã«è¿”ã™
  const [state, action, isPending] = useActionState(updateUserAction, null);

  return (
    <form action={action}>
      {/* userIdã‚’hidden inputã§é€ä¿¡ */}
      <input type="hidden" name="userId" value={userId} />
      
      <div>
        <label htmlFor="firstName">åå‰</label>
        <input
          id="firstName"
          name="firstName"
          defaultValue={initialValues.firstName}
          aria-invalid={state?.errors?.firstName ? 'true' : 'false'}
        />
        {state?.errors?.firstName && (
          <span role="alert" className="error">
            {state.errors.firstName}
          </span>
        )}
      </div>

      <div>
        <label htmlFor="lastName">å§“</label>
        <input
          id="lastName"
          name="lastName"
          defaultValue={initialValues.lastName}
          aria-invalid={state?.errors?.lastName ? 'true' : 'false'}
        />
        {state?.errors?.lastName && (
          <span role="alert" className="error">
            {state.errors.lastName}
          </span>
        )}
      </div>

      <div>
        <label htmlFor="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input
          id="email"
          type="email"
          name="email"
          defaultValue={initialValues.email}
          aria-invalid={state?.errors?.email ? 'true' : 'false'}
        />
        {state?.errors?.email && (
          <span role="alert" className="error">
            {state.errors.email}
          </span>
        )}
      </div>

      {state?.errors?.general && (
        <div role="alert" className="error">
          {state.errors.general}
        </div>
      )}

      {state?.success && (
        <div className="success">ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ</div>
      )}

      <button type="submit" disabled={isPending}>
        {isPending ? 'é€ä¿¡ä¸­...' : 'é€ä¿¡'}
      </button>
    </form>
  );
}
```

### React Hook Formã¨useActionStateã®çµ„ã¿åˆã‚ã›ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

React Hook Formã‚’ä½¿ã„ãŸã„å ´åˆã§ã‚‚ã€useActionStateã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ï¼š

```typescript
// components/UserForm/UserFormWithRHF.tsx
'use client';

import { useActionState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { userFormSchema, type UserFormInput } from './schema';
import { updateUserAction } from '@/app/users/[id]/edit/actions';

type UserFormProps = {
  initialValues: UserFormInput;
  userId: number;
};

export default function UserFormWithRHF({
  initialValues,
  userId,
}: UserFormProps) {
  const [state, formAction, isPending] = useActionState(updateUserAction, null);

  const {
    register,
    handleSubmit,
    formState: { errors: clientErrors },
  } = useForm<UserFormInput>({
    resolver: zodResolver(userFormSchema),
    defaultValues: initialValues,
  });

  const onSubmit = handleSubmit((data) => {
    // FormDataã‚’ä½œæˆã—ã¦Server Actionã«é€ä¿¡
    const formData = new FormData();
    formData.append('userId', userId.toString());
    formData.append('firstName', data.firstName);
    formData.append('lastName', data.lastName);
    formData.append('email', data.email);
    formAction(formData);
  });

  return (
    <form onSubmit={onSubmit}>
      <div>
        <label htmlFor="firstName">åå‰</label>
        <input id="firstName" {...register('firstName')} />
        {clientErrors.firstName && (
          <span role="alert">{clientErrors.firstName.message}</span>
        )}
        {state?.errors?.firstName && (
          <span role="alert">{state.errors.firstName}</span>
        )}
      </div>

      <div>
        <label htmlFor="lastName">å§“</label>
        <input id="lastName" {...register('lastName')} />
        {clientErrors.lastName && (
          <span role="alert">{clientErrors.lastName.message}</span>
        )}
        {state?.errors?.lastName && (
          <span role="alert">{state.errors.lastName}</span>
        )}
      </div>

      <div>
        <label htmlFor="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input id="email" type="email" {...register('email')} />
        {clientErrors.email && (
          <span role="alert">{clientErrors.email.message}</span>
        )}
        {state?.errors?.email && (
          <span role="alert">{state.errors.email}</span>
        )}
      </div>

      {state?.errors?.general && (
        <div role="alert">{state.errors.general}</div>
      )}

      {state?.success && <div>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ</div>}

      <button type="submit" disabled={isPending}>
        {isPending ? 'é€ä¿¡ä¸­...' : 'é€ä¿¡'}
      </button>
    </form>
  );
}
```

---

## ğŸ ã¾ã¨ã‚

ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆã®è©³ç´°ãªèª¬æ˜ã€ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã®å…¨ä½“åƒã€å„å±¤ã®è²¬å‹™ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«ã¤ã„ã¦ã¯ã€[è¨­è¨ˆã‚¬ã‚¤ãƒ‰ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ](../../../../è¨­è¨ˆã‚¬ã‚¤ãƒ‰/02_apiè¨­è¨ˆ/04_ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

Reactã§ã®å®Ÿè£…ä¾‹ã«ã¤ã„ã¦ã¯ã€[Reactã‚¬ã‚¤ãƒ‰ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ](../../../Reactã‚¬ã‚¤ãƒ‰/02_çŠ¶æ…‹ç®¡ç†/02_ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆ.mdx)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

### Next.jsï¼ˆApp Routerï¼‰ã§ã®ãƒã‚¤ãƒ³ãƒˆ

1. **Next.js 15ã®paramsã¯Promise**: `params`ã¯Next.js 15ä»¥é™ã§ã¯`Promise`å‹ã§ã€`await params`ãŒå¿…è¦ã§ã™ã€‚`const { id } = await params;`ã®ã‚ˆã†ã«å¿…ãšawaitã—ã¦ãã ã•ã„ã€‚
2. **useActionStateã®æ´»ç”¨**: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ï¼ˆã€Œãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒæ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€ãªã©ï¼‰ã‚’UIã«è¿”ã™ãŸã‚ã«ã€Reactå…¬å¼ã®`useActionState`ï¼ˆæ—§`useFormState`ï¼‰ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚Server Actionã¯ã‚¨ãƒ©ãƒ¼ã‚’throwã™ã‚‹ã®ã§ã¯ãªãã€ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ã‚ˆã†ã«å®Ÿè£…ã—ã¾ã™ã€‚
3. **ã€Œé€†æ–¹å‘ã€ã®æ´—æµ„**: APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚‚ã‚‰ã†æ™‚ã¯`zod.parse`ã—ã¦ã„ã¾ã™ãŒã€**APIã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚‹ç›´å‰ã«ã‚‚`zod.parse`ï¼ˆã¾ãŸã¯`safeParse`ï¼‰ã§æ´—æµ„**ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€DTOã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã«å¤‰æ›ã—ãŸéš›ã®ã‚´ãƒŸãƒ‡ãƒ¼ã‚¿ãŒAPIã«é£›ã¶ã®ã‚’é˜²ã’ã¾ã™ã€‚
4. **Server Componentsã®æ´»ç”¨**: ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã€å‹å¤‰æ›ã‚’è¡Œã†
5. **Server Actionsã®æ´»ç”¨**: ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’Server Actionã§å‡¦ç†ã—ã€å‹å®‰å…¨æ€§ã‚’ä¿ã¤ï¼ˆ`'use server'`ã¯é–¢æ•°ã®å…ˆé ­ã«è¨˜è¿°ï¼‰
6. **Client Componentsã¨ã®åˆ†é›¢**: ãƒ•ã‚©ãƒ¼ãƒ ãªã©ã®ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªéƒ¨åˆ†ã¯`'use client'`ã§Client Componentã¨ã—ã¦å®Ÿè£…
7. **MSWã¨ã®é€£æº**: é–‹ç™ºç’°å¢ƒã§ã¯[MSWï¼ˆãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ï¼‰](../../../../è¨­è¨ˆã‚¬ã‚¤ãƒ‰/02_apiè¨­è¨ˆ/05_msw_ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼)ã‚’ä½¿ç”¨ã—ã¦APIã‚’ãƒ¢ãƒƒã‚¯

ã“ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­è¨ˆã‚’å®ˆã‚‹ã“ã¨ã§ã€APIã¨UIã®è²¬å‹™ãŒæ˜ç¢ºã«åˆ†é›¢ã•ã‚Œã€ä¿å®ˆæ€§ã®é«˜ã„Next.jsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚
