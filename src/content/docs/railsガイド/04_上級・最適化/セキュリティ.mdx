---
title: "セキュリティ"
label: "セキュリティ"
---

## 🛡️ Rails セキュリティガイド

Railsは、デフォルトで多くのセキュリティ対策が施されていますが、開発者が意識すべき重要なポイントを理解することが不可欠です。

### 🚫 CSRF（クロスサイト・リクエスト・フォージェリ）対策

CSRFは、悪意のあるサイトを経由して、ユーザーが意図しないリクエストを正規のサイトに送信させる攻撃です。

**protect_from_forgery メソッドの仕組み**

Railsのコントローラーで`protect_from_forgery with: :exception`が設定されていると、Railsは各フォームに真正性トークン（authenticity token）を埋め込みます。

- ✅ **正常なリクエスト**: フォームからリクエストが送信されると、Railsは送られてきたトークンとサーバー側のセッションに保存されたトークンが一致するか検証します。一致すれば処理が続行されます。
- 🚨 **悪意あるリクエスト**: 悪意のあるサイトからのリクエストには、このトークンが含まれていないか、無効なトークンが送られます。Railsはトークンが一致しないことを検知し、リクエストを拒否します。

これが`protect_from_forgery`の主要な役割であり、CSRF攻撃からアプリを守るための最も重要な防衛策です。

### 🎨 XSS（クロスサイト・スクリプティング）対策

XSSは、Webページに悪意のあるスクリプトを埋め込み、そのスクリプトを他のユーザーのブラウザで実行させる攻撃です。

**エスケープ処理の自動化**

RailsのERBテンプレートでは、`<%= ... %>`を使用して変数を表示する際、HTMLエスケープが自動的に行われます。これにより、ユーザーが入力した悪意のあるスクリプトタグ（例: `<script>alert('XSS!')</script>`)は、単なる文字列として扱われ、実行されることはありません。

`<%= @user.name %>` → `&lt;script&gt;alert('XSS!')&lt;/script&gt;`

**rawとhtml_safeの使用注意**

- ⚠️ **rawヘルパー**: 自動エスケープを無効にし、HTMLタグをそのまま出力します。信頼できるソースのHTML（例: Markdownから変換したテキスト）を表示する場合にのみ使用します。
- ⚠️ **html_safeメソッド**: 文字列を「安全なHTML」としてマークし、エスケープを無効にします。これも信頼できる文字列にのみ使用すべきです。ユーザー入力に対して安易に使うと、XSSの脆弱性を生み出す原因となります。

### 💻 SQLインジェクション対策

SQLインジェクションは、ユーザー入力に悪意のあるSQL文を紛れ込ませて、データベースを不正に操作する攻撃です。

**ActiveRecordの防御策**

ActiveRecordは、プレースホルダーを利用したクエリ生成をデフォルトで行うことで、SQLインジェクションを強力に防御します。

- ❌ **悪い例（脆弱性あり）**: 文字列結合でSQLクエリを構築すると危険です。
  ```ruby
  User.where("name = '#{params[:name]}'")
  ```
  `params[:name]`が `' or 1=1 --` の場合、全ユーザー情報が取得される可能性があります。

- ✅ **良い例（安全な方法）**: プレースホルダーを使用します。
  ```ruby
  User.where("name = ?", params[:name])
  ```
  Railsは、`?`の部分に`params[:name]`の値を安全に埋め込みます。`' or 1=1 --` のような文字列は、`name`の値そのものとして扱われ、SQL文として解釈されることはありません。

常にプレースホルダーやハッシュ形式（`User.where(name: params[:name])`）を使ってクエリを記述することで、安全なアプリケーションを構築できます。