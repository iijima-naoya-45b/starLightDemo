---
title: "API利用法"
label: "API利用法"
---

## API利用法

Railsは、通常のWebアプリケーションだけでなく、API（Application Programming Interface）を構築するための機能も充実しています。ここでは、APIモードでの開発方法と、CORS（Cross-Origin Resource Sharing）の設定について解説します。

### APIモード

Railsでは、API専用のアプリケーションを簡単に作成できます。これにより、HTMLやCSSの生成といった、Webページ表示に必要な機能を省き、軽量で高速なアプリケーションを構築できます。

以下のコマンドで新しいRailsアプリケーションを作成する際に、`--api`オプションを追加します。

```bash
rails new my_api --api
```

このコマンドで作成されたアプリケーションは、以下の設定が自動的に適用されます。

- **ミドルウェアの最適化**: Webページ表示用のミドルウェア（例：ActionView、sprockets）が読み込まれず、より高速に動作します。
- **ジェネレーターの変更**: `rails generate`コマンドでビューファイル（.html.erbなど）が生成されなくなります。

#### ⚠️ 「APIモード」の本当の落とし穴

`--api`オプションは確かに軽量ですが、いくつかの「Railsの便利機能」も一緒に削ぎ落としています。

**重要な理解**:
APIモードではデフォルトで「Cookie」や「Session」がオフになっています。

**問題点**:
「Deviseでログイン機能を実装しようとしたら動かない！」という初心者の叫びは大抵これが原因です。

```ruby
# APIモードでは、デフォルトで以下のミドルウェアが無効化されている
# - ActionDispatch::Cookies
# - ActionDispatch::Session::CookieStore
# - ActionDispatch::Flash

# そのため、DeviseなどのCookieベースの認証が動作しない
```

**改善案**:
APIモードで認証（Cookieベース）を行う場合は、`config/application.rb`でミドルウェアを手動で追加する必要があることを補足しましょう。あるいは、React側でトークンベース（JWTなど）の認証を行う覚悟が必要です。

```ruby
# config/application.rb
module MyApi
  class Application < Rails::Application
    config.load_defaults 7.0
    
    # Cookieベースの認証が必要な場合
    config.middleware.use ActionDispatch::Cookies
    config.middleware.use ActionDispatch::Session::CookieStore, key: '_my_api_session'
    
    # または、JWTベースの認証を使用（推奨）
    # React側でトークンを管理し、Authorizationヘッダーで送信
  end
end
```

**推奨されるアプローチ**:
- **Cookieベース認証**: ミドルウェアを手動で追加（ただし、CORS設定が複雑になる）
- **JWTベース認証**: React側でトークンを管理（推奨、APIモードに適している）

この違いを理解することで、APIモードでの認証実装がスムーズになります。

### コントローラーの作成

APIモードのアプリケーションで、JSONデータを返すためのコントローラーを作成します。

```bash
rails generate controller Api::V1::Posts index show create update destroy
```

このコマンドは、`app/controllers/api/v1`ディレクトリに`posts_controller.rb`を作成し、`index`、`show`、`create`、`update`、`destroy`といったアクションを定義します。

#### ⚠️ JSONレスポンスの「型」の保証

APIモードのコントローラーについて。

**重要な理解**:
`render json: @posts`と書くだけでは、フロントエンド（React）が泣きます。

**問題点**:
モデルの属性がそのまま全部（`created_at`や、見せたくない`password_digest`まで）返ってしまいます。

```ruby
# ❌ 問題: すべての属性が返される
class Api::V1::PostsController < ApplicationController
  def index
    @posts = Post.all
    render json: @posts
    # 結果:
    # {
    #   "id": 1,
    #   "title": "Hello",
    #   "content": "...",
    #   "created_at": "2024-01-01T00:00:00.000Z",
    #   "updated_at": "2024-01-01T00:00:00.000Z",
    #   "user_id": 1,
    #   "password_digest": "..."  # 見せたくない！
    # }
  end
end
```

**改善案**:
Jbuilderやblueprinterといったシリアライザー（整形ライブラリ）を使い、フロントエンドが必要なデータだけを、適切な型（camelCaseへの変換など）で返すのがプロの作法です。

```ruby
# ✅ 良い例1: Jbuilderを使用
# app/views/api/v1/posts/index.json.jbuilder
json.posts @posts do |post|
  json.id post.id
  json.title post.title
  json.content post.content
  json.createdAt post.created_at  # camelCaseに変換
  json.user do
    json.id post.user.id
    json.name post.user.name
  end
end

# コントローラー
class Api::V1::PostsController < ApplicationController
  def index
    @posts = Post.includes(:user).all
    render :index  # Jbuilderテンプレートを使用
  end
end

# ✅ 良い例2: blueprinterを使用
# app/blueprints/post_blueprint.rb
class PostBlueprint < Blueprinter::Base
  identifier :id
  
  fields :title, :content
  
  field :created_at do |post|
    post.created_at.iso8601
  end
  
  association :user, blueprint: UserBlueprint
end

# コントローラー
class Api::V1::PostsController < ApplicationController
  def index
    @posts = Post.includes(:user).all
    render json: PostBlueprint.render(@posts)
  end
end
```

**推奨されるアプローチ**:
- **Jbuilder**: Rails標準のテンプレートエンジン、シンプルな構造に適している
- **blueprinter**: より柔軟で、複雑なAPIレスポンスに適している
- **ActiveModel::Serializers**: 中間的な選択肢

このアプローチにより、フロントエンドが必要なデータだけを、適切な形式で受け取れます。

### CORS（Cross-Origin Resource Sharing）の設定

APIを開発する上で、異なるドメインからのリクエストを許可するCORSの設定は不可欠です。Railsでは`rack-cors`というGemを使って簡単に設定できます。

#### Gemの追加

`Gemfile`に以下の行を追加し、`bundle install`を実行します。

```ruby
# Gemfile
gem 'rack-cors'
```

```bash
bundle install
```

#### 設定ファイルの編集

`config/initializers/cors.rb`ファイルを開き、コメントアウトされている部分を以下のように編集します。

```ruby
# config/initializers/cors.rb

Rails.application.config.middleware.insert_before 0, Rack::Cors do
  allow do
    origins '*'  # 任意のドメインからのリクエストを許可
    resource '*',
      headers: :any,
      methods: [:get, :post, :put, :patch, :delete, :options, :head]
  end
end
```

#### ⚠️ CORS設定の「セキュリティ・ホール」

`origins '*'`の解説についてです。

**重要な理解**:
本番環境で`origins '*'`は絶対にNGです。

**問題点**:
これをやると、悪意のあるサイトからあなたのAPIを叩き放題になります。

```ruby
# ❌ 危険: 本番環境で絶対にNG
Rails.application.config.middleware.insert_before 0, Rack::Cors do
  allow do
    origins '*'  # すべてのドメインからアクセス可能
    resource '*',
      headers: :any,
      methods: [:get, :post, :put, :patch, :delete, :options, :head]
  end
end
```

**改善案**:
環境変数（`ENV['FRONTEND_URL']`など）を使って、本番環境では許可するドメインを厳密に指定するコード例を載せるのが「安全に壊れる」設計思想です。

```ruby
# ✅ 安全: 環境変数で許可ドメインを指定
Rails.application.config.middleware.insert_before 0, Rack::Cors do
  allow do
    # 開発環境: localhostを許可
    # 本番環境: 環境変数から許可ドメインを取得
    origins(
      'http://localhost:3000',
      'http://localhost:3001',
      ENV['FRONTEND_URL'] || 'https://example.com'
    )
    
    resource '*',
      headers: :any,
      methods: [:get, :post, :put, :patch, :delete, :options, :head],
      credentials: true  # Cookieを使用する場合
  end
end

# 環境変数の設定例
# .env（開発環境）
# FRONTEND_URL=http://localhost:3000

# .env.production（本番環境）
# FRONTEND_URL=https://myapp.com
```

**推奨される設定**:
- **開発環境**: `localhost`の複数ポートを許可
- **本番環境**: 環境変数から許可ドメインを取得し、厳密に指定
- **複数ドメイン**: 配列で複数のドメインを指定可能

この設定により、セキュリティホールを防ぎ、安全なAPIを構築できます。