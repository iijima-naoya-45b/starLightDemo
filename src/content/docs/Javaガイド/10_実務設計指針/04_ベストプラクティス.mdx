---
title: "ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹"
label: "ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹"
---

## âœ… ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

`Java`ã§ã®æ­£ã—ã„æ§‹é€ ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

### ğŸ“‹ 1. Outboxãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…

#### âœ… æ­£ã—ã„æ§‹é€ 

```java
@Service
public class OrderService {
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private OutboxRepository outboxRepository;
    
    @Transactional
    public Order createOrder(OrderData orderData) {
        // âœ… æ­£ã—ã„: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§Outboxã«è¨˜éŒ²
        Order order = orderRepository.save(new Order(orderData));
        
        // Outboxãƒ†ãƒ¼ãƒ–ãƒ«ã«å¤–éƒ¨APIå‘¼ã³å‡ºã—ã®ã‚¿ã‚¹ã‚¯ã‚’è¨˜éŒ²
        OutboxEvent event = new OutboxEvent();
        event.setEventType("PAYMENT_CHARGE");
        event.setAggregateId(order.getId());
        event.setPayload(JSON.toJSONString(Map.of(
            "orderId", order.getId(),
            "amount", orderData.getAmount()
        )));
        event.setStatus("PENDING");
        event.setIdempotencyKey("payment-" + order.getId() + "-" + System.currentTimeMillis());
        outboxRepository.save(event);
        
        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒŸãƒƒãƒˆï¼ˆå¤–éƒ¨APIã¯å‘¼ã°ãªã„ï¼‰
        return order;
    }
}

// åˆ¥ã®ãƒ—ãƒ­ã‚»ã‚¹/ãƒ¯ãƒ¼ã‚«ãƒ¼ã§Outboxã‚’å‡¦ç†
@Component
public class OutboxProcessor {
    @Autowired
    private OutboxRepository outboxRepository;
    
    @Autowired
    private PaymentApiClient paymentApiClient;
    
    @Scheduled(fixedRate = 5000) // 5ç§’ã”ã¨
    public void processOutbox() {
        List<OutboxEvent> pendingEvents = outboxRepository.findByStatus("PENDING");
        
        for (OutboxEvent event : pendingEvents) {
            try {
                // å¤–éƒ¨APIã‚’å‘¼ã¶ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤–ï¼‰
                Map<String, Object> payload = JSON.parseObject(event.getPayload(), Map.class);
                PaymentResult result = paymentApiClient.chargePayment(
                    (Long) payload.get("orderId"),
                    (BigDecimal) payload.get("amount")
                );
                
                if (result.isSuccess()) {
                    event.setStatus("COMPLETED");
                    outboxRepository.save(event);
                } else {
                    event.setStatus("FAILED");
                    event.setRetryCount(event.getRetryCount() + 1);
                    outboxRepository.save(event);
                }
            } catch (Exception e) {
                // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                event.setStatus("FAILED");
                event.setRetryCount(event.getRetryCount() + 1);
                outboxRepository.save(event);
                log.error("Failed to process outbox event: " + event.getId(), e);
            }
        }
    }
}
```

**ãªãœæ­£ã—ã„ã‹:**

- **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®çŸ­ç¸®**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ­ãƒƒã‚¯æ™‚é–“ãŒçŸ­ç¸®ã•ã‚Œã‚‹
- **å¤–éƒ¨éšœå®³ã®åˆ†é›¢**: å¤–éƒ¨APIã®éšœå®³ãŒãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å½±éŸ¿ã—ãªã„
- **å†å®Ÿè¡Œã®å®¹æ˜“ã•**: Outboxãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å†å®Ÿè¡Œå¯èƒ½
- **å†ªç­‰æ€§ã®ä¿è¨¼**: å†ªç­‰ã‚­ãƒ¼ã«ã‚ˆã‚Šé‡è¤‡å®Ÿè¡Œã‚’é˜²æ­¢

### 2. Serverlessç’°å¢ƒã§ã®éåŒæœŸå‡¦ç†

#### æ­£ã—ã„æ§‹é€ 

```java
@RestController
public class ReportController {
    @Autowired
    private ReportService reportService;
    
    @Autowired
    private MessageQueue messageQueue;
    
    @PostMapping("/reports/generate")
    public ResponseEntity<ReportResponse> generateReport(@RequestBody ReportRequest request) {
        // âœ… æ­£ã—ã„: å³åº§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
        String reportId = UUID.randomUUID().toString();
        
        // ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ¥ãƒ¼ã«æŠ•å…¥
        messageQueue.send("report.generate", Map.of(
            "reportId", reportId,
            "request", request
        ));
        
        return ResponseEntity.accepted()
            .body(new ReportResponse(reportId, "PROCESSING"));
    }
}

// ãƒ¯ãƒ¼ã‚«ãƒ¼ï¼ˆå¸¸é§ãƒ—ãƒ­ã‚»ã‚¹ç’°å¢ƒï¼‰ã§å‡¦ç†
@Component
public class ReportWorker {
    @Autowired
    private ReportService reportService;
    
    @RabbitListener(queues = "report.generate")
    public void processReportGeneration(Map<String, Object> message) {
        String reportId = (String) message.get("reportId");
        ReportRequest request = (ReportRequest) message.get("request");
        
        // é•·æ™‚é–“å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ï¼ˆå¸¸é§ãƒ—ãƒ­ã‚»ã‚¹ç’°å¢ƒã§å®Ÿè¡Œï¼‰
        Report report = reportService.generateLargeReport(request);
        
        // çµæœã‚’ä¿å­˜
        reportService.saveReport(reportId, report);
    }
}
```

**ãªãœæ­£ã—ã„ã‹:**

- **å³åº§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å³åº§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡
- **éåŒæœŸå‡¦ç†**: é•·æ™‚é–“å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã¯åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ã§å®Ÿè¡Œ
- **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’ã‚¹ã‚±ãƒ¼ãƒ«ã—ã¦å‡¦ç†èƒ½åŠ›ã‚’å‘ä¸Š

### 3. é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

#### æ­£ã—ã„æ§‹é€ 

```java
@Service
public class FileService {
    public void processFile(String filePath) {
        // âœ… æ­£ã—ã„: try-with-resourcesæ–‡ã‚’ä½¿ç”¨
        try (FileInputStream fis = new FileInputStream(filePath);
             BufferedInputStream bis = new BufferedInputStream(fis)) {
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
            byte[] buffer = new byte[1024];
            int bytesRead;
            while ((bytesRead = bis.read(buffer)) != -1) {
                // å‡¦ç†...
            }
        } catch (FileNotFoundException e) {
            // é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            log.error("File not found: " + filePath, e);
            throw new FileProcessingException("File not found: " + filePath, e);
        } catch (IOException e) {
            // é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            log.error("IO error while processing file: " + filePath, e);
            throw new FileProcessingException("IO error: " + e.getMessage(), e);
        }
    }
}
```

**ãªãœæ­£ã—ã„ã‹:**

- **ãƒªã‚½ãƒ¼ã‚¹ã®è‡ªå‹•è§£æ”¾**: try-with-resourcesæ–‡ã«ã‚ˆã‚Šè‡ªå‹•çš„ã«ãƒªã‚½ãƒ¼ã‚¹ãŒã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã‚‹
- **é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã—ã€ãƒ­ã‚°ã«è¨˜éŒ²
- **ã‚¨ãƒ©ãƒ¼ã®ä¼æ’­**: é©åˆ‡ãªä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼ã—ã¦å‘¼ã³å‡ºã—å…ƒã«ä¼æ’­

### 4. ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ã®ç¢ºä¿

#### æ­£ã—ã„æ§‹é€ 

```java
@Service
public class CounterService {
    // âœ… æ­£ã—ã„: AtomicIntegerã‚’ä½¿ç”¨
    private final AtomicInteger count = new AtomicInteger(0);
    
    public void increment() {
        count.incrementAndGet(); // ã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œ
    }
    
    public int getCount() {
        return count.get(); // ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãªèª­ã¿å–ã‚Š
    }
}

// ã¾ãŸã¯ã€synchronizedã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
@Service
public class CounterService {
    private int count = 0;
    private final Object lock = new Object();
    
    public void increment() {
        synchronized (lock) {
            count++;
        }
    }
    
    public int getCount() {
        synchronized (lock) {
            return count;
        }
    }
}
```

**ãªãœæ­£ã—ã„ã‹:**

- **ã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œ**: `AtomicInteger`ã«ã‚ˆã‚Šã‚¢ãƒˆãƒŸãƒƒã‚¯æ“ä½œãŒä¿è¨¼ã•ã‚Œã‚‹
- **å¯è¦–æ€§**: å¤‰æ›´ãŒã™ã¹ã¦ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã«å¯è¦–ã«ãªã‚‹
- **ç«¶åˆçŠ¶æ…‹ã®å›é¿**: ç«¶åˆçŠ¶æ…‹ãŒç™ºç”Ÿã—ãªã„

### 5. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®é©åˆ‡ãªç®¡ç†

#### æ­£ã—ã„æ§‹é€ 

```java
@Service
public class OrderService {
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private InventoryService inventoryService;
    
    @Autowired
    private PaymentService paymentService;
    
    @Transactional(propagation = Propagation.REQUIRED, isolation = Isolation.READ_COMMITTED)
    public Order createOrder(OrderData orderData) {
        // âœ… æ­£ã—ã„: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã®ã¿
        Order order = orderRepository.save(new Order(orderData));
        
        // âœ… æ­£ã—ã„: åŒã˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã®åœ¨åº«æ›´æ–°
        inventoryService.reduceStock(order.getItems());
        
        // âœ… æ­£ã—ã„: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒŸãƒƒãƒˆå¾Œã«å¤–éƒ¨APIã‚’å‘¼ã¶
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronization() {
                @Override
                public void afterCommit() {
                    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒŸãƒƒãƒˆå¾Œã«å¤–éƒ¨APIã‚’å‘¼ã¶
                    paymentService.chargePaymentAsync(order.getId(), orderData.getAmount());
                }
            }
        );
        
        return order;
    }
}
```

**ãªãœæ­£ã—ã„ã‹:**

- **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®çŸ­ç¸®**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã®ã¿ã‚’ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œ
- **å¤–éƒ¨APIã®åˆ†é›¢**: å¤–éƒ¨APIã¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤–ã§å®Ÿè¡Œ
- **ä¸€è²«æ€§ã®ä¿è¨¼**: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚³ãƒŸãƒƒãƒˆã•ã‚ŒãŸå¾Œã«ã®ã¿å¤–éƒ¨APIã‚’å‘¼ã¶

### ã¾ã¨ã‚

ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®ãƒã‚¤ãƒ³ãƒˆï¼š

- **Outboxãƒ‘ã‚¿ãƒ¼ãƒ³**: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å¤–éƒ¨APIå‘¼ã³å‡ºã—ã‚’è¨˜éŒ²ã—ã€åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ã§å‡¦ç†
- **éåŒæœŸå‡¦ç†**: Serverlessç’°å¢ƒã§ã¯å³åº§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã€é•·æ™‚é–“å‡¦ç†ã¯åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ã§å®Ÿè¡Œ
- **é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: try-with-resourcesæ–‡ã‚’ä½¿ç”¨ã—ã€é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å®Ÿè£…
- **ã‚¹ãƒ¬ãƒƒãƒ‰ã‚»ãƒ¼ãƒ•ãƒ†ã‚£**: `AtomicInteger`ã‚„`synchronized`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’ä½¿ç”¨
- **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®é©åˆ‡ãªç®¡ç†**: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã®ã¿ã€å¤–éƒ¨APIã¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤–ã§å®Ÿè¡Œ

é©åˆ‡ãªãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®å®Ÿè£…ã«ã‚ˆã‚Šã€å®‰å…¨ã§ä¿¡é ¼æ€§ã®é«˜ã„ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚

