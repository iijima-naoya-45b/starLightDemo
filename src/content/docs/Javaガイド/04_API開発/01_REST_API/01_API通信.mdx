---
title: "APIé€šä¿¡"
label: "APIé€šä¿¡"
---

## ğŸŒ Spring Bootã§ã®APIé€šä¿¡

Spring Bootã§ã¯ã€`RestTemplate`ã‚„`WebClient`ã‚’ä½¿ç”¨ã—ã¦ã€å¤–éƒ¨APIã¨ã®é€šä¿¡ã‚’ç°¡å˜ã«å®Ÿè£…ã§ãã¾ã™ã€‚ã“ã®ç« ã§ã¯ã€REST APIã¨ã®é€šä¿¡æ–¹æ³•ã«ã¤ã„ã¦è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

### ğŸ“‹ RestTemplateã®åŸºæœ¬ä½¿ç”¨

`RestTemplate`ã¯ã€Spring FrameworkãŒæä¾›ã™ã‚‹åŒæœŸHTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã™ã€‚

#### åŸºæœ¬çš„ãªè¨­å®š

```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    public RestTemplate restTemplate() {
        return new RestTemplate();
    }
    
    // ã‚ˆã‚Šè©³ç´°ãªè¨­å®š
    @Bean
    public RestTemplate restTemplateWithTimeout() {
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory();
        factory.setConnectTimeout(5000);  // æ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆãƒŸãƒªç§’ï¼‰
        factory.setReadTimeout(5000);     // èª­ã¿å–ã‚Šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆãƒŸãƒªç§’ï¼‰
        
        return new RestTemplate(factory);
    }
}
```

#### GETãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```java
@Service
public class ApiService {
    
    private final RestTemplate restTemplate;
    private static final String API_BASE_URL = "https://api.example.com";
    
    public ApiService(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }
    
    // å˜ç´”ãªGETãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    public String getData() {
        String url = API_BASE_URL + "/data";
        ResponseEntity<String> response = restTemplate.getForEntity(url, String.class);
        return response.getBody();
    }
    
    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ãGETãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    public UserDTO getUser(Long id) {
        String url = API_BASE_URL + "/users/{id}";
        Map<String, Long> params = Map.of("id", id);
        ResponseEntity<UserDTO> response = restTemplate.getForEntity(
            url, UserDTO.class, params);
        return response.getBody();
    }
    
    // URIå¤‰æ•°ã‚’ä½¿ç”¨
    public UserDTO getUserWithUriVariables(Long id) {
        String url = API_BASE_URL + "/users/{id}";
        ResponseEntity<UserDTO> response = restTemplate.getForEntity(
            url, UserDTO.class, id);
        return response.getBody();
    }
    
    // ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»˜ã
    public List<UserDTO> searchUsers(String name) {
        UriComponentsBuilder builder = UriComponentsBuilder
            .fromUriString(API_BASE_URL + "/users")
            .queryParam("name", name);
        
        ResponseEntity<UserDTO[]> response = restTemplate.getForEntity(
            builder.toUriString(), UserDTO[].class);
        return Arrays.asList(response.getBody());
    }
}
```

#### POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```java
@Service
public class ApiService {
    
    private final RestTemplate restTemplate;
    
    // å˜ç´”ãªPOSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    public UserDTO createUser(UserCreateRequest request) {
        String url = API_BASE_URL + "/users";
        ResponseEntity<UserDTO> response = restTemplate.postForEntity(
            url, request, UserDTO.class);
        return response.getBody();
    }
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®šã—ãŸPOSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    public UserDTO createUserWithHeaders(UserCreateRequest request, String token) {
        String url = API_BASE_URL + "/users";
        
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(token);
        
        HttpEntity<UserCreateRequest> entity = new HttpEntity<>(request, headers);
        ResponseEntity<UserDTO> response = restTemplate.postForEntity(
            url, entity, UserDTO.class);
        return response.getBody();
    }
    
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
    public UserDTO createUserWithCustomHeaders(UserCreateRequest request) {
        String url = API_BASE_URL + "/users";
        
        HttpHeaders headers = new HttpHeaders();
        headers.set("X-API-Key", "your-api-key");
        headers.set("X-Request-ID", UUID.randomUUID().toString());
        
        HttpEntity<UserCreateRequest> entity = new HttpEntity<>(request, headers);
        ResponseEntity<UserDTO> response = restTemplate.postForEntity(
            url, entity, UserDTO.class);
        return response.getBody();
    }
}
```

#### PUT/DELETEãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```java
@Service
public class ApiService {
    
    private final RestTemplate restTemplate;
    
    // PUTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    public UserDTO updateUser(Long id, UserUpdateRequest request) {
        String url = API_BASE_URL + "/users/{id}";
        
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        HttpEntity<UserUpdateRequest> entity = new HttpEntity<>(request, headers);
        
        ResponseEntity<UserDTO> response = restTemplate.exchange(
            url, HttpMethod.PUT, entity, UserDTO.class, id);
        return response.getBody();
    }
    
    // DELETEãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    public void deleteUser(Long id) {
        String url = API_BASE_URL + "/users/{id}";
        restTemplate.delete(url, id);
    }
    
    // DELETEãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å–å¾—ï¼‰
    public ResponseEntity<Void> deleteUserWithResponse(Long id) {
        String url = API_BASE_URL + "/users/{id}";
        return restTemplate.exchange(
            url, HttpMethod.DELETE, null, Void.class, id);
    }
}
```

### WebClientã®ä½¿ç”¨ï¼ˆéæ¨å¥¨ã®ä»£æ›¿ï¼‰

`RestTemplate`ã¯éæ¨å¥¨ã¨ãªã£ã¦ãŠã‚Šã€`WebClient`ãŒæ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚`WebClient`ã¯éåŒæœŸãƒ»éãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã®HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã™ã€‚

#### WebClientã®è¨­å®š

```java
@Configuration
public class WebClientConfig {
    
    @Bean
    public WebClient webClient() {
        return WebClient.builder()
            .baseUrl("https://api.example.com")
            .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
            .build();
    }
    
    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šä»˜ã
    @Bean
    public WebClient webClientWithTimeout() {
        HttpClient httpClient = HttpClient.create()
            .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5000)
            .responseTimeout(Duration.ofSeconds(5))
            .doOnConnected(conn -> 
                conn.addHandlerLast(new ReadTimeoutHandler(5))
                    .addHandlerLast(new WriteTimeoutHandler(5)));
        
        ReactorClientHttpConnector connector = 
            new ReactorClientHttpConnector(httpClient);
        
        return WebClient.builder()
            .baseUrl("https://api.example.com")
            .clientConnector(connector)
            .build();
    }
}
```

#### WebClientã§ã®GETãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```java
@Service
public class ApiService {
    
    private final WebClient webClient;
    
    public ApiService(WebClient webClient) {
        this.webClient = webClient;
    }
    
    // åŒæœŸå®Ÿè¡Œï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ï¼‰
    public UserDTO getUser(Long id) {
        return webClient.get()
            .uri("/users/{id}", id)
            .retrieve()
            .bodyToMono(UserDTO.class)
            .block();
    }
    
    // éåŒæœŸå®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰
    public Mono<UserDTO> getUserAsync(Long id) {
        return webClient.get()
            .uri("/users/{id}", id)
            .retrieve()
            .bodyToMono(UserDTO.class);
    }
    
    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ã
    public Mono<UserDTO> getUserWithErrorHandling(Long id) {
        return webClient.get()
            .uri("/users/{id}", id)
            .retrieve()
            .onStatus(HttpStatus::is4xxClientError, response -> 
                Mono.error(new ClientException("Client error: " + response.statusCode())))
            .onStatus(HttpStatus::is5xxServerError, response -> 
                Mono.error(new ServerException("Server error: " + response.statusCode())))
            .bodyToMono(UserDTO.class);
    }
}
```

#### WebClientã§ã®POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ

```java
@Service
public class ApiService {
    
    private final WebClient webClient;
    
    // POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    public Mono<UserDTO> createUser(UserCreateRequest request) {
        return webClient.post()
            .uri("/users")
            .bodyValue(request)
            .retrieve()
            .bodyToMono(UserDTO.class);
    }
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ä»˜ãPOSTãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    public Mono<UserDTO> createUserWithAuth(UserCreateRequest request, String token) {
        return webClient.post()
            .uri("/users")
            .header(HttpHeaders.AUTHORIZATION, "Bearer " + token)
            .bodyValue(request)
            .retrieve()
            .bodyToMono(UserDTO.class);
    }
}
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

APIé€šä¿¡æ™‚ã®ã‚¨ãƒ©ãƒ¼ã‚’é©åˆ‡ã«å‡¦ç†ã—ã¾ã™ã€‚

```java
@Service
public class ApiService {
    
    private final RestTemplate restTemplate;
    
    public UserDTO getUser(Long id) {
        try {
            String url = API_BASE_URL + "/users/{id}";
            ResponseEntity<UserDTO> response = restTemplate.getForEntity(
                url, UserDTO.class, id);
            return response.getBody();
        } catch (HttpClientErrorException.NotFound e) {
            throw new ResourceNotFoundException("User", id);
        } catch (HttpClientErrorException e) {
            throw new ApiException("API client error: " + e.getMessage());
        } catch (HttpServerErrorException e) {
            throw new ApiException("API server error: " + e.getMessage());
        } catch (ResourceAccessException e) {
            throw new ApiException("Connection error: " + e.getMessage());
        }
    }
}
```

### ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã®å®Ÿè£…

ä¸€æ™‚çš„ãªã‚¨ãƒ©ãƒ¼ã«å¯¾ã—ã¦ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```java
@Configuration
public class RestTemplateConfig {
    
    @Bean
    public RestTemplate restTemplateWithRetry() {
        RestTemplate restTemplate = new RestTemplate();
        
        // ãƒªãƒˆãƒ©ã‚¤å¯èƒ½ãªHTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
        HttpComponentsClientHttpRequestFactory factory = 
            new HttpComponentsClientHttpRequestFactory();
        CloseableHttpClient httpClient = HttpClients.custom()
            .setRetryHandler(new DefaultHttpRequestRetryHandler(3, true))
            .build();
        factory.setHttpClient(httpClient);
        
        restTemplate.setRequestFactory(factory);
        return restTemplate;
    }
}
```

### ãƒ­ã‚®ãƒ³ã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

APIé€šä¿¡ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã—ã€ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚

```java
@Service
@Slf4j
public class ApiService {
    
    private final RestTemplate restTemplate;
    
    public UserDTO getUser(Long id) {
        String url = API_BASE_URL + "/users/{id}";
        
        long startTime = System.currentTimeMillis();
        try {
            ResponseEntity<UserDTO> response = restTemplate.getForEntity(
                url, UserDTO.class, id);
            
            long duration = System.currentTimeMillis() - startTime;
            log.info("API call successful: url={}, status={}, duration={}ms", 
                url, response.getStatusCode(), duration);
            
            return response.getBody();
        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            log.error("API call failed: url={}, duration={}ms", url, duration, e);
            throw e;
        }
    }
}
```

### ã¾ã¨ã‚

Spring Bootã§ã®APIé€šä¿¡ã¯ã€ä»¥ä¸‹ã®æ–¹æ³•ã§å®Ÿè£…ã§ãã¾ã™ï¼š

- **RestTemplate**: åŒæœŸHTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆéæ¨å¥¨ã ãŒåºƒãä½¿ç”¨ï¼‰
- **WebClient**: éåŒæœŸãƒ»éãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°HTTPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆæ¨å¥¨ï¼‰
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: é©åˆ‡ãªä¾‹å¤–å‡¦ç†ã®å®Ÿè£…
- **ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½**: ä¸€æ™‚çš„ãªã‚¨ãƒ©ãƒ¼ã¸ã®å¯¾å¿œ
- **ãƒ­ã‚®ãƒ³ã‚°**: APIé€šä¿¡ã®ç›£è¦–ã¨ãƒ‡ãƒãƒƒã‚°

ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’é©åˆ‡ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€å …ç‰¢ãªAPIé€šä¿¡ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚


