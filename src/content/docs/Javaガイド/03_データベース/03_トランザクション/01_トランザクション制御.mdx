---
title: "ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ¶å¾¡"
label: "ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ¶å¾¡"
---

## ğŸ”„ ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ¶å¾¡

`ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³`ç®¡ç†ã¯ã€ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãŠã„ã¦æœ€ã‚‚é‡è¦ãªè¨­è¨ˆæ±ºå®šã®ä¸€ã¤ã§ã™ã€‚ã“ã®ç« ã§ã¯ã€`ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³`åˆ¶å¾¡ã®æ·±ã„ç†è§£ã¨å®Ÿè·µçš„ãªæ„æ€æ±ºå®šã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

### ğŸ¯ ãªãœãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ãŒé‡è¦ãªã®ã‹

#### ğŸ“‹ ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®æœ¬è³ªçš„ãªä¾¡å€¤

**ğŸ“‹ ACIDç‰¹æ€§ã®å®Ÿè·µçš„ãªæ„å‘³:**

```java
// Atomicityï¼ˆåŸå­æ€§ï¼‰: ã™ã¹ã¦æˆåŠŸã™ã‚‹ã‹ã€ã™ã¹ã¦å¤±æ•—ã™ã‚‹ã‹
@Transactional
public void transferMoney(Long fromAccountId, Long toAccountId, BigDecimal amount) {
    // å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰: éƒ¨åˆ†çš„ãªæˆåŠŸãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§
    accountService.debit(fromAccountId, amount);
    // ã“ã“ã§ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹ã¨ã€å€Ÿæ–¹ã®ã¿ãŒå®Ÿè¡Œã•ã‚Œã‚‹ï¼ˆä¸æ•´åˆï¼‰
    accountService.credit(toAccountId, amount);
}

// è§£æ±º: @Transactionalã«ã‚ˆã‚Šã€ä¾‹å¤–ç™ºç”Ÿæ™‚ã«è‡ªå‹•çš„ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
@Transactional
public void transferMoney(Long fromAccountId, Long toAccountId, BigDecimal amount) {
    accountService.debit(fromAccountId, amount);
    accountService.credit(toAccountId, amount);
    // ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹ã¨ã€ä¸¡æ–¹ã®æ“ä½œãŒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã‚‹
}

// Consistencyï¼ˆä¸€è²«æ€§ï¼‰: ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãŒä¿ãŸã‚Œã‚‹
@Transactional
public void createOrderWithInventory(OrderRequest request) {
    Order order = orderRepository.save(createOrder(request));
    // åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã€æ³¨æ–‡ã‚‚ä½œæˆã•ã‚Œãªã„ï¼ˆä¸€è²«æ€§ãŒä¿ãŸã‚Œã‚‹ï¼‰
    inventoryService.reduceStock(order.getItems());
}

// Isolationï¼ˆåˆ†é›¢æ€§ï¼‰: åŒæ™‚å®Ÿè¡Œæ™‚ã®å¹²æ¸‰ã‚’é˜²ã
@Transactional(isolation = Isolation.READ_COMMITTED)
public void updateBalance(Long accountId, BigDecimal amount) {
    // ä»–ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã®æœªã‚³ãƒŸãƒƒãƒˆã®å¤‰æ›´ã¯è¦‹ãˆãªã„
    Account account = accountRepository.findById(accountId);
    account.setBalance(account.getBalance().add(amount));
    accountRepository.save(account);
}

// Durabilityï¼ˆæ°¸ç¶šæ€§ï¼‰: ã‚³ãƒŸãƒƒãƒˆã•ã‚ŒãŸå¤‰æ›´ã¯å¤±ã‚ã‚Œãªã„
@Transactional
public void saveCriticalData(CriticalData data) {
    // ã‚³ãƒŸãƒƒãƒˆå¾Œã€ã‚·ã‚¹ãƒ†ãƒ éšœå®³ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã•ã‚Œã‚‹
    criticalDataRepository.save(data);
}
```

#### ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã®è¨­è¨ˆåˆ¤æ–­

**ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã‚’ã©ã“ã«ç½®ãã¹ãã‹:**

```java
// å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•ŒãŒä¸é©åˆ‡
@Service
public class OrderService {
    
    // å•é¡Œ1: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒç´°ã‹ã™ãã‚‹
    @Transactional
    public void createOrder(OrderRequest request) {
        Order order = orderRepository.save(createOrder(request));
        // å•é¡Œ: å„æ“ä½œãŒåˆ¥ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
        processPayment(order.getId(), request.getAmount());  // åˆ¥ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
        updateInventory(order.getItems());  // åˆ¥ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
    }
    
    @Transactional
    public void processPayment(Long orderId, BigDecimal amount) {
        // ç‹¬ç«‹ã—ãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
    }
    
    // å•é¡Œ2: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒå¤§ãã™ãã‚‹
    @Transactional
    public void processMonthlyReport() {
        // å•é¡Œ: é•·æ™‚é–“å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã‚’ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œ
        List<Order> orders = orderRepository.findAll();  // 10ä¸‡ä»¶å–å¾—
        for (Order order : orders) {
            processOrder(order);  // å„å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã‚‹
        }
        // çµæœ: é•·æ™‚é–“ãƒ­ãƒƒã‚¯ãŒä¿æŒã•ã‚Œã€ä»–ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ–ãƒ­ãƒƒã‚¯
    }
}

// è§£æ±º: é©åˆ‡ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã®è¨­è¨ˆ
@Service
public class OrderService {
    
    // è§£æ±º1: ãƒ“ã‚¸ãƒã‚¹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦1ã¤ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«ã¾ã¨ã‚ã‚‹
    @Transactional
    public void createOrder(OrderRequest request) {
        Order order = orderRepository.save(createOrder(request));
        
        // åŒã˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œ
        processPaymentInternal(order.getId(), request.getAmount());
        updateInventoryInternal(order.getItems());
        
        // ã™ã¹ã¦æˆåŠŸã™ã‚‹ã‹ã€ã™ã¹ã¦å¤±æ•—ã™ã‚‹ã‹
    }
    
    // å†…éƒ¨ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ–°è¦ä½œæˆã—ãªã„ï¼‰
    private void processPaymentInternal(Long orderId, BigDecimal amount) {
        // è¦ªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å‚åŠ 
    }
    
    // è§£æ±º2: é•·æ™‚é–“å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤–ã§å®Ÿè¡Œ
    @Transactional
    public void processMonthlyReport() {
        // 1. ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆçŸ­ã„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
        List<Long> orderIds = orderRepository.findAllIds();
        
        // 2. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤–ã§å‡¦ç†
        processOrdersInBatches(orderIds);
    }
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void processOrdersInBatches(List<Long> orderIds) {
        // ãƒãƒƒãƒã”ã¨ã«ç‹¬ç«‹ã—ãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
        int batchSize = 1000;
        for (int i = 0; i < orderIds.size(); i += batchSize) {
            List<Long> batch = orderIds.subList(i, Math.min(i + batchSize, orderIds.size()));
            processBatch(batch);
        }
    }
    
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void processBatch(List<Long> orderIds) {
        // å„ãƒãƒƒãƒã¯ç‹¬ç«‹ã—ãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
        // 1ã¤ã®ãƒãƒƒãƒãŒå¤±æ•—ã—ã¦ã‚‚ã€ä»–ã®ãƒãƒƒãƒã«ã¯å½±éŸ¿ã—ãªã„
    }
}
```

## ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ¶å¾¡

Spring Frameworkã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚’ä¿è¨¼ã™ã‚‹ãŸã‚ã®é‡è¦ãªæ©Ÿèƒ½ã§ã™ã€‚ã“ã®ç« ã§ã¯ã€Springã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ¶å¾¡ã®è©³ç´°ãªè¨­å®šæ–¹æ³•ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

### @Transactionalã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®åŸºæœ¬

`@Transactional`ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€ãƒ¡ã‚½ãƒƒãƒ‰ã‚„ã‚¯ãƒ©ã‚¹ã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã‚’é©ç”¨ã—ã¾ã™ã€‚

```java
@Service
@Transactional
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    public User createUser(User user) {
        return userRepository.save(user);
    }
}
```

### ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ä¼æ’­å‹•ä½œï¼ˆPropagationï¼‰

ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ä¼æ’­å‹•ä½œã¯ã€æ—¢å­˜ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã®å‹•ä½œã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private OrderService orderService;
    
    // REQUIRED: æ—¢å­˜ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å‚åŠ ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    @Transactional(propagation = Propagation.REQUIRED)
    public User createUserWithOrder(User user, Order order) {
        User savedUser = userRepository.save(user);
        orderService.createOrder(order);  // åŒã˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œ
        return savedUser;
    }
    
    // REQUIRES_NEW: å¸¸ã«æ–°ã—ã„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void logUserActivity(Long userId, String activity) {
        // ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯ç‹¬ç«‹ã—ãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œã•ã‚Œã‚‹
        // å¤–å´ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã¦ã‚‚ã€ã“ã®ãƒ­ã‚°ã¯ä¿å­˜ã•ã‚Œã‚‹
        activityLogRepository.save(new ActivityLog(userId, activity));
    }
    
    // SUPPORTS: æ—¢å­˜ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å‚åŠ ã€ãªã‘ã‚Œã°ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãªã—ã§å®Ÿè¡Œ
    @Transactional(propagation = Propagation.SUPPORTS)
    public User findUser(Long id) {
        return userRepository.findById(id).orElse(null);
    }
    
    // NOT_SUPPORTED: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¸€æ™‚åœæ­¢ã—ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãªã—ã§å®Ÿè¡Œ
    @Transactional(propagation = Propagation.NOT_SUPPORTED)
    public void sendEmail(String to, String subject, String body) {
        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤–ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€é•·æ™‚é–“ã‹ã‹ã‚‹å‡¦ç†ã«é©ã—ã¦ã„ã‚‹
        emailService.send(to, subject, body);
    }
    
    // MANDATORY: æ—¢å­˜ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…é ˆã€‚ãªã‘ã‚Œã°ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼
    @Transactional(propagation = Propagation.MANDATORY)
    public void updateUserStatus(Long userId, UserStatus status) {
        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
        User user = userRepository.findById(userId).orElseThrow();
        user.setStatus(status);
        userRepository.save(user);
    }
    
    // NEVER: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¦ã¯ã„ã‘ãªã„ã€‚å­˜åœ¨ã™ã‚Œã°ä¾‹å¤–ã‚’ã‚¹ãƒ­ãƒ¼
    @Transactional(propagation = Propagation.NEVER)
    public void performNonTransactionalOperation() {
        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤–ã§å®Ÿè¡Œã•ã‚Œã‚‹å¿…è¦ãŒã‚ã‚‹å‡¦ç†
    }
    
    // NESTED: ãƒã‚¹ãƒˆã•ã‚ŒãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½œæˆï¼ˆä¸€éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã¿å¯¾å¿œï¼‰
    @Transactional(propagation = Propagation.NESTED)
    public void processOrderWithNestedTransaction(Order order) {
        // å¤–å´ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã¦ã‚‚ã€
        // ã“ã®ãƒ¡ã‚½ãƒƒãƒ‰å†…ã®å‡¦ç†ã¯å€‹åˆ¥ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¯èƒ½
    }
}
```

### ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®åˆ†é›¢ãƒ¬ãƒ™ãƒ«ï¼ˆIsolationï¼‰

åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã¯ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–“ã§ã®ãƒ‡ãƒ¼ã‚¿ã®å¯è¦–æ€§ã‚’åˆ¶å¾¡ã—ã¾ã™ã€‚

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    // READ_UNCOMMITTED: æœªã‚³ãƒŸãƒƒãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚‚èª­ã¿å–ã‚Šå¯èƒ½ï¼ˆæœ€ä½ãƒ¬ãƒ™ãƒ«ï¼‰
    @Transactional(isolation = Isolation.READ_UNCOMMITTED)
    public User findUserUncommitted(Long id) {
        return userRepository.findById(id).orElse(null);
    }
    
    // READ_COMMITTED: ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿èª­ã¿å–ã‚Šå¯èƒ½ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public User findUserCommitted(Long id) {
        return userRepository.findById(id).orElse(null);
    }
    
    // REPEATABLE_READ: åŒã˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§åŒã˜ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã—ã¦ã‚‚åŒã˜çµæœ
    @Transactional(isolation = Isolation.REPEATABLE_READ)
    public User findUserRepeatable(Long id) {
        return userRepository.findById(id).orElse(null);
    }
    
    // SERIALIZABLE: æœ€é«˜ãƒ¬ãƒ™ãƒ«ã€‚å®Œå…¨ã«åˆ†é›¢ã•ã‚Œã‚‹
    @Transactional(isolation = Isolation.SERIALIZABLE)
    public void performCriticalOperation() {
        // æœ€ã‚‚å³æ ¼ãªåˆ†é›¢ãƒ¬ãƒ™ãƒ«ãŒå¿…è¦ãªå‡¦ç†
    }
}
```

### èª­ã¿å–ã‚Šå°‚ç”¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³

èª­ã¿å–ã‚Šå°‚ç”¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æœ€é©åŒ–ã¨æ„å›³ã®æ˜ç¢ºåŒ–ã«å½¹ç«‹ã¡ã¾ã™ã€‚

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    // èª­ã¿å–ã‚Šå°‚ç”¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
    @Transactional(readOnly = true)
    public List<User> findAllUsers() {
        return userRepository.findAll();
    }
    
    @Transactional(readOnly = true)
    public User findUserById(Long id) {
        return userRepository.findById(id).orElseThrow();
    }
    
    // æ›¸ãè¾¼ã¿å¯èƒ½ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
    @Transactional(readOnly = false)
    public User createUser(User user) {
        return userRepository.save(user);
    }
}
```

### ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š

ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€é•·æ™‚é–“å®Ÿè¡Œã•ã‚Œã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’é˜²æ­¢ã§ãã¾ã™ã€‚

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’10ç§’ã«è¨­å®š
    @Transactional(timeout = 10)
    public void processLargeBatch(List<User> users) {
        for (User user : users) {
            userRepository.save(user);
        }
    }
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆapplication.propertiesï¼‰
    // spring.transaction.default-timeout=30
}
```

### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š

ç‰¹å®šã®ä¾‹å¤–ãŒç™ºç”Ÿã—ãŸå ´åˆã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹•ä½œã‚’åˆ¶å¾¡ã§ãã¾ã™ã€‚

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: RuntimeExceptionã¨Errorã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    @Transactional
    public User createUser(User user) {
        return userRepository.save(user);
    }
    
    // ç‰¹å®šã®ä¾‹å¤–ã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    @Transactional(rollbackFor = {IllegalArgumentException.class, NullPointerException.class})
    public User createUserWithValidation(User user) {
        if (user == null) {
            throw new IllegalArgumentException("User cannot be null");
        }
        return userRepository.save(user);
    }
    
    // ãƒã‚§ãƒƒã‚¯ä¾‹å¤–ã§ã‚‚ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    @Transactional(rollbackFor = Exception.class)
    public User createUserWithCheckedException(User user) throws UserCreationException {
        try {
            return userRepository.save(user);
        } catch (Exception e) {
            throw new UserCreationException("Failed to create user", e);
        }
    }
    
    // ç‰¹å®šã®ä¾‹å¤–ã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ãªã„
    @Transactional(noRollbackFor = {DuplicateUserException.class})
    public User createUserIgnoreDuplicate(User user) {
        try {
            return userRepository.save(user);
        } catch (DuplicateUserException e) {
            // ã“ã®ä¾‹å¤–ã§ã¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ãªã„
            return findUserByEmail(user.getEmail());
        }
    }
}
```

### ãƒ—ãƒ­ã‚°ãƒ©ãƒ çš„ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ¶å¾¡

ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ãªãã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ çš„ã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ¶å¾¡ã™ã‚‹å ´åˆã€‚

```java
@Service
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private TransactionTemplate transactionTemplate;
    
    @Autowired
    private PlatformTransactionManager transactionManager;
    
    // TransactionTemplateã‚’ä½¿ç”¨
    public User createUserWithTemplate(User user) {
        return transactionTemplate.execute(status -> {
            try {
                return userRepository.save(user);
            } catch (Exception e) {
                status.setRollbackOnly();
                throw e;
            }
        });
    }
    
    // PlatformTransactionManagerã‚’ç›´æ¥ä½¿ç”¨
    public User createUserWithManager(User user) {
        TransactionDefinition definition = new DefaultTransactionDefinition();
        TransactionStatus status = transactionManager.getTransaction(definition);
        
        try {
            User savedUser = userRepository.save(user);
            transactionManager.commit(status);
            return savedUser;
        } catch (Exception e) {
            transactionManager.rollback(status);
            throw e;
        }
    }
}
```

### ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

#### 1. ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ãƒ¬ãƒ™ãƒ«ã§ã®è¨­å®š

```java
@Service
@Transactional(
    readOnly = true,                    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’èª­ã¿å–ã‚Šå°‚ç”¨ã«
    timeout = 30,                       // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    isolation = Isolation.READ_COMMITTED  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆ†é›¢ãƒ¬ãƒ™ãƒ«
)
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    // èª­ã¿å–ã‚Šå°‚ç”¨ï¼ˆã‚¯ãƒ©ã‚¹ãƒ¬ãƒ™ãƒ«ã®è¨­å®šã‚’ç¶™æ‰¿ï¼‰
    public List<User> findAllUsers() {
        return userRepository.findAll();
    }
    
    // æ›¸ãè¾¼ã¿å¯èƒ½ï¼ˆãƒ¡ã‚½ãƒƒãƒ‰ãƒ¬ãƒ™ãƒ«ã§ä¸Šæ›¸ãï¼‰
    @Transactional(readOnly = false)
    public User createUser(User user) {
        return userRepository.save(user);
    }
}
```

#### 2. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã®é©åˆ‡ãªé…ç½®

```java
// è‰¯ã„ä¾‹: ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’é…ç½®
@Service
@Transactional
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    public User createUserWithOrders(User user, List<Order> orders) {
        User savedUser = userRepository.save(user);
        for (Order order : orders) {
            order.setUser(savedUser);
            orderRepository.save(order);
        }
        return savedUser;
    }
}

// æ‚ªã„ä¾‹: ãƒªãƒã‚¸ãƒˆãƒªã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’é…ç½®
@Repository
@Transactional  // ãƒªãƒã‚¸ãƒˆãƒªå±¤ã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’é…ç½®ã—ãªã„
public interface UserRepository extends JpaRepository<User, Long> {
    // ...
}
```

#### 3. è‡ªå·±å‘¼ã³å‡ºã—ã®å•é¡Œ

```java
@Service
@Transactional
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    // å•é¡Œ: åŒã˜ã‚¯ãƒ©ã‚¹å†…ã®ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã§ã¯@TransactionalãŒåŠ¹ã‹ãªã„
    public void processUser(Long userId) {
        updateUserStatus(userId, UserStatus.PROCESSING);  // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒåŠ¹ã‹ãªã„
    }
    
    @Transactional
    public void updateUserStatus(Long userId, UserStatus status) {
        User user = userRepository.findById(userId).orElseThrow();
        user.setStatus(status);
        userRepository.save(user);
    }
    
    // è§£æ±ºç­–1: åˆ¥ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã«åˆ†é›¢
    // è§£æ±ºç­–2: ApplicationContextã‹ã‚‰å–å¾—ã—ãŸãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨
    @Autowired
    private ApplicationContext applicationContext;
    
    public void processUserFixed(Long userId) {
        UserService self = applicationContext.getBean(UserService.class);
        self.updateUserStatus(userId, UserStatus.PROCESSING);  // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒåŠ¹ã
    }
    
    // è§£æ±ºç­–3: @Asyncã¨çµ„ã¿åˆã‚ã›ã‚‹
    @Async
    @Transactional
    public CompletableFuture<Void> updateUserStatusAsync(Long userId, UserStatus status) {
        updateUserStatus(userId, status);
        return CompletableFuture.completedFuture(null);
    }
}
```

#### 4. è¤‡æ•°ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†

```java
@Configuration
public class TransactionConfig {
    
    @Bean
    @Primary
    public PlatformTransactionManager primaryTransactionManager(
            @Qualifier("primaryDataSource") DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
    
    @Bean
    public PlatformTransactionManager secondaryTransactionManager(
            @Qualifier("secondaryDataSource") DataSource dataSource) {
        return new DataSourceTransactionManager(dataSource);
    }
}

@Service
public class UserService {
    
    @Autowired
    @Qualifier("primaryTransactionManager")
    private PlatformTransactionManager primaryTransactionManager;
    
    @Autowired
    @Qualifier("secondaryTransactionManager")
    private PlatformTransactionManager secondaryTransactionManager;
    
    @Transactional(transactionManager = "primaryTransactionManager")
    public User createUserInPrimary(User user) {
        return userRepository.save(user);
    }
    
    @Transactional(transactionManager = "secondaryTransactionManager")
    public void logInSecondary(String message) {
        logRepository.save(new Log(message));
    }
    
    // ãƒãƒ£ãƒ³ã‚¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆè¤‡æ•°ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ï¼‰
    public void createUserWithLog(User user, String logMessage) {
        TransactionTemplate primaryTemplate = new TransactionTemplate(primaryTransactionManager);
        TransactionTemplate secondaryTemplate = new TransactionTemplate(secondaryTransactionManager);
        
        primaryTemplate.execute(status -> {
            userRepository.save(user);
            secondaryTemplate.execute(s -> {
                logRepository.save(new Log(logMessage));
                return null;
            });
            return null;
        });
    }
}
```

#### 5. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã®æ´»ç”¨

```java
@Service
@Transactional
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    public User createUser(User user) {
        User savedUser = userRepository.save(user);
        
        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒŸãƒƒãƒˆå¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
        TransactionSynchronizationManager.registerSynchronization(
            new TransactionSynchronizationAdapter() {
                @Override
                public void afterCommit() {
                    eventPublisher.publishEvent(new UserCreatedEvent(savedUser.getId()));
                }
            }
        );
        
        return savedUser;
    }
}

// ã¾ãŸã¯@TransactionalEventListenerã‚’ä½¿ç”¨
@Component
public class UserEventListener {
    
    @TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)
    public void handleUserCreated(UserCreatedEvent event) {
        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒŸãƒƒãƒˆå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹
        System.out.println("User created: " + event.getUserId());
    }
}
```

### ãƒ‡ãƒãƒƒã‚°ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

```java
@Service
@Transactional
public class UserService {
    
    @Autowired
    private UserRepository userRepository;
    
    public User createUser(User user) {
        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’ç¢ºèª
        boolean isActive = TransactionSynchronizationManager.isActualTransactionActive();
        boolean isReadOnly = TransactionSynchronizationManager.isCurrentTransactionReadOnly();
        String transactionName = TransactionSynchronizationManager.getCurrentTransactionName();
        
        System.out.println("Transaction active: " + isActive);
        System.out.println("Transaction read-only: " + isReadOnly);
        System.out.println("Transaction name: " + transactionName);
        
        return userRepository.save(user);
    }
}
```

### ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è¨­è¨ˆã®æ„æ€æ±ºå®šãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯

#### ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã®è¨­è¨ˆåˆ¤æ–­

**åˆ¤æ–­åŸºæº–:**

```java
// 1. ãƒ“ã‚¸ãƒã‚¹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å˜ä½ã‚’ç‰¹å®š
// ã€Œã“ã®æ“ä½œã¯ã€ã™ã¹ã¦æˆåŠŸã™ã‚‹ã‹ã€ã™ã¹ã¦å¤±æ•—ã™ã‚‹ã¹ãã‹ï¼Ÿã€

// ä¾‹: æ³¨æ–‡ä½œæˆ
// - æ³¨æ–‡ã®ä½œæˆ
// - åœ¨åº«ã®æ¸›å°‘
// - æ±ºæ¸ˆå‡¦ç†
// â†’ ã“ã‚Œã‚‰ã¯1ã¤ã®ãƒ“ã‚¸ãƒã‚¹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¨ã—ã¦æ‰±ã†ã¹ã

@Transactional
public Order createOrder(OrderRequest request) {
    // ã™ã¹ã¦æˆåŠŸã™ã‚‹ã‹ã€ã™ã¹ã¦å¤±æ•—ã™ã‚‹ã‹
    Order order = orderRepository.save(createOrder(request));
    inventoryService.reduceStock(order.getItems());
    paymentService.processPayment(order.getId(), request.getAmount());
    return order;
}

// 2. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚µã‚¤ã‚ºã‚’æœ€é©åŒ–
// ã€Œã“ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯ã©ã®ãã‚‰ã„ã®æ™‚é–“ãŒã‹ã‹ã‚‹ã‹ï¼Ÿã€

// å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰: é•·æ™‚é–“å®Ÿè¡Œã•ã‚Œã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
@Transactional
public void processLargeBatch(List<Data> dataList) {
    for (Data data : dataList) {  // 10ä¸‡ä»¶
        processData(data);  // å„å‡¦ç†ã«10ms
        // åˆè¨ˆ: 1000ç§’ï¼ˆ16åˆ†ä»¥ä¸Šï¼‰
        // å•é¡Œ: é•·æ™‚é–“ãƒ­ãƒƒã‚¯ãŒä¿æŒã•ã‚Œã‚‹
    }
}

// è§£æ±º: ãƒãƒƒãƒå‡¦ç†ã«åˆ†å‰²
public void processLargeBatchOptimized(List<Data> dataList) {
    int batchSize = 1000;
    for (int i = 0; i < dataList.size(); i += batchSize) {
        List<Data> batch = dataList.subList(i, Math.min(i + batchSize, dataList.size()));
        processBatch(batch);  // å„ãƒãƒƒãƒã¯ç‹¬ç«‹ã—ãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
    }
}

@Transactional(propagation = Propagation.REQUIRES_NEW)
public void processBatch(List<Data> batch) {
    for (Data data : batch) {
        processData(data);
    }
    // å„ãƒãƒƒãƒã¯10ç§’ç¨‹åº¦ã§å®Œäº†
}
```

#### åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã®é¸æŠåˆ¤æ–­

**åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•:**

| åˆ†é›¢ãƒ¬ãƒ™ãƒ« | ãƒ€ãƒ¼ãƒ†ã‚£ãƒªãƒ¼ãƒ‰ | ãƒãƒ³ãƒªãƒ”ãƒ¼ã‚¿ãƒ–ãƒ«ãƒªãƒ¼ãƒ‰ | ãƒ•ã‚¡ãƒ³ãƒˆãƒ ãƒªãƒ¼ãƒ‰ | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | é©ç”¨ç¯„å›² |
|-----------|--------------|-------------------|---------------|-------------|---------|
| **READ_UNCOMMITTED** | å¯èƒ½ | å¯èƒ½ | å¯èƒ½ | æœ€é«˜ | éæ¨å¥¨ |
| **READ_COMMITTED** | ä¸å¯ | å¯èƒ½ | å¯èƒ½ | é«˜ã„ | ä¸€èˆ¬çš„ |
| **REPEATABLE_READ** | ä¸å¯ | ä¸å¯ | å¯èƒ½ | ä¸­ç¨‹åº¦ | é‡è¦ãªãƒ‡ãƒ¼ã‚¿ |
| **SERIALIZABLE** | ä¸å¯ | ä¸å¯ | ä¸å¯ | ä½ã„ | æœ€é«˜ã®ä¸€è²«æ€§ãŒå¿…è¦ |

**å®Ÿè·µçš„ãªé¸æŠæŒ‡é‡:**

```java
// READ_COMMITTEDã‚’é¸ã¶ã¹ãå ´åˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã€æ¨å¥¨ï¼‰
// - ã»ã¨ã‚“ã©ã®Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
// - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ä¸€è²«æ€§ã®ãƒãƒ©ãƒ³ã‚¹ãŒé‡è¦
@Transactional(isolation = Isolation.READ_COMMITTED)
public void updateUserBalance(Long userId, BigDecimal amount) {
    // ä»–ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®æœªã‚³ãƒŸãƒƒãƒˆå¤‰æ›´ã¯è¦‹ãˆãªã„
    // ã‚³ãƒŸãƒƒãƒˆæ¸ˆã¿ã®å¤‰æ›´ã¯è¦‹ãˆã‚‹
}

// REPEATABLE_READã‚’é¸ã¶ã¹ãå ´åˆ
// - é‡‘èå–å¼•ãªã©ã€é«˜ã„ä¸€è²«æ€§ãŒå¿…è¦
// - åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’è¤‡æ•°å›èª­ã¿å–ã‚‹å¿…è¦ãŒã‚ã‚‹
@Transactional(isolation = Isolation.REPEATABLE_READ)
public void calculateAccountBalance(Long accountId) {
    // 1å›ç›®ã®èª­ã¿å–ã‚Š
    Account account1 = accountRepository.findById(accountId);
    
    // ä½•ã‚‰ã‹ã®å‡¦ç†
    doSomething();
    
    // 2å›ç›®ã®èª­ã¿å–ã‚Šï¼ˆåŒã˜å€¤ãŒä¿è¨¼ã•ã‚Œã‚‹ï¼‰
    Account account2 = accountRepository.findById(accountId);
    // account1.getBalance() == account2.getBalance() ãŒä¿è¨¼ã•ã‚Œã‚‹
}

// SERIALIZABLEã‚’é¸ã¶ã¹ãå ´åˆ
// - éå¸¸ã«é‡è¦ãªãƒ‡ãƒ¼ã‚¿ï¼ˆä¾‹: åœ¨åº«ç®¡ç†ï¼‰
// - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚ˆã‚Šã‚‚ä¸€è²«æ€§ã‚’å„ªå…ˆ
@Transactional(isolation = Isolation.SERIALIZABLE)
public void reserveInventory(Long productId, int quantity) {
    Product product = productRepository.findById(productId);
    if (product.getStock() < quantity) {
        throw new InsufficientStockException();
    }
    product.setStock(product.getStock() - quantity);
    productRepository.save(product);
    // ä»–ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ã®å¹²æ¸‰ãŒå®Œå…¨ã«é˜²ãŒã‚Œã‚‹
}
```

#### ä¼æ’­å‹•ä½œã®é¸æŠåˆ¤æ–­

**ä¼æ’­å‹•ä½œã®å®Ÿè·µçš„ãªä½¿ã„åˆ†ã‘:**

```java
@Service
public class OrderService {
    
    // REQUIREDï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰: é€šå¸¸ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
    @Transactional(propagation = Propagation.REQUIRED)
    public Order createOrder(OrderRequest request) {
        // æ—¢å­˜ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å‚åŠ ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆ
        return orderRepository.save(createOrder(request));
    }
    
    // REQUIRES_NEW: ãƒ­ã‚°ã‚„ç›£æŸ»ãªã©ã€ç‹¬ç«‹ã—ã¦å®Ÿè¡Œã™ã¹ãå‡¦ç†
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void logOrderCreation(Long orderId) {
        // æ³¨æ–‡ä½œæˆãŒå¤±æ•—ã—ã¦ã‚‚ã€ãƒ­ã‚°ã¯ä¿å­˜ã•ã‚Œã‚‹
        auditLogRepository.save(new AuditLog("ORDER_CREATED", orderId));
    }
    
    // SUPPORTS: èª­ã¿å–ã‚Šå°‚ç”¨ã®å‡¦ç†ï¼ˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°æœ€é©åŒ–ï¼‰
    @Transactional(propagation = Propagation.SUPPORTS, readOnly = true)
    public Order findOrder(Long id) {
        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å‚åŠ ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨æœ€é©åŒ–ï¼‰
        // ãªã‘ã‚Œã°ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãªã—ã§å®Ÿè¡Œ
        return orderRepository.findById(id).orElse(null);
    }
    
    // NOT_SUPPORTED: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¸€æ™‚åœæ­¢ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆ
    @Transactional(propagation = Propagation.NOT_SUPPORTED)
    public void sendNotification(Long orderId) {
        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä¸€æ™‚åœæ­¢ã—ã¦å®Ÿè¡Œ
        // é•·æ™‚é–“ã‹ã‹ã‚‹å¤–éƒ¨APIå‘¼ã³å‡ºã—ãªã©
        notificationService.send(orderId);
    }
    
    // MANDATORY: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
    @Transactional(propagation = Propagation.MANDATORY)
    public void updateOrderStatus(Long orderId, OrderStatus status) {
        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤–ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹ã¨ä¾‹å¤–
        // è¨­è¨ˆä¸Šã®åˆ¶ç´„ã‚’æ˜ç¢ºã«ã™ã‚‹
        Order order = orderRepository.findById(orderId).orElseThrow();
        order.setStatus(status);
        orderRepository.save(order);
    }
}
```

#### åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ä»£æ›¿ãƒ‘ã‚¿ãƒ¼ãƒ³

**Sagaãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…:**

```java
// å•é¡Œ: ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“ã§ã®åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯éæ¨å¥¨
// è§£æ±º: Sagaãƒ‘ã‚¿ãƒ¼ãƒ³ã§çµæœæ•´åˆæ€§ã‚’ä¿ã¤

public class OrderSaga {
    
    private final OrderService orderService;
    private final PaymentService paymentService;
    private final InventoryService inventoryService;
    
    @Transactional
    public void execute(OrderRequest request) {
        SagaContext context = new SagaContext();
        
        try {
            // Step 1: æ³¨æ–‡ä½œæˆ
            Order order = orderService.create(request);
            context.setOrderId(order.getId());
            
            // Step 2: æ±ºæ¸ˆå‡¦ç†
            Payment payment = paymentService.process(order.getId(), request.getAmount());
            context.setPaymentId(payment.getId());
            
            // Step 3: åœ¨åº«æ›´æ–°
            inventoryService.reduceStock(order.getItems());
            context.setInventoryReduced(true);
            
            // ã™ã¹ã¦æˆåŠŸ
            context.setCompleted(true);
            
        } catch (Exception e) {
            // è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
            compensate(context);
            throw new SagaExecutionException("Order creation failed", e);
        }
    }
    
    private void compensate(SagaContext context) {
        // é€†é †ã§è£œå„Ÿå‡¦ç†ã‚’å®Ÿè¡Œ
        if (context.isInventoryReduced()) {
            try {
                inventoryService.restoreStock(context.getOrderId());
            } catch (Exception e) {
                log.error("Failed to restore stock", e);
            }
        }
        
        if (context.getPaymentId() != null) {
            try {
                paymentService.refund(context.getPaymentId());
            } catch (Exception e) {
                log.error("Failed to refund payment", e);
            }
        }
        
        if (context.getOrderId() != null) {
            try {
                orderService.cancel(context.getOrderId());
            } catch (Exception e) {
                log.error("Failed to cancel order", e);
            }
        }
    }
}
```

### ã¾ã¨ã‚

ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ¶å¾¡ã®æ·±ã„ç†è§£ã«ãŠã„ã¦é‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼š

1. **ACIDç‰¹æ€§ã®å®Ÿè·µçš„ãªæ„å‘³**: å„ç‰¹æ€§ãŒå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã©ã®ã‚ˆã†ã«æ©Ÿèƒ½ã™ã‚‹ã‹
2. **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã®è¨­è¨ˆ**: ãƒ“ã‚¸ãƒã‚¹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å˜ä½ã‚’é©åˆ‡ã«å®šç¾©
3. **åˆ†é›¢ãƒ¬ãƒ™ãƒ«ã®é¸æŠ**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ä¸€è²«æ€§ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã‚’ç†è§£
4. **ä¼æ’­å‹•ä½œã®ä½¿ã„åˆ†ã‘**: å„ä¼æ’­å‹•ä½œã®å®Ÿè·µçš„ãªé©ç”¨ç¯„å›²
5. **åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ä»£æ›¿**: Sagaãƒ‘ã‚¿ãƒ¼ãƒ³ãªã©ã€çµæœæ•´åˆæ€§ã‚’ä¿ã¤æ–¹æ³•

é©åˆ‡ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ¶å¾¡ã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ä¿ã¡ãªãŒã‚‰ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚‚æœ€é©åŒ–ã§ãã¾ã™ã€‚ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¦ä»¶ã«å¿œã˜ã¦ã€æœ€é©ãªè¨­å®šã‚’é¸æŠã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

**ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦è€ƒæ…®ã™ã¹ãç‚¹:**

- **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å¿œã˜ãŸé¸æŠ**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç‰¹æ€§ã«å¿œã˜ã¦æœ€é©ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æˆ¦ç•¥ã‚’é¸æŠ
- **ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ã®ç†è§£**: ä¸€è²«æ€§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€è¤‡é›‘æ€§ã®ãƒãƒ©ãƒ³ã‚¹
- **è¨ˆæ¸¬ã«åŸºã¥ãæœ€é©åŒ–**: æ¨æ¸¬ã§ã¯ãªãã€å®Ÿéš›ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦åˆ¤æ–­
- **é•·æœŸçš„ãªä¿å®ˆæ€§**: çŸ­æœŸçš„ãªæœ€é©åŒ–ã§ã¯ãªãã€é•·æœŸçš„ã«ä¿å®ˆå¯èƒ½ãªè¨­è¨ˆã‚’é¸æŠ

