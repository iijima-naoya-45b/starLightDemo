---
title: "JpaRepositoryã®ä¸­èº«"
label: "JpaRepositoryã®ä¸­èº«"
---

## ğŸ’¾ JpaRepositoryã®ä¸­èº«

Spring Data JPAã®`JpaRepository`ã¯ã€`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹`æ“ä½œã‚’ç°¡æ½”ã«è¡Œã†ãŸã‚ã®å¼·åŠ›ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã™ã€‚ã“ã®ç« ã§ã¯ã€`JpaRepository`ã®å†…éƒ¨æ§‹é€ ã¨å‹•ä½œãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã«ã¤ã„ã¦è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

### ğŸ“‹ JpaRepositoryã®éšå±¤æ§‹é€ 

`JpaRepository`ã¯è¤‡æ•°ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ç¶™æ‰¿ã—ã¦ãŠã‚Šã€å„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒç•°ãªã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

```java
public interface JpaRepository<T, ID> extends PagingAndSortingRepository<T, ID>, QueryByExampleExecutor<T> {
    // JpaRepositoryå›ºæœ‰ã®ãƒ¡ã‚½ãƒƒãƒ‰
    List<T> findAll();
    List<T> findAll(Sort sort);
    List<T> findAllById(Iterable<ID> ids);
    <S extends T> List<S> saveAll(Iterable<S> entities);
    void flush();
    <S extends T> S saveAndFlush(S entity);
    void deleteInBatch(Iterable<T> entities);
    void deleteAllInBatch();
    T getOne(ID id);
    <S extends T> List<S> findAll(Example<S> example);
    <S extends T> List<S> findAll(Example<S> example, Sort sort);
}
```

#### ç¶™æ‰¿é–¢ä¿‚ã®è©³ç´°

1. **`Repository<T, ID>`**: ãƒãƒ¼ã‚«ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€‚Spring DataãŒãƒªãƒã‚¸ãƒˆãƒªã¨ã—ã¦èªè­˜ã™ã‚‹ãŸã‚ã®åŸºæº–ã¨ãªã‚Šã¾ã™ã€‚

2. **`CrudRepository<T, ID>`**: åŸºæœ¬çš„ãªCRUDæ“ä½œã‚’æä¾›ã—ã¾ã™ã€‚
   - `save(S entity)`: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä¿å­˜
   - `findById(ID id)`: IDã§æ¤œç´¢
   - `existsById(ID id)`: å­˜åœ¨ç¢ºèª
   - `count()`: ä»¶æ•°å–å¾—
   - `deleteById(ID id)`: IDã§å‰Šé™¤
   - `delete(T entity)`: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§å‰Šé™¤
   - `deleteAll()`: å…¨å‰Šé™¤

3. **`PagingAndSortingRepository<T, ID>`**: ãƒšãƒ¼ã‚¸ãƒ³ã‚°ã¨ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚
   - `findAll(Sort sort)`: ã‚½ãƒ¼ãƒˆæŒ‡å®šã§å…¨ä»¶å–å¾—
   - `findAll(Pageable pageable)`: ãƒšãƒ¼ã‚¸ãƒ³ã‚°æŒ‡å®šã§å–å¾—

4. **`QueryByExampleExecutor<T>`**: Exampleã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

### ãƒ¡ã‚½ãƒƒãƒ‰åã«ã‚ˆã‚‹ã‚¯ã‚¨ãƒªç”Ÿæˆ

Spring Data JPAã®æœ€ã‚‚å¼·åŠ›ãªæ©Ÿèƒ½ã®ä¸€ã¤ãŒã€ãƒ¡ã‚½ãƒƒãƒ‰åã‹ã‚‰è‡ªå‹•çš„ã«ã‚¯ã‚¨ãƒªã‚’ç”Ÿæˆã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚

#### åŸºæœ¬çš„ãªå‘½åè¦å‰‡

```java
public interface UserRepository extends JpaRepository<User, Long> {
    // å˜ç´”ãªæ¤œç´¢
    List<User> findByName(String name);
    User findByEmail(String email);
    
    // è¤‡æ•°æ¡ä»¶
    List<User> findByNameAndEmail(String name, String email);
    List<User> findByNameOrEmail(String name, String email);
    
    // æ¯”è¼ƒæ¼”ç®—å­
    List<User> findByAgeGreaterThan(int age);
    List<User> findByAgeLessThan(int age);
    List<User> findByAgeBetween(int minAge, int maxAge);
    
    // Nullãƒã‚§ãƒƒã‚¯
    List<User> findByEmailIsNotNull();
    List<User> findByEmailIsNull();
    
    // Likeæ¤œç´¢
    List<User> findByNameContaining(String name);
    List<User> findByNameLike(String name);
    List<User> findByNameStartingWith(String prefix);
    List<User> findByNameEndingWith(String suffix);
    
    // ã‚½ãƒ¼ãƒˆ
    List<User> findByNameOrderByAgeAsc(String name);
    List<User> findByNameOrderByAgeDesc(String name);
    
    // ä»¶æ•°åˆ¶é™
    User findFirstByName(String name);
    User findTopByName(String name);
    List<User> findTop10ByName(String name);
}
```

#### é–¢é€£ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®æ¤œç´¢

```java
public interface UserRepository extends JpaRepository<User, Long> {
    // é–¢é€£ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§æ¤œç´¢
    List<User> findByAddressCity(String city);
    List<User> findByAddressZipCode(String zipCode);
    
    // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³é–¢é€£
    List<User> findByOrdersStatus(OrderStatus status);
    List<User> findByOrdersTotalAmountGreaterThan(BigDecimal amount);
}
```

### @Queryã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒª

ãƒ¡ã‚½ãƒƒãƒ‰åã«ã‚ˆã‚‹è‡ªå‹•ç”Ÿæˆã§ã¯å¯¾å¿œã§ããªã„è¤‡é›‘ãªã‚¯ã‚¨ãƒªã¯ã€`@Query`ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨ã—ã¦æ˜ç¤ºçš„ã«å®šç¾©ã§ãã¾ã™ã€‚

#### JPQLï¼ˆJava Persistence Query Languageï¼‰ã‚’ä½¿ç”¨

```java
public interface UserRepository extends JpaRepository<User, Long> {
    // JPQLã‚¯ã‚¨ãƒª
    @Query("SELECT u FROM User u WHERE u.email = ?1")
    User findByEmailAddress(String email);
    
    // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã«ã‚ˆã‚‹æŒ‡å®šï¼ˆæ¨å¥¨ï¼‰
    @Query("SELECT u FROM User u WHERE u.name = :name AND u.age > :age")
    List<User> findByNameAndAgeGreaterThan(@Param("name") String name, @Param("age") int age);
    
    // ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¯ã‚¨ãƒª
    @Query(value = "SELECT * FROM users WHERE email = ?1", nativeQuery = true)
    User findByEmailNative(String email);
    
    // æ›´æ–°ã‚¯ã‚¨ãƒª
    @Modifying
    @Query("UPDATE User u SET u.name = :name WHERE u.id = :id")
    int updateUserName(@Param("id") Long id, @Param("name") String name);
    
    // å‰Šé™¤ã‚¯ã‚¨ãƒª
    @Modifying
    @Query("DELETE FROM User u WHERE u.email = :email")
    int deleteByEmail(@Param("email") String email);
}
```

#### ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¯ã‚¨ãƒªã®æ³¨æ„ç‚¹

```java
public interface UserRepository extends JpaRepository<User, Long> {
    // ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¯ã‚¨ãƒªã§ã¯ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã§ã¯ãªãã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚«ãƒ©ãƒ åã‚’ä½¿ç”¨
    @Query(value = "SELECT u.id, u.name, u.email FROM users u WHERE u.age > :age", 
           nativeQuery = true)
    List<Object[]> findUsersByAgeNative(@Param("age") int age);
    
    // çµæœã‚’DTOã«ãƒãƒƒãƒ”ãƒ³ã‚°
    @Query(value = "SELECT new com.example.dto.UserDTO(u.id, u.name, u.email) " +
                   "FROM User u WHERE u.age > :age")
    List<UserDTO> findUsersByAgeAsDTO(@Param("age") int age);
}
```

### ãƒšãƒ¼ã‚¸ãƒ³ã‚°ã¨ã‚½ãƒ¼ãƒˆ

`JpaRepository`ã¯`PagingAndSortingRepository`ã‚’ç¶™æ‰¿ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒšãƒ¼ã‚¸ãƒ³ã‚°ã¨ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã‚’ç°¡å˜ã«ä½¿ç”¨ã§ãã¾ã™ã€‚

```java
public interface UserRepository extends JpaRepository<User, Long> {
    // ãƒšãƒ¼ã‚¸ãƒ³ã‚°ãªã—ã®ã‚½ãƒ¼ãƒˆ
    List<User> findByName(String name, Sort sort);
    
    // ãƒšãƒ¼ã‚¸ãƒ³ã‚°ä»˜ãæ¤œç´¢
    Page<User> findByName(String name, Pageable pageable);
    
    // ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒªã§ã®ãƒšãƒ¼ã‚¸ãƒ³ã‚°
    @Query("SELECT u FROM User u WHERE u.age > :age")
    Page<User> findUsersByAge(@Param("age") int age, Pageable pageable);
}
```

#### ä½¿ç”¨ä¾‹

```java
@Service
public class UserService {
    @Autowired
    private UserRepository userRepository;
    
    public Page<User> getUsers(int page, int size, String sortBy) {
        Pageable pageable = PageRequest.of(page, size, Sort.by(sortBy).ascending());
        return userRepository.findAll(pageable);
    }
    
    public Page<User> searchUsers(String name, int page, int size) {
        Pageable pageable = PageRequest.of(page, size);
        return userRepository.findByName(name, pageable);
    }
}
```

### ãƒãƒƒãƒå‡¦ç†

`JpaRepository`ã¯ãƒãƒƒãƒå‡¦ç†ã®ãŸã‚ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚

```java
public interface UserRepository extends JpaRepository<User, Long> {
    // ãƒãƒƒãƒä¿å­˜
    <S extends T> List<S> saveAll(Iterable<S> entities);
    
    // ãƒãƒƒãƒå‰Šé™¤
    void deleteInBatch(Iterable<T> entities);
    void deleteAllInBatch();
}
```

#### ãƒãƒƒãƒå‡¦ç†ã®æœ€é©åŒ–

```java
@Service
public class UserService {
    @Autowired
    private UserRepository userRepository;
    
    @Transactional
    public void saveUsersInBatch(List<User> users) {
        // é€šå¸¸ã®saveAllã¯1ä»¶ãšã¤INSERTæ–‡ã‚’å®Ÿè¡Œ
        userRepository.saveAll(users);
        
        // ãƒãƒƒãƒã‚µã‚¤ã‚ºã‚’è¨­å®šã—ã¦æœ€é©åŒ–
        // application.propertiesã«ä»¥ä¸‹ã‚’è¿½åŠ :
        // spring.jpa.properties.hibernate.jdbc.batch_size=50
        // spring.jpa.properties.hibernate.order_inserts=true
        // spring.jpa.properties.hibernate.order_updates=true
    }
    
    @Transactional
    public void deleteUsersInBatch(List<User> users) {
        // ãƒãƒƒãƒå‰Šé™¤ï¼ˆINå¥ã‚’ä½¿ç”¨ï¼‰
        userRepository.deleteInBatch(users);
    }
}
```

### ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒã‚¸ãƒˆãƒªã®å®Ÿè£…

è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ãªå ´åˆã¯ã€ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒã‚¸ãƒˆãƒªã‚’å®Ÿè£…ã§ãã¾ã™ã€‚

#### ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®å®šç¾©

```java
public interface UserRepositoryCustom {
    List<User> findUsersWithComplexCriteria(String name, int minAge, String city);
    void bulkUpdateUserStatus(List<Long> userIds, UserStatus status);
}
```

#### å®Ÿè£…ã‚¯ãƒ©ã‚¹

```java
@Repository
public class UserRepositoryCustomImpl implements UserRepositoryCustom {
    @PersistenceContext
    private EntityManager entityManager;
    
    @Override
    public List<User> findUsersWithComplexCriteria(String name, int minAge, String city) {
        CriteriaBuilder cb = entityManager.getCriteriaBuilder();
        CriteriaQuery<User> query = cb.createQuery(User.class);
        Root<User> root = query.from(User.class);
        
        List<Predicate> predicates = new ArrayList<>();
        
        if (name != null) {
            predicates.add(cb.like(root.get("name"), "%" + name + "%"));
        }
        if (minAge > 0) {
            predicates.add(cb.greaterThanOrEqualTo(root.get("age"), minAge));
        }
        if (city != null) {
            predicates.add(cb.equal(root.get("address").get("city"), city));
        }
        
        query.where(predicates.toArray(new Predicate[0]));
        return entityManager.createQuery(query).getResultList();
    }
    
    @Override
    @Transactional
    public void bulkUpdateUserStatus(List<Long> userIds, UserStatus status) {
        String jpql = "UPDATE User u SET u.status = :status WHERE u.id IN :ids";
        entityManager.createQuery(jpql)
            .setParameter("status", status)
            .setParameter("ids", userIds)
            .executeUpdate();
    }
}
```

#### ãƒªãƒã‚¸ãƒˆãƒªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®æ‹¡å¼µ

```java
public interface UserRepository extends JpaRepository<User, Long>, UserRepositoryCustom {
    // JpaRepositoryã®ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ã‚½ãƒƒãƒ‰ã®ä¸¡æ–¹ãŒä½¿ç”¨å¯èƒ½
}
```

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³

å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã ã‘ã‚’å–å¾—ã™ã‚‹ã“ã¨ã§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

#### ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãƒ™ãƒ¼ã‚¹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³

```java
public interface UserSummary {
    String getName();
    String getEmail();
    int getAge();
}

public interface UserRepository extends JpaRepository<User, Long> {
    List<UserSummary> findByName(String name);
    
    @Query("SELECT u.name as name, u.email as email FROM User u WHERE u.age > :age")
    List<UserSummary> findUsersByAge(@Param("age") int age);
}
```

#### DTOãƒ™ãƒ¼ã‚¹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³

```java
public class UserDTO {
    private String name;
    private String email;
    
    public UserDTO(String name, String email) {
        this.name = name;
        this.email = email;
    }
    
    // getter/setter
}

public interface UserRepository extends JpaRepository<User, Long> {
    @Query("SELECT new com.example.dto.UserDTO(u.name, u.email) FROM User u")
    List<UserDTO> findAllAsDTO();
}
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®ãƒã‚¤ãƒ³ãƒˆ

1. **N+1å•é¡Œã®å›é¿**: `@EntityGraph`ã‚„`JOIN FETCH`ã‚’ä½¿ç”¨ã—ã¦é–¢é€£ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä¸€åº¦ã«å–å¾—ã—ã¾ã™ã€‚

```java
public interface UserRepository extends JpaRepository<User, Long> {
    @EntityGraph(attributePaths = {"orders", "address"})
    List<User> findAll();
    
    @Query("SELECT u FROM User u JOIN FETCH u.orders WHERE u.id = :id")
    User findByIdWithOrders(@Param("id") Long id);
}
```

2. **é…å»¶ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã®åˆ¶å¾¡**: `@Transactional`ã‚’ä½¿ç”¨ã—ã¦ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§é–¢é€£ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

3. **ãƒãƒƒãƒã‚µã‚¤ã‚ºã®è¨­å®š**: `application.properties`ã§ãƒãƒƒãƒã‚µã‚¤ã‚ºã‚’è¨­å®šã—ã¦ã€ãƒãƒƒãƒå‡¦ç†ã‚’æœ€é©åŒ–ã—ã¾ã™ã€‚

```properties
spring.jpa.properties.hibernate.jdbc.batch_size=50
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true
```

### JPA Repositoryè¨­è¨ˆã®æ„æ€æ±ºå®š

#### ãƒ¡ã‚½ãƒƒãƒ‰åã‚¯ã‚¨ãƒª vs @Query vs ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒã‚¸ãƒˆãƒª

**é¸æŠã®åˆ¤æ–­åŸºæº–:**

```java
// 1. ãƒ¡ã‚½ãƒƒãƒ‰åã‚¯ã‚¨ãƒª: ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¯ã‚¨ãƒªã«é©ã—ã¦ã„ã‚‹
public interface UserRepository extends JpaRepository<User, Long> {
    // åˆ©ç‚¹: ã‚·ãƒ³ãƒ—ãƒ«ã€å‹å®‰å…¨ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«æ¤œè¨¼
    // æ¬ ç‚¹: è¤‡é›‘ãªã‚¯ã‚¨ãƒªã«ã¯ä¸å‘ã
    List<User> findByEmailAndStatus(String email, UserStatus status);
}

// 2. @Query: è¤‡é›‘ãªã‚¯ã‚¨ãƒªã‚„æœ€é©åŒ–ãŒå¿…è¦ãªå ´åˆ
public interface UserRepository extends JpaRepository<User, Long> {
    // åˆ©ç‚¹: æŸ”è»Ÿæ€§ãŒé«˜ã„ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ãŒå¯èƒ½
    // æ¬ ç‚¹: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚³ã‚¹ãƒˆãŒé«˜ã„
    @Query("SELECT u FROM User u WHERE u.email = :email " +
           "AND u.status = :status " +
           "AND u.createdAt > :since")
    List<User> findActiveUsersSince(@Param("email") String email,
                                    @Param("status") UserStatus status,
                                    @Param("since") LocalDateTime since);
}

// 3. ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒã‚¸ãƒˆãƒª: éå¸¸ã«è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã‚„å‹•çš„ã‚¯ã‚¨ãƒª
public interface UserRepositoryCustom {
    // åˆ©ç‚¹: æœ€å¤§ã®æŸ”è»Ÿæ€§ã€è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…å¯èƒ½
    // æ¬ ç‚¹: å®Ÿè£…ã‚³ã‚¹ãƒˆãŒé«˜ã„
    List<User> findUsersWithComplexCriteria(UserSearchCriteria criteria);
}

// åˆ¤æ–­åŸºæº–:
// - ã‚·ãƒ³ãƒ—ãƒ«ãªæ¡ä»¶: ãƒ¡ã‚½ãƒƒãƒ‰åã‚¯ã‚¨ãƒª
// - è¤‡é›‘ãªæ¡ä»¶ã‚„JOIN: @Query
// - å‹•çš„ã‚¯ã‚¨ãƒªã‚„è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯: ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒã‚¸ãƒˆãƒª
```

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®æ·±ã„ç†è§£

**N+1å•é¡Œã®æ ¹æœ¬åŸå› :**

```java
// å•é¡Œã®æœ¬è³ªã‚’ç†è§£ã™ã‚‹
@Service
public class OrderService {
    
    // N+1å•é¡Œã®ç™ºç”Ÿãƒ¡ã‚«ãƒ‹ã‚ºãƒ 
    public List<OrderDTO> getOrdersWithItems(Long customerId) {
        // 1å›ã®ã‚¯ã‚¨ãƒª: æ³¨æ–‡ã‚’å–å¾—
        List<Order> orders = orderRepository.findByCustomerId(customerId);
        // SQL: SELECT * FROM orders WHERE customer_id = ?
        // çµæœ: 10ä»¶ã®æ³¨æ–‡
        
        List<OrderDTO> dtos = new ArrayList<>();
        for (Order order : orders) {
            // Nå›ã®ã‚¯ã‚¨ãƒª: å„æ³¨æ–‡ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
            // å•é¡Œ: é…å»¶ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã«ã‚ˆã‚Šã€ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«ã‚¯ã‚¨ãƒªãŒå®Ÿè¡Œã•ã‚Œã‚‹
            List<OrderItem> items = order.getItems();  
            // SQL: SELECT * FROM order_items WHERE order_id = ?
            // 10ä»¶ã®æ³¨æ–‡ã«å¯¾ã—ã¦10å›ã®ã‚¯ã‚¨ãƒªãŒå®Ÿè¡Œã•ã‚Œã‚‹
            
            dtos.add(convertToDTO(order, items));
        }
        // åˆè¨ˆ: 1 + 10 = 11å›ã®ã‚¯ã‚¨ãƒªï¼ˆN+1å•é¡Œï¼‰
    }
}

// è§£æ±ºæ–¹æ³•ã®ç†è§£
@Service
public class OrderService {
    
    // è§£æ±º1: JOIN FETCHï¼ˆæœ€ã‚‚åŠ¹ç‡çš„ï¼‰
    public List<OrderDTO> getOrdersWithItemsOptimized(Long customerId) {
        // 1å›ã®ã‚¯ã‚¨ãƒªã§æ³¨æ–‡ã¨ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
        List<Order> orders = orderRepository.findByCustomerIdWithItems(customerId);
        // SQL: SELECT o.*, i.* FROM orders o 
        //      LEFT JOIN order_items i ON o.id = i.order_id
        //      WHERE o.customer_id = ?
        // 1å›ã®ã‚¯ã‚¨ãƒªã§å®Œäº†
        
        return orders.stream()
            .map(order -> convertToDTO(order, order.getItems()))
            .collect(Collectors.toList());
    }
    
    // è§£æ±º2: ãƒãƒƒãƒãƒ•ã‚§ãƒƒãƒï¼ˆè¤‡æ•°ã®è¦ªã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒã‚ã‚‹å ´åˆï¼‰
    public List<OrderDTO> getOrdersWithItemsBatch(Long customerId) {
        List<Order> orders = orderRepository.findByCustomerId(customerId);
        // æ³¨æ–‡ã‚’å–å¾—å¾Œã€ãƒãƒƒãƒã§ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
        // SQL: SELECT * FROM order_items 
        //      WHERE order_id IN (?, ?, ?, ...)
        // 2å›ã®ã‚¯ã‚¨ãƒªã§å®Œäº†ï¼ˆ1 + 1 = 2ï¼‰
        
        return orders.stream()
            .map(order -> convertToDTO(order, order.getItems()))
            .collect(Collectors.toList());
    }
}
```

**ã‚¯ã‚¨ãƒªæœ€é©åŒ–ã®åˆ¤æ–­:**

```java
// å•é¡Œ: ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‹ã‚‰ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
@Query("SELECT u FROM User u")
List<User> findAllUsers();

// è§£æ±º: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å´ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
@Query("SELECT u FROM User u WHERE u.status = :status")
List<User> findUsersByStatus(@Param("status") UserStatus status);

// å•é¡Œ: ä¸è¦ãªã‚«ãƒ©ãƒ ã‚’å–å¾—
@Query("SELECT u FROM User u")
List<User> findAllUsers();

// è§£æ±º: å¿…è¦ãªã‚«ãƒ©ãƒ ã®ã¿ã‚’å–å¾—ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
@Query("SELECT new com.example.dto.UserSummaryDTO(u.id, u.name, u.email) " +
       "FROM User u")
List<UserSummaryDTO> findUserSummaries();

// å•é¡Œ: å…¨ä»¶å–å¾—ã—ã¦ã‹ã‚‰ãƒšãƒ¼ã‚¸ãƒ³ã‚°
List<User> findAll();  // 10ä¸‡ä»¶å–å¾—
// ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§ãƒšãƒ¼ã‚¸ãƒ³ã‚°

// è§£æ±º: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å´ã§ãƒšãƒ¼ã‚¸ãƒ³ã‚°
Page<User> findAll(Pageable pageable);  // å¿…è¦ãªåˆ†ã ã‘å–å¾—
```

#### ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã¨Repository

**Repositoryå±¤ã§ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†:**

```java
// å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰: Repositoryå±¤ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†
@Repository
@Transactional  // å•é¡Œ: Repositoryå±¤ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†ã—ãªã„
public interface UserRepository extends JpaRepository<User, Long> {
}

// è§£æ±º: Serviceå±¤ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†
@Repository  // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ãªã—
public interface UserRepository extends JpaRepository<User, Long> {
}

@Service
@Transactional  // Serviceå±¤ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç®¡ç†
public class UserService {
    private final UserRepository userRepository;
    
    @Transactional
    public User createUserWithOrders(User user, List<Order> orders) {
        User savedUser = userRepository.save(user);
        for (Order order : orders) {
            order.setUser(savedUser);
            orderRepository.save(order);
        }
        return savedUser;
        // ã™ã¹ã¦ã®æ“ä½œãŒ1ã¤ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œã•ã‚Œã‚‹
    }
}
```

### ã¾ã¨ã‚

JPA Repositoryã®æ·±ã„ç†è§£ã«ãŠã„ã¦é‡è¦ãªãƒã‚¤ãƒ³ãƒˆï¼š

1. **é©åˆ‡ãªæŠ½è±¡åŒ–ãƒ¬ãƒ™ãƒ«ã®é¸æŠ**: ãƒ¡ã‚½ãƒƒãƒ‰åã‚¯ã‚¨ãƒªã€@Queryã€ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒã‚¸ãƒˆãƒªã®ä½¿ã„åˆ†ã‘
2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œã®æ ¹æœ¬ç†è§£**: N+1å•é¡Œã®ç™ºç”Ÿãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã¨è§£æ±ºæ–¹æ³•
3. **ã‚¯ã‚¨ãƒªæœ€é©åŒ–**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å´ã§ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨ãƒšãƒ¼ã‚¸ãƒ³ã‚°
4. **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†**: Repositoryå±¤ã§ã¯ãªãServiceå±¤ã§ç®¡ç†

**ã‚·ãƒ‹ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦è€ƒæ…®ã™ã¹ãç‚¹:**

- **ã‚¯ã‚¨ãƒªã®å¯èª­æ€§**: ãƒ¡ã‚½ãƒƒãƒ‰åã‹ã‚‰æ„å›³ãŒæ˜ç¢ºã‹
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: å®Ÿéš›ã®ã‚¯ã‚¨ãƒªå®Ÿè¡Œè¨ˆç”»ã‚’ç¢ºèªã—ã¦ã„ã‚‹ã‹
- **ä¿å®ˆæ€§**: è¤‡é›‘ãªã‚¯ã‚¨ãƒªã¯é©åˆ‡ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–ã•ã‚Œã¦ã„ã‚‹ã‹
- **ãƒ†ã‚¹ãƒˆå®¹æ˜“æ€§**: Repositoryã®ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“ã‹

`JpaRepository`ã¯ã€ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€åŠ¹ç‡çš„ã§ä¿å®ˆæ€§ã®é«˜ã„ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚é©åˆ‡ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ã‚³ãƒ¼ãƒ‰ã®é‡ã‚’å¤§å¹…ã«å‰Šæ¸›ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚‚å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

