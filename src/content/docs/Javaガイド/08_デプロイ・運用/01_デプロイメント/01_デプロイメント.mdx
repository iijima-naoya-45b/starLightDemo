---
title: "ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆï¼ˆDockerãƒ»Kubernetesï¼‰"
label: "ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ"
---

## ğŸš€ Spring Bootã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

Spring Bootã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’`Docker`ã¨`Kubernetes`ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

### ğŸ³ Dockerã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

#### ğŸ“ Dockerfileã®ä½œæˆ

**åŸºæœ¬çš„ãªDockerfile:**

```dockerfile
# ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã‚’ä½¿ç”¨
# ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¸
FROM maven:3.9-eclipse-temurin-17 AS build
WORKDIR /app

# ä¾å­˜é–¢ä¿‚ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ´»ç”¨
COPY pom.xml .
RUN mvn dependency:go-offline -B

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ“ãƒ«ãƒ‰
COPY src ./src
RUN mvn clean package -DskipTests

# å®Ÿè¡Œã‚¹ãƒ†ãƒ¼ã‚¸
FROM eclipse-temurin:17-jre-alpine
WORKDIR /app

# ãƒ“ãƒ«ãƒ‰ã—ãŸJARãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
COPY --from=build /app/target/*.jar app.jar

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œ
RUN addgroup -S spring && adduser -S spring -G spring
USER spring:spring

# ãƒãƒ¼ãƒˆã‚’å…¬é–‹
EXPOSE 8080

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
ENTRYPOINT ["java", "-jar", "app.jar"]
```

**Gradleã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ:**

```dockerfile
FROM gradle:8-jdk17 AS build
WORKDIR /app

COPY build.gradle settings.gradle ./
COPY gradle ./gradle
RUN gradle dependencies --no-daemon

COPY src ./src
RUN gradle build --no-daemon -x test

FROM eclipse-temurin:17-jre-alpine
WORKDIR /app

COPY --from=build /app/build/libs/*.jar app.jar

RUN addgroup -S spring && adduser -S spring -G spring
USER spring:spring

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

#### .dockerignoreã®ä½œæˆ

```plaintext
target/
!target/*.jar
.gradle/
.idea/
*.iml
.git/
.gitignore
README.md
.env
*.log
```

#### Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ã¨å®Ÿè¡Œ

```bash
# ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰
docker build -t myapp:latest .

# ã‚³ãƒ³ãƒ†ãƒŠã®å®Ÿè¡Œ
docker run -p 8080:8080 \
  -e SPRING_PROFILES_ACTIVE=prod \
  -e DB_HOST=postgres \
  -e DB_USERNAME=myuser \
  -e DB_PASSWORD=mypassword \
  myapp:latest

# ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œ
docker run -d -p 8080:8080 \
  --name myapp \
  -e SPRING_PROFILES_ACTIVE=prod \
  myapp:latest

# ãƒ­ã‚°ã®ç¢ºèª
docker logs -f myapp

# ã‚³ãƒ³ãƒ†ãƒŠã®åœæ­¢
docker stop myapp

# ã‚³ãƒ³ãƒ†ãƒŠã®å‰Šé™¤
docker rm myapp
```

#### Docker Composeã§ã®å®Ÿè¡Œ

**docker-compose.yml:**

```yaml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/mydb
      - SPRING_DATASOURCE_USERNAME=myuser
      - SPRING_DATASOURCE_PASSWORD=mypassword
    depends_on:
      - postgres
    networks:
      - app-network
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=mydb
      - POSTGRES_USER=myuser
      - POSTGRES_PASSWORD=mypassword
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - app-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    networks:
      - app-network
    restart: unless-stopped

volumes:
  postgres-data:

networks:
  app-network:
    driver: bridge
```

**å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰:**

```bash
# ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•
docker-compose up -d

# ãƒ­ã‚°ã®ç¢ºèª
docker-compose logs -f app

# ã‚µãƒ¼ãƒ“ã‚¹ã®åœæ­¢
docker-compose down

# ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚‚å«ã‚ã¦å‰Šé™¤
docker-compose down -v
```

### Kubernetesã§ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

#### Deploymentã®ä½œæˆ

**deployment.yaml:**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
  labels:
    app: myapp
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: myapp:latest
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: SPRING_DATASOURCE_URL
          valueFrom:
            secretKeyRef:
              name: myapp-secrets
              key: datasource-url
        - name: SPRING_DATASOURCE_USERNAME
          valueFrom:
            secretKeyRef:
              name: myapp-secrets
              key: datasource-username
        - name: SPRING_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: myapp-secrets
              key: datasource-password
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 5
```

#### Serviceã®ä½œæˆ

**service.yaml:**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: myapp-service
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 8080
    protocol: TCP
  selector:
    app: myapp
```

#### ConfigMapã®ä½œæˆ

**configmap.yaml:**

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: myapp-config
data:
  application.properties: |
    server.port=8080
    spring.jpa.hibernate.ddl-auto=validate
    logging.level.root=INFO
    logging.level.com.example.myapp=DEBUG
```

#### Secretã®ä½œæˆ

**secret.yaml:**

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: myapp-secrets
type: Opaque
data:
  datasource-url: amRiYzpwb3N0Z3Jlc3FsOi8vcG9zdGdyZXM6NTQzMi9teWRi  # base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
  datasource-username: bXl1c2Vy  # base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
  datasource-password: bXlwYXNzd29yZA==  # base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
```

**Secretã®ä½œæˆã‚³ãƒãƒ³ãƒ‰:**

```bash
# ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ä½œæˆ
kubectl create secret generic myapp-secrets \
  --from-literal=datasource-url=jdbc:postgresql://postgres:5432/mydb \
  --from-literal=datasource-username=myuser \
  --from-literal=datasource-password=mypassword
```

#### Ingressã®ä½œæˆ

**ingress.yaml:**

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: myapp-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - host: myapp.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: myapp-service
            port:
              number: 80
```

#### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®å®Ÿè¡Œ

```bash
# ã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
kubectl apply -f deployment.yaml
kubectl apply -f service.yaml
kubectl apply -f configmap.yaml
kubectl apply -f secret.yaml
kubectl apply -f ingress.yaml

# ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®çŠ¶æ…‹ç¢ºèª
kubectl get deployments
kubectl get pods
kubectl get services

# ãƒ­ã‚°ã®ç¢ºèª
kubectl logs -f deployment/myapp

# ãƒãƒƒãƒ‰ã®è©³ç´°ç¢ºèª
kubectl describe pod <pod-name>

# ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤
kubectl delete -f deployment.yaml
kubectl delete -f service.yaml
kubectl delete -f configmap.yaml
kubectl delete -f secret.yaml
kubectl delete -f ingress.yaml
```

### Spring Boot Actuatorã®è¨­å®š

#### ä¾å­˜é–¢ä¿‚ã®è¿½åŠ 

**Maven:**

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

**Gradle:**

```groovy
dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
}
```

#### application.propertiesã®è¨­å®š

```properties
# Actuatorã®æœ‰åŠ¹åŒ–
management.endpoints.web.exposure.include=health,info,metrics,prometheus
management.endpoint.health.show-details=when-authorized

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®è©³ç´°è¨­å®š
management.endpoint.health.probes.enabled=true
management.health.livenessState.enabled=true
management.health.readinessState.enabled=true

# ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¨­å®š
management.metrics.export.prometheus.enabled=true
```

#### ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```bash
# åŸºæœ¬çš„ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl http://localhost:8080/actuator/health

# è©³ç´°ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
curl http://localhost:8080/actuator/health/liveness
curl http://localhost:8080/actuator/health/readiness

# ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
@Component
public class CustomHealthIndicator implements HealthIndicator {
    
    @Override
    public Health health() {
        // ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯
        if (isHealthy()) {
            return Health.up()
                .withDetail("status", "OK")
                .build();
        } else {
            return Health.down()
                .withDetail("status", "ERROR")
                .build();
        }
    }
    
    private boolean isHealthy() {
        // ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯
        return true;
    }
}
```

### CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ä¾‹

#### GitHub Actions

**.github/workflows/deploy.yml:**

```yaml
name: Build and Deploy

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
    
    - name: Build with Maven
      run: mvn clean package -DskipTests
    
    - name: Build Docker image
      run: docker build -t myapp:${{ github.sha }} .
    
    - name: Push to Docker Hub
      run: |
        echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
        docker tag myapp:${{ github.sha }} myapp:latest
        docker push myapp:${{ github.sha }}
        docker push myapp:latest
    
    - name: Deploy to Kubernetes
      run: |
        echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig
        export KUBECONFIG=kubeconfig
        kubectl set image deployment/myapp myapp=myapp:${{ github.sha }}
        kubectl rollout status deployment/myapp
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

#### JVMã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¨­å®š

```dockerfile
ENTRYPOINT ["java", \
  "-Xms512m", \
  "-Xmx1024m", \
  "-XX:+UseG1GC", \
  "-XX:MaxGCPauseMillis=200", \
  "-XX:+UseStringDeduplication", \
  "-jar", "app.jar"]
```

#### ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ã®è¨­å®š

```yaml
resources:
  requests:
    memory: "512Mi"
    cpu: "500m"
  limits:
    memory: "1Gi"
    cpu: "1000m"
```

### ã¾ã¨ã‚

Spring Bootã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®ãƒã‚¤ãƒ³ãƒˆï¼š

- **Docker**: ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã«ã‚ˆã‚‹ç’°å¢ƒã®çµ±ä¸€
- **Docker Compose**: ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã®æ§‹ç¯‰
- **Kubernetes**: æœ¬ç•ªç’°å¢ƒã§ã®ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
- **Spring Boot Actuator**: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¨ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- **CI/CD**: è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
- **ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†**: é©åˆ‡ãªãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ã®è¨­å®š

ã“ã‚Œã‚‰ã®æ‰‹æ³•ã«ã‚ˆã‚Šã€Spring Bootã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®‰å…¨ã‹ã¤åŠ¹ç‡çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚


