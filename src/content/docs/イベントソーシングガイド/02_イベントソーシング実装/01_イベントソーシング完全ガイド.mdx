---
title: イベントソーシング完全ガイド
sidebar:
    label: イベントソーシング実装
---

# イベントソーシング完全ガイド

イベントソーシングの実践的な実装方法を、実務で使える実装例とベストプラクティスとともに詳しく解説します。

## 1. イベントソーシングとは

### イベントソーシングの定義

イベントソーシングは、状態の変更をイベントとして保存するアーキテクチャパターンです。

```
イベントソーシングの特徴
   ├─ イベントの永続化
   ├─ 状態の再現
   ├─ 監査ログ
   └─ タイムトラベル
```

## 2. イベントの定義

### イベントの構造

```typescript
// イベントの定義
interface DomainEvent {
  eventId: string;
  aggregateId: string;
  eventType: string;
  payload: any;
  timestamp: Date;
  version: number;
}

// 具体的なイベント
interface OrderCreatedEvent extends DomainEvent {
  eventType: 'OrderCreated';
  payload: {
    orderId: string;
    userId: string;
    items: OrderItem[];
  };
}

interface OrderCancelledEvent extends DomainEvent {
  eventType: 'OrderCancelled';
  payload: {
    orderId: string;
    reason: string;
  };
}
```

## 3. イベントストア

### イベントストアの実装

```typescript
// イベントストア
class EventStore {
  private events: DomainEvent[] = [];
  
  async append(aggregateId: string, events: DomainEvent[]): Promise<void> {
    // イベントを保存
    for (const event of events) {
      event.aggregateId = aggregateId;
      event.timestamp = new Date();
      this.events.push(event);
    }
  }
  
  async getEvents(aggregateId: string): Promise<DomainEvent[]> {
    return this.events.filter(e => e.aggregateId === aggregateId);
  }
  
  async getEventsByType(eventType: string): Promise<DomainEvent[]> {
    return this.events.filter(e => e.eventType === eventType);
  }
}
```

## 4. 状態の再現

### アグリゲートの再構築

```typescript
// アグリゲート
class Order {
  private id: string;
  private userId: string;
  private items: OrderItem[] = [];
  private status: OrderStatus = 'Pending';
  
  static fromEvents(events: DomainEvent[]): Order {
    const order = new Order();
    for (const event of events) {
      order.applyEvent(event);
    }
    return order;
  }
  
  private applyEvent(event: DomainEvent): void {
    switch (event.eventType) {
      case 'OrderCreated':
        this.id = event.payload.orderId;
        this.userId = event.payload.userId;
        this.items = event.payload.items;
        break;
      case 'OrderCancelled':
        this.status = 'Cancelled';
        break;
    }
  }
}
```

## 5. イベントハンドラー

```typescript
// イベントハンドラー
class OrderEventHandler {
  async handle(event: DomainEvent): Promise<void> {
    switch (event.eventType) {
      case 'OrderCreated':
        await this.sendConfirmationEmail(event.payload);
        await this.updateInventory(event.payload.items);
        break;
      case 'OrderCancelled':
        await this.sendCancellationEmail(event.payload);
        await this.restoreInventory(event.payload);
        break;
    }
  }
}
```

## まとめ

イベントソーシング完全ガイドのポイント：

- **イベントの定義**: ドメインイベントの構造
- **イベントストア**: イベントの永続化
- **状態の再現**: イベントから状態を再構築
- **イベントハンドラー**: イベントの処理

適切なイベントソーシングにより、監査可能で柔軟なシステムを構築できます。

