---
title: "FastAPIのテスト"
label: "FastAPIのテスト"
---

## FastAPIのテスト

FastAPIは、**pytestとTestClient**を組み合わせてAPIを簡単にテストできます。これにより、コードの品質を保証し、予期せぬバグの発生を防ぐことができます。

### 1. 必要なツールのインストール

テスト環境をセットアップするには、以下のライブラリをインストールします。

- **pytest**: Pythonで最も広く使われているテストフレームワークです。
- **httpx**: TestClientが内部で使用する、非同期対応のHTTPクライアントライブラリです。

```bash
pip install pytest httpx
```

### 2. テストクライアントの作成と利用

FastAPIの**TestClient**は、実際のWebサーバーを起動することなく、アプリケーションへのリクエストをシミュレートできます。これは、ユニットテストや統合テストを高速に実行するのに非常に役立ちます。

#### テストファイルの作成

テストコードは通常、`tests/`ディレクトリに配置します。pytestは、`test_`で始まるファイルや関数を自動的に検出して実行します。

##### 例: `tests/test_main.py`

```python
from fastapi.testclient import TestClient
from app.main import app

# TestClientインスタンスを作成
client = TestClient(app)

def test_read_root():
    # '/'エンドポイントにGETリクエストを送信
    response = client.get("/")
    # レスポンスのステータスコードが200であることを確認
    assert response.status_code == 200
    # レスポンスのJSONデータが期待通りであることを確認
    assert response.json() == {"Hello": "World"}
```

#### テストの実行

ターミナルで`pytest`コマンドを実行すると、pytestがテストファイルを見つけてテストを実行します。

```bash
pytest
```

成功すると、以下のような結果が表示されます。

```
============================= test session starts =============================
...
collected 1 item

tests/test_main.py .                                                     [100%]

============================== 1 passed in 0.05s ==============================
```

### 3. より複雑なテストケースの作成

TestClientは、GETだけでなく、POST, PUT, DELETEなどのすべてのHTTPメソッドをサポートしています。また、パスパラメータ、クエリパラメータ、リクエストボディも簡単にテストできます。

#### 例: POSTリクエストのテスト

`app/main.py`

```python
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()

class Item(BaseModel):
    name: str
    price: float

@app.post("/items/")
async def create_item(item: Item):
    return {"item_name": item.name, "item_price": item.price}
```

`tests/test_main.py`

```python
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_create_item():
    # リクエストボディを辞書として定義
    item_data = {"name": "Test Item", "price": 9.99}
    # POSTリクエストを送信し、jsonパラメータでボディを渡す
    response = client.post("/items/", json=item_data)
    # レスポンスのステータスコードとJSONデータを確認
    assert response.status_code == 200
    assert response.json() == {"item_name": "Test Item", "item_price": 9.99}
```

TestClientを使うことで、データベースや外部サービスへの依存を避けた、クリーンなテストを作成できます。これは、継続的インテグレーション（CI）パイプラインなど、自動化されたテスト環境において特に重要です。