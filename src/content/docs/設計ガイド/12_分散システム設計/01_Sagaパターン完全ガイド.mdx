---
title: "Sagaãƒ‘ã‚¿ãƒ¼ãƒ³å®Œå…¨ã‚¬ã‚¤ãƒ‰"
label: "Sagaãƒ‘ã‚¿ãƒ¼ãƒ³å®Œå…¨ã‚¬ã‚¤ãƒ‰"
---

## ğŸ”„ Sagaãƒ‘ã‚¿ãƒ¼ãƒ³å®Œå…¨ã‚¬ã‚¤ãƒ‰

åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã‘ã‚‹`ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†`ã®ãŸã‚ã®`Sagaãƒ‘ã‚¿ãƒ¼ãƒ³`ã‚’è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

### ğŸ¯ ãªãœSagaãƒ‘ã‚¿ãƒ¼ãƒ³ãŒå¿…è¦ãªã®ã‹

#### âŒ åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ2PCï¼‰ã®å•é¡Œç‚¹

**âŒ å•é¡Œã®ã‚ã‚‹å®Ÿè£…:**

```typescript
// âŒ æ‚ªã„ä¾‹: 2ãƒ•ã‚§ãƒ¼ã‚ºã‚³ãƒŸãƒƒãƒˆï¼ˆ2PCï¼‰ã‚’ä½¿ç”¨
async function createOrderWithPayment(orderData: OrderData) {
  const coordinator = new TransactionCoordinator();
  
  try {
    // ãƒ•ã‚§ãƒ¼ã‚º1: æº–å‚™
    await coordinator.prepare('order-service', () => createOrder(orderData));
    await coordinator.prepare('payment-service', () => chargePayment(orderData));
    await coordinator.prepare('inventory-service', () => reduceInventory(orderData));
    
    // ãƒ•ã‚§ãƒ¼ã‚º2: ã‚³ãƒŸãƒƒãƒˆ
    await coordinator.commit('order-service');
    await coordinator.commit('payment-service');
    await coordinator.commit('inventory-service');
  } catch (error) {
    // ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    await coordinator.rollback('order-service');
    await coordinator.rollback('payment-service');
    await coordinator.rollback('inventory-service');
    throw error;
  }
}
```

**å•é¡Œç‚¹:**

1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ã™ã¹ã¦ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒæº–å‚™å®Œäº†ã™ã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹å¿…è¦ãŒã‚ã‚‹
2. **å¯ç”¨æ€§**: 1ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå¤±æ•—ã™ã‚‹ã¨ã€å…¨ä½“ãŒãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã‚Œã‚‹
3. **ãƒ­ãƒƒã‚¯æ™‚é–“**: é•·æ™‚é–“ãƒ­ãƒƒã‚¯ãŒä¿æŒã•ã‚Œã‚‹
4. **ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£**: ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ç·Šå¯†ãªçµåˆãŒå¿…è¦

**å½±éŸ¿:**

- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ä½ä¸‹
- å¯ç”¨æ€§ã®ä½ä¸‹
- ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ã®åˆ¶é™
- éšœå®³ã®ä¼æ’­

#### Sagaãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹è§£æ±º

**æ”¹å–„ã•ã‚ŒãŸå®Ÿè£…:**

```typescript
// âœ… è‰¯ã„ä¾‹: Sagaãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½¿ç”¨
async function createOrderWithPayment(orderData: OrderData) {
  const saga = new OrderSaga();
  
  try {
    // ã‚¹ãƒ†ãƒƒãƒ—1: æ³¨æ–‡ã‚’ä½œæˆ
    const order = await saga.step1_createOrder(orderData);
    
    // ã‚¹ãƒ†ãƒƒãƒ—2: æ±ºæ¸ˆã‚’å‡¦ç†
    await saga.step2_processPayment(order.id, orderData.amount);
    
    // ã‚¹ãƒ†ãƒƒãƒ—3: åœ¨åº«ã‚’æ¸›ã‚‰ã™
    await saga.step3_reduceInventory(order.id, orderData.items);
    
    return order;
  } catch (error) {
    // è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
    await saga.compensate();
    throw error;
  }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**

- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å‘ä¸Š: å„ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç‹¬ç«‹ã—ã¦å®Ÿè¡Œ
- å¯ç”¨æ€§ã®å‘ä¸Š: 1ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒå¤±æ•—ã—ã¦ã‚‚ã€ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ã«å½±éŸ¿ã—ãªã„
- ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£: ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ç–çµåˆ
- éšœå®³ã®åˆ†é›¢: è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§æ•´åˆæ€§ã‚’ä¿ã¤

### Sagaãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç¨®é¡

#### 1. Orchestrationï¼ˆã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

**å®šç¾©:**
ä¸­å¤®ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒå„ã‚µãƒ¼ãƒ“ã‚¹ã®å‘¼ã³å‡ºã—ã‚’åˆ¶å¾¡ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

**å®Ÿè£…ä¾‹:**

```typescript
class OrderSagaOrchestrator {
  private compensations: Array<() => Promise<void>> = [];
  
  async execute(orderData: OrderData): Promise<Order> {
    try {
      // ã‚¹ãƒ†ãƒƒãƒ—1: æ³¨æ–‡ã‚’ä½œæˆ
      const order = await this.orderService.createOrder(orderData);
      this.compensations.push(() => this.orderService.cancelOrder(order.id));
      
      // ã‚¹ãƒ†ãƒƒãƒ—2: æ±ºæ¸ˆã‚’å‡¦ç†
      await this.paymentService.chargePayment(order.id, orderData.amount);
      this.compensations.push(() => this.paymentService.refundPayment(order.id));
      
      // ã‚¹ãƒ†ãƒƒãƒ—3: åœ¨åº«ã‚’æ¸›ã‚‰ã™
      await this.inventoryService.reduceInventory(order.id, orderData.items);
      this.compensations.push(() => this.inventoryService.restoreInventory(order.id, orderData.items));
      
      return order;
    } catch (error) {
      // è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€†é †ã§å®Ÿè¡Œ
      for (const compensate of this.compensations.reverse()) {
        try {
          await compensate();
        } catch (compError) {
          // è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å¤±æ•—ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
          console.error('Compensation failed:', compError);
        }
      }
      throw error;
    }
  }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**

- åˆ¶å¾¡ãŒæ˜ç¢º: ä¸­å¤®ã§åˆ¶å¾¡ã•ã‚Œã‚‹ãŸã‚ã€ãƒ•ãƒ­ãƒ¼ãŒæ˜ç¢º
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå®¹æ˜“: ä¸­å¤®ã§ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†ã§ãã‚‹
- ãƒ†ã‚¹ãƒˆãŒå®¹æ˜“: ä¸­å¤®ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆã™ã‚Œã°ã‚ˆã„

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**

- ä¸­å¤®ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã‚‹å¯èƒ½æ€§
- ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ã®å¯ç”¨æ€§ãŒé‡è¦

#### 2. Choreographyï¼ˆã‚³ãƒ¬ã‚ªã‚°ãƒ©ãƒ•ã‚£ãƒ¼ï¼‰

**å®šç¾©:**
å„ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã—ã€ä»–ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒãã‚Œã«åå¿œã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚

**å®Ÿè£…ä¾‹:**

```typescript
// Order Service
class OrderService {
  async createOrder(orderData: OrderData): Promise<Order> {
    const order = await this.orderRepository.save({
      ...orderData,
      status: 'PENDING',
    });
    
    // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
    await this.eventBus.publish('order.created', {
      orderId: order.id,
      userId: order.userId,
      amount: order.amount,
      items: order.items,
    });
    
    return order;
  }
  
  async handlePaymentCompleted(event: PaymentCompletedEvent): Promise<void> {
    await this.orderRepository.update(event.orderId, {
      status: 'PAID',
    });
    
    // æ¬¡ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
    await this.eventBus.publish('order.paid', {
      orderId: event.orderId,
      items: event.items,
    });
  }
  
  async handleInventoryReserved(event: InventoryReservedEvent): Promise<void> {
    await this.orderRepository.update(event.orderId, {
      status: 'CONFIRMED',
    });
  }
  
  async handlePaymentFailed(event: PaymentFailedEvent): Promise<void> {
    await this.orderRepository.update(event.orderId, {
      status: 'CANCELLED',
    });
  }
}

// Payment Service
class PaymentService {
  async handleOrderCreated(event: OrderCreatedEvent): Promise<void> {
    try {
      await this.chargePayment(event.orderId, event.amount);
      
      // æˆåŠŸã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
      await this.eventBus.publish('payment.completed', {
        orderId: event.orderId,
        amount: event.amount,
        items: event.items,
      });
    } catch (error) {
      // å¤±æ•—ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
      await this.eventBus.publish('payment.failed', {
        orderId: event.orderId,
        error: error.message,
      });
    }
  }
  
  async handleInventoryReservationFailed(event: InventoryReservationFailedEvent): Promise<void> {
    // è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³: è¿”é‡‘
    await this.refundPayment(event.orderId);
  }
}

// Inventory Service
class InventoryService {
  async handleOrderPaid(event: OrderPaidEvent): Promise<void> {
    try {
      await this.reserveInventory(event.orderId, event.items);
      
      // æˆåŠŸã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
      await this.eventBus.publish('inventory.reserved', {
        orderId: event.orderId,
      });
    } catch (error) {
      // å¤±æ•—ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
      await this.eventBus.publish('inventory.reservation.failed', {
        orderId: event.orderId,
        error: error.message,
      });
    }
  }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**

- ç–çµåˆ: ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ç›´æ¥çš„ãªä¾å­˜ãŒãªã„
- ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£: å„ã‚µãƒ¼ãƒ“ã‚¹ãŒç‹¬ç«‹ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã§ãã‚‹
- æŸ”è»Ÿæ€§: æ–°ã—ã„ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¿½åŠ ã—ã‚„ã™ã„

**ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ:**

- ãƒ•ãƒ­ãƒ¼ãŒè¤‡é›‘: ã‚¤ãƒ™ãƒ³ãƒˆã®æµã‚Œã‚’è¿½è·¡ã™ã‚‹ã®ãŒå›°é›£
- ãƒ‡ãƒãƒƒã‚°ãŒå›°é›£: åˆ†æ•£ã—ãŸãƒ­ã‚°ã‚’è¿½è·¡ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒè¤‡é›‘: è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ç®¡ç†ãŒå›°é›£

### Orchestration vs Choreography ã®é¸æŠåŸºæº–

#### Orchestrationã‚’é¸ã¶ã¹ãå ´åˆ

**æ¡ä»¶:**

- è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚ã‚‹
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒé‡è¦
- ãƒ•ãƒ­ãƒ¼ã‚’æ˜ç¢ºã«åˆ¶å¾¡ã—ãŸã„
- ãƒãƒ¼ãƒ ãŒå°è¦æ¨¡

**å®Ÿè·µä¾‹:**

```typescript
// è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚ã‚‹å ´åˆ
class ComplexOrderSagaOrchestrator {
  async execute(orderData: OrderData): Promise<Order> {
    // è¤‡é›‘ãªæ¡ä»¶åˆ†å²
    if (orderData.isPremium) {
      await this.processPremiumOrder(orderData);
    } else {
      await this.processStandardOrder(orderData);
    }
    
    // è¤‡é›‘ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    try {
      // ...
    } catch (error) {
      // è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      if (error.type === 'PAYMENT_FAILED') {
        await this.handlePaymentFailure(orderData);
      } else if (error.type === 'INVENTORY_SHORTAGE') {
        await this.handleInventoryShortage(orderData);
      }
    }
  }
}
```

#### Choreographyã‚’é¸ã¶ã¹ãå ´åˆ

**æ¡ä»¶:**

- ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ãƒ­ãƒ¼
- ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ç–çµåˆãŒé‡è¦
- ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ãŒé‡è¦
- ãƒãƒ¼ãƒ ãŒå¤§è¦æ¨¡

**å®Ÿè·µä¾‹:**

```typescript
// ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ãƒ­ãƒ¼
// Order Service
await eventBus.publish('order.created', orderData);

// Payment Service
eventBus.subscribe('order.created', async (event) => {
  await chargePayment(event);
  await eventBus.publish('payment.completed', event);
});

// Inventory Service
eventBus.subscribe('payment.completed', async (event) => {
  await reserveInventory(event);
  await eventBus.publish('inventory.reserved', event);
});
```

### è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè£…

#### è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®é‡è¦æ€§

**å•é¡Œ:**

```typescript
// âŒ æ‚ªã„ä¾‹: è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒãªã„
async function createOrder(orderData: OrderData) {
  const order = await orderService.createOrder(orderData);
  await paymentService.chargePayment(order.id, orderData.amount);
  
  // åœ¨åº«ãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã€æ³¨æ–‡ã¨æ±ºæ¸ˆã¯å®Œäº†ã—ã¦ã„ã‚‹ãŒã€åœ¨åº«ã¯æ¸›ã£ã¦ã„ãªã„
  // â†’ ãƒ‡ãƒ¼ã‚¿ã®ä¸æ•´åˆ
  await inventoryService.reduceInventory(order.id, orderData.items);
}
```

**è§£æ±ºç­–:**

```typescript
// âœ… è‰¯ã„ä¾‹: è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…
class OrderSaga {
  private compensations: Array<{ action: string; compensate: () => Promise<void> }> = [];
  
  async execute(orderData: OrderData): Promise<Order> {
    try {
      // ã‚¹ãƒ†ãƒƒãƒ—1: æ³¨æ–‡ã‚’ä½œæˆ
      const order = await this.orderService.createOrder(orderData);
      this.compensations.push({
        action: 'createOrder',
        compensate: () => this.orderService.cancelOrder(order.id),
      });
      
      // ã‚¹ãƒ†ãƒƒãƒ—2: æ±ºæ¸ˆã‚’å‡¦ç†
      await this.paymentService.chargePayment(order.id, orderData.amount);
      this.compensations.push({
        action: 'chargePayment',
        compensate: () => this.paymentService.refundPayment(order.id),
      });
      
      // ã‚¹ãƒ†ãƒƒãƒ—3: åœ¨åº«ã‚’æ¸›ã‚‰ã™
      await this.inventoryService.reduceInventory(order.id, orderData.items);
      this.compensations.push({
        action: 'reduceInventory',
        compensate: () => this.inventoryService.restoreInventory(order.id, orderData.items),
      });
      
      return order;
    } catch (error) {
      // è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’é€†é †ã§å®Ÿè¡Œ
      await this.compensate();
      throw error;
    }
  }
  
  private async compensate(): Promise<void> {
    for (const comp of this.compensations.reverse()) {
      try {
        await comp.compensate();
      } catch (error) {
        // è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å¤±æ•—ã‚’ãƒ­ã‚°ã«è¨˜éŒ²
        // å ´åˆã«ã‚ˆã£ã¦ã¯ã€æ‰‹å‹•ã§ã®å¯¾å¿œãŒå¿…è¦
        console.error(`Compensation failed for ${comp.action}:`, error);
        await this.alertManualIntervention(comp.action, error);
      }
    }
  }
}
```

### å®Ÿè·µçš„ãªå®Ÿè£…ä¾‹

#### å®Œå…¨ãªSagaå®Ÿè£…

```typescript
// Sagaã®çŠ¶æ…‹ç®¡ç†
interface SagaState {
  sagaId: string;
  currentStep: number;
  status: 'PENDING' | 'IN_PROGRESS' | 'COMPLETED' | 'FAILED' | 'COMPENSATING';
  compensations: Array<{
    step: number;
    action: string;
    compensate: () => Promise<void>;
  }>;
  data: any;
}

class SagaManager {
  private sagas: Map<string, SagaState> = new Map();
  
  async executeSaga<T>(
    sagaId: string,
    steps: Array<{ execute: () => Promise<any>; compensate: () => Promise<void> }>
  ): Promise<T> {
    const saga: SagaState = {
      sagaId,
      currentStep: 0,
      status: 'IN_PROGRESS',
      compensations: [],
      data: {},
    };
    
    this.sagas.set(sagaId, saga);
    
    try {
      for (let i = 0; i < steps.length; i++) {
        saga.currentStep = i;
        
        const result = await steps[i].execute();
        saga.data[`step${i}`] = result;
        
        saga.compensations.push({
          step: i,
          action: `step${i}`,
          compensate: steps[i].compensate,
        });
      }
      
      saga.status = 'COMPLETED';
      return saga.data as T;
    } catch (error) {
      saga.status = 'FAILED';
      await this.compensate(saga);
      throw error;
    }
  }
  
  private async compensate(saga: SagaState): Promise<void> {
    saga.status = 'COMPENSATING';
    
    for (const comp of saga.compensations.reverse()) {
      try {
        await comp.compensate();
      } catch (error) {
        console.error(`Compensation failed for step ${comp.step}:`, error);
        // è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å¤±æ•—ã‚’è¨˜éŒ²
        await this.recordCompensationFailure(saga.sagaId, comp.step, error);
      }
    }
  }
  
  private async recordCompensationFailure(
    sagaId: string,
    step: number,
    error: Error
  ): Promise<void> {
    // è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å¤±æ•—ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¨˜éŒ²
    // æ‰‹å‹•ã§ã®å¯¾å¿œãŒå¿…è¦ãªå ´åˆãŒã‚ã‚‹
    await db.sagaFailures.create({
      data: {
        sagaId,
        step,
        error: error.message,
        timestamp: new Date(),
      },
    });
  }
}

// ä½¿ç”¨ä¾‹
const sagaManager = new SagaManager();

const order = await sagaManager.executeSaga<Order>(
  `order-${orderId}`,
  [
    {
      execute: () => orderService.createOrder(orderData),
      compensate: () => orderService.cancelOrder(orderId),
    },
    {
      execute: () => paymentService.chargePayment(orderId, amount),
      compensate: () => paymentService.refundPayment(orderId),
    },
    {
      execute: () => inventoryService.reduceInventory(orderId, items),
      compensate: () => inventoryService.restoreInventory(orderId, items),
    },
  ]
);
```

### ã¾ã¨ã‚

Sagaãƒ‘ã‚¿ãƒ¼ãƒ³å®Œå…¨ã‚¬ã‚¤ãƒ‰ã®ãƒã‚¤ãƒ³ãƒˆï¼š

- **ãªãœå¿…è¦ã‹**: åˆ†æ•£ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ2PCï¼‰ã®å•é¡Œç‚¹ã‚’è§£æ±º
- **Orchestration**: ä¸­å¤®ã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼ãŒåˆ¶å¾¡ã€è¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ã«é©ã—ã¦ã„ã‚‹
- **Choreography**: ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã€ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ç–çµåˆã«é©ã—ã¦ã„ã‚‹
- **è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³**: ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ä¿ã¤ãŸã‚ã«é‡è¦
- **å®Ÿè·µçš„ãªå®Ÿè£…**: Sagaã®çŠ¶æ…‹ç®¡ç†ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã€è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å®Ÿè£…

é©åˆ‡ãªSagaãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…ã«ã‚ˆã‚Šã€åˆ†æ•£ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã‘ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

