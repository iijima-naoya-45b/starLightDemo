---
title: "Circuit Breakerãƒ‘ã‚¿ãƒ¼ãƒ³"
label: "Circuit Breakerãƒ‘ã‚¿ãƒ¼ãƒ³"
---

## ğŸ”Œ Circuit Breakerãƒ‘ã‚¿ãƒ¼ãƒ³

`ã‚µãƒ¼ã‚­ãƒƒãƒˆãƒ–ãƒ¬ãƒ¼ã‚«ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³`ã‚’è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

### ğŸ¯ ãªãœCircuit BreakerãŒå¿…è¦ãªã®ã‹

#### âš ï¸ éšœå®³ã®ä¼æ’­å•é¡Œ

**âŒ å•é¡Œã®ã‚ã‚‹å®Ÿè£…:**

```typescript
// âŒ æ‚ªã„ä¾‹: éšœå®³ãŒä¼æ’­ã™ã‚‹
class PaymentService {
  async chargePayment(orderId: string, amount: number): Promise<PaymentResult> {
    try {
      // å¤–éƒ¨ã®æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ã‚’å‘¼ã³å‡ºã—
      const response = await fetch('https://payment-api.example.com/charge', {
        method: 'POST',
        body: JSON.stringify({ orderId, amount }),
      });
      
      if (!response.ok) {
        throw new Error('Payment failed');
      }
      
      return await response.json();
    } catch (error) {
      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã¨ã€å‘¼ã³å‡ºã—å…ƒã«ã‚‚å½±éŸ¿ã™ã‚‹
      throw error;
    }
  }
}

// å‘¼ã³å‡ºã—å…ƒ
class OrderService {
  async createOrder(orderData: OrderData): Promise<Order> {
    const order = await db.order.create({ data: orderData });
    
    // æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ãŒéšœå®³ã‚’èµ·ã“ã—ã¦ã„ã‚‹å ´åˆã€ã“ã“ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    // â†’ æ³¨æ–‡ã¯ä½œæˆã•ã‚Œã¦ã„ã‚‹ãŒã€æ±ºæ¸ˆã¯å®Œäº†ã—ã¦ã„ãªã„
    // â†’ ãƒ‡ãƒ¼ã‚¿ã®ä¸æ•´åˆ
    await paymentService.chargePayment(order.id, orderData.amount);
    
    return order;
  }
}
```

**å•é¡Œç‚¹:**

1. **éšœå®³ã®ä¼æ’­**: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®éšœå®³ãŒè‡ªã‚·ã‚¹ãƒ†ãƒ ã«å½±éŸ¿ã™ã‚‹
2. **ãƒªã‚½ãƒ¼ã‚¹ã®æµªè²»**: å¤±æ•—ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¹°ã‚Šè¿”ã—é€ä¿¡
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ä½ä¸‹**: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ã§å¾…æ©Ÿã™ã‚‹å¿…è¦ãŒã‚ã‚‹
4. **å¯ç”¨æ€§ã®ä½ä¸‹**: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®éšœå®³ãŒè‡ªã‚·ã‚¹ãƒ†ãƒ ã®å¯ç”¨æ€§ã«å½±éŸ¿

**å½±éŸ¿:**

- ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å¯ç”¨æ€§ã®ä½ä¸‹
- ãƒªã‚½ãƒ¼ã‚¹ã®æµªè²»
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ä½ä¸‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®æ‚ªåŒ–

#### Circuit Breakerã«ã‚ˆã‚‹è§£æ±º

**æ”¹å–„ã•ã‚ŒãŸå®Ÿè£…:**

```typescript
// âœ… è‰¯ã„ä¾‹: Circuit Breakerã‚’ä½¿ç”¨
class CircuitBreaker {
  private state: 'CLOSED' | 'OPEN' | 'HALF_OPEN' = 'CLOSED';
  private failureCount: number = 0;
  private lastFailureTime: Date | null = null;
  private readonly failureThreshold: number = 5;
  private readonly timeout: number = 60000; // 60ç§’
  private readonly halfOpenTimeout: number = 30000; // 30ç§’
  
  async execute<T>(fn: () => Promise<T>): Promise<T> {
    if (this.state === 'OPEN') {
      // ã‚µãƒ¼ã‚­ãƒƒãƒˆãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã€å³åº§ã«å¤±æ•—ã‚’è¿”ã™
      if (this.shouldAttemptReset()) {
        this.state = 'HALF_OPEN';
      } else {
        throw new CircuitBreakerOpenError('Circuit breaker is open');
      }
    }
    
    try {
      const result = await fn();
      
      // æˆåŠŸã—ãŸå ´åˆã€å¤±æ•—ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
      this.onSuccess();
      
      return result;
    } catch (error) {
      // å¤±æ•—ã—ãŸå ´åˆã€å¤±æ•—ã‚«ã‚¦ãƒ³ãƒˆã‚’å¢—ã‚„ã™
      this.onFailure();
      throw error;
    }
  }
  
  private onSuccess(): void {
    this.failureCount = 0;
    
    if (this.state === 'HALF_OPEN') {
      // ãƒãƒ¼ãƒ•ã‚ªãƒ¼ãƒ—ãƒ³çŠ¶æ…‹ã§æˆåŠŸã—ãŸå ´åˆã€ã‚¯ãƒ­ãƒ¼ã‚ºçŠ¶æ…‹ã«æˆ»ã™
      this.state = 'CLOSED';
    }
  }
  
  private onFailure(): void {
    this.failureCount++;
    this.lastFailureTime = new Date();
    
    if (this.failureCount >= this.failureThreshold) {
      // å¤±æ•—é–¾å€¤ã‚’è¶…ãˆãŸå ´åˆã€ã‚µãƒ¼ã‚­ãƒƒãƒˆã‚’é–‹ã
      this.state = 'OPEN';
    }
  }
  
  private shouldAttemptReset(): boolean {
    if (!this.lastFailureTime) {
      return false;
    }
    
    const elapsed = Date.now() - this.lastFailureTime.getTime();
    return elapsed >= this.timeout;
  }
}

class PaymentService {
  private circuitBreaker: CircuitBreaker;
  
  constructor() {
    this.circuitBreaker = new CircuitBreaker();
  }
  
  async chargePayment(orderId: string, amount: number): Promise<PaymentResult> {
    return await this.circuitBreaker.execute(async () => {
      const response = await fetch('https://payment-api.example.com/charge', {
        method: 'POST',
        body: JSON.stringify({ orderId, amount }),
        timeout: 5000, // 5ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
      });
      
      if (!response.ok) {
        throw new Error('Payment failed');
      }
      
      return await response.json();
    });
  }
}
```

**ãƒ¡ãƒªãƒƒãƒˆ:**

- éšœå®³ã®åˆ†é›¢: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®éšœå®³ãŒè‡ªã‚·ã‚¹ãƒ†ãƒ ã«å½±éŸ¿ã—ãªã„
- ãƒªã‚½ãƒ¼ã‚¹ã®ç¯€ç´„: å¤±æ•—ã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ãªã„
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å‘ä¸Š: å³åº§ã«å¤±æ•—ã‚’è¿”ã™
- å¯ç”¨æ€§ã®å‘ä¸Š: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’å®Ÿè¡Œã§ãã‚‹

### Circuit Breakerã®çŠ¶æ…‹

#### 1. CLOSEDï¼ˆé–‰ã˜ã¦ã„ã‚‹ï¼‰

**çŠ¶æ…‹:**
æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚

**å‹•ä½œ:**

```typescript
// ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€šéã•ã›ã‚‹
if (this.state === 'CLOSED') {
  try {
    const result = await executeRequest();
    return result;
  } catch (error) {
    this.failureCount++;
    if (this.failureCount >= this.failureThreshold) {
      this.state = 'OPEN';
    }
    throw error;
  }
}
```

#### 2. OPENï¼ˆé–‹ã„ã¦ã„ã‚‹ï¼‰

**çŠ¶æ…‹:**
éšœå®³ãŒç™ºç”Ÿã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚

**å‹•ä½œ:**

```typescript
// ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å³åº§ã«å¤±æ•—ã•ã›ã‚‹
if (this.state === 'OPEN') {
  if (this.shouldAttemptReset()) {
    this.state = 'HALF_OPEN';
  } else {
    throw new CircuitBreakerOpenError('Circuit breaker is open');
  }
}
```

#### 3. HALF_OPENï¼ˆåŠé–‹ãï¼‰

**çŠ¶æ…‹:**
éšœå®³ãŒå›å¾©ã—ãŸã‹ãƒ†ã‚¹ãƒˆã—ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚

**å‹•ä½œ:**

```typescript
// é™ã‚‰ã‚ŒãŸæ•°ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€šéã•ã›ã‚‹
if (this.state === 'HALF_OPEN') {
  try {
    const result = await executeRequest();
    this.state = 'CLOSED'; // æˆåŠŸã—ãŸå ´åˆã€ã‚¯ãƒ­ãƒ¼ã‚ºçŠ¶æ…‹ã«æˆ»ã™
    this.failureCount = 0;
    return result;
  } catch (error) {
    this.state = 'OPEN'; // å¤±æ•—ã—ãŸå ´åˆã€ã‚ªãƒ¼ãƒ—ãƒ³çŠ¶æ…‹ã«æˆ»ã™
    this.failureCount++;
    throw error;
  }
}
```

### å®Ÿè·µçš„ãªå®Ÿè£…ä¾‹

#### Resilience4jã‚’ä½¿ç”¨ã—ãŸå®Ÿè£…

```typescript
import { CircuitBreaker, CircuitBreakerConfig } from 'resilience4j';

// Circuit Breakerã®è¨­å®š
const circuitBreakerConfig: CircuitBreakerConfig = {
  failureRateThreshold: 50, // å¤±æ•—ç‡50%ã§ã‚ªãƒ¼ãƒ—ãƒ³
  waitDurationInOpenState: 60000, // 60ç§’å¾…æ©Ÿ
  slidingWindowSize: 10, // 10ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¹ãƒ©ã‚¤ãƒ‡ã‚£ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
  minimumNumberOfCalls: 5, // æœ€ä½5å›ã®å‘¼ã³å‡ºã—ãŒå¿…è¦
  permittedNumberOfCallsInHalfOpenState: 3, // ãƒãƒ¼ãƒ•ã‚ªãƒ¼ãƒ—ãƒ³çŠ¶æ…‹ã§3å›è¨±å¯
  automaticTransitionFromOpenToHalfOpenEnabled: true,
};

const circuitBreaker = CircuitBreaker.of('payment-service', circuitBreakerConfig);

class PaymentService {
  async chargePayment(orderId: string, amount: number): Promise<PaymentResult> {
    return await circuitBreaker.executeSupplier(async () => {
      const response = await fetch('https://payment-api.example.com/charge', {
        method: 'POST',
        body: JSON.stringify({ orderId, amount }),
      });
      
      if (!response.ok) {
        throw new Error('Payment failed');
      }
      
      return await response.json();
    });
  }
}
```

#### ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†

```typescript
class PaymentService {
  private circuitBreaker: CircuitBreaker;
  
  async chargePayment(orderId: string, amount: number): Promise<PaymentResult> {
    try {
      return await this.circuitBreaker.execute(async () => {
        return await this.callPaymentAPI(orderId, amount);
      });
    } catch (error) {
      if (error instanceof CircuitBreakerOpenError) {
        // ã‚µãƒ¼ã‚­ãƒƒãƒˆãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’å®Ÿè¡Œ
        return await this.fallbackPayment(orderId, amount);
      }
      throw error;
    }
  }
  
  private async fallbackPayment(orderId: string, amount: number): Promise<PaymentResult> {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†: ã‚­ãƒ¥ãƒ¼ã«ä¿å­˜ã—ã¦å¾Œã§å‡¦ç†
    await db.pendingPayments.create({
      data: {
        orderId,
        amount,
        status: 'PENDING',
        createdAt: new Date(),
      },
    });
    
    return {
      status: 'PENDING',
      message: 'Payment will be processed later',
    };
  }
}
```

### Circuit Breakerã®è¨­å®š

#### æ¨å¥¨è¨­å®šå€¤

**è¨­å®šä¾‹:**

```typescript
interface CircuitBreakerConfig {
  // å¤±æ•—ç‡ã®é–¾å€¤ï¼ˆ%ï¼‰
  failureRateThreshold: number; // 50%
  
  // ã‚ªãƒ¼ãƒ—ãƒ³çŠ¶æ…‹ã®å¾…æ©Ÿæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  waitDurationInOpenState: number; // 60000ms (60ç§’)
  
  // ã‚¹ãƒ©ã‚¤ãƒ‡ã‚£ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ã‚µã‚¤ã‚º
  slidingWindowSize: number; // 10ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
  
  // æœ€ä½å¿…è¦ãªå‘¼ã³å‡ºã—å›æ•°
  minimumNumberOfCalls: number; // 5å›
  
  // ãƒãƒ¼ãƒ•ã‚ªãƒ¼ãƒ—ãƒ³çŠ¶æ…‹ã§è¨±å¯ã™ã‚‹å‘¼ã³å‡ºã—å›æ•°
  permittedNumberOfCallsInHalfOpenState: number; // 3å›
  
  // è‡ªå‹•çš„ã«ãƒãƒ¼ãƒ•ã‚ªãƒ¼ãƒ—ãƒ³ã«é·ç§»ã™ã‚‹ã‹
  automaticTransitionFromOpenToHalfOpenEnabled: boolean; // true
}
```

#### ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã®è¨­å®š

```typescript
// æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹: å³ã—ã„è¨­å®šï¼ˆå¯ç”¨æ€§ãŒé‡è¦ï¼‰
const paymentCircuitBreakerConfig: CircuitBreakerConfig = {
  failureRateThreshold: 30, // 30%ã§ã‚ªãƒ¼ãƒ—ãƒ³
  waitDurationInOpenState: 30000, // 30ç§’
  slidingWindowSize: 20,
  minimumNumberOfCalls: 10,
};

// é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹: ç·©ã„è¨­å®šï¼ˆå¯ç”¨æ€§ã¯é‡è¦ã ãŒã€å¤±æ•—ã—ã¦ã‚‚å•é¡Œãªã„ï¼‰
const notificationCircuitBreakerConfig: CircuitBreakerConfig = {
  failureRateThreshold: 70, // 70%ã§ã‚ªãƒ¼ãƒ—ãƒ³
  waitDurationInOpenState: 120000, // 120ç§’
  slidingWindowSize: 10,
  minimumNumberOfCalls: 5,
};
```

### ã¾ã¨ã‚

Circuit Breakerãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒã‚¤ãƒ³ãƒˆï¼š

- **ãªãœå¿…è¦ã‹**: éšœå®³ã®ä¼æ’­ã‚’é˜²ãã€ãƒªã‚½ãƒ¼ã‚¹ã‚’ç¯€ç´„
- **çŠ¶æ…‹**: CLOSEDï¼ˆé–‰ã˜ã¦ã„ã‚‹ï¼‰ã€OPENï¼ˆé–‹ã„ã¦ã„ã‚‹ï¼‰ã€HALF_OPENï¼ˆåŠé–‹ãï¼‰
- **å®Ÿè£…**: Resilience4jãªã©ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨
- **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†**: ã‚µãƒ¼ã‚­ãƒƒãƒˆãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã®ä»£æ›¿å‡¦ç†
- **è¨­å®š**: ã‚µãƒ¼ãƒ“ã‚¹ã”ã¨ã«é©åˆ‡ãªè¨­å®šå€¤ã‚’é¸æŠ

é©åˆ‡ãªCircuit Breakerã®å®Ÿè£…ã«ã‚ˆã‚Šã€éšœå®³ã«å¼·ã„ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚

