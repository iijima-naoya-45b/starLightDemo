---
title: "ãƒ‡ãƒ¼ã‚¿ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†"
label: "ãƒ‡ãƒ¼ã‚¿ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†"
---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

`ãƒ‡ãƒ¼ã‚¿`ã®ä½œæˆã‹ã‚‰å‰Šé™¤ã¾ã§ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã‚’ç®¡ç†ã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

### ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã®æ®µéš

#### â• 1. ä½œæˆï¼ˆCreateï¼‰

`ãƒ‡ãƒ¼ã‚¿`ãŒä½œæˆã•ã‚Œã‚‹æ®µéšã§ã™ã€‚

```sql
-- ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
INSERT INTO users (name, email, password_hash)
VALUES ('John Doe', 'john@example.com', 'hashed_password');
```

#### 2. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆActiveï¼‰

ãƒ‡ãƒ¼ã‚¿ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹æ®µéšã§ã™ã€‚

```sql
-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ‡ãƒ¼ã‚¿ã®å–å¾—
SELECT * FROM users WHERE deleted_at IS NULL;
```

#### 3. éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆInactiveï¼‰

ãƒ‡ãƒ¼ã‚¿ãŒä½¿ç”¨ã•ã‚Œãªããªã£ãŸæ®µéšã§ã™ã€‚

```sql
-- ãƒ‡ãƒ¼ã‚¿ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
UPDATE users 
SET status = 'inactive',
    inactive_at = NOW()
WHERE id = 1;
```

#### 4. è«–ç†å‰Šé™¤ï¼ˆSoft Deleteï¼‰

ãƒ‡ãƒ¼ã‚¿ãŒè«–ç†å‰Šé™¤ã•ã‚ŒãŸæ®µéšã§ã™ã€‚

```sql
-- è«–ç†å‰Šé™¤
UPDATE users 
SET deleted_at = NOW(),
    is_deleted = TRUE
WHERE id = 1;
```

#### 5. ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆArchiveï¼‰

ãƒ‡ãƒ¼ã‚¿ãŒã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã•ã‚ŒãŸæ®µéšã§ã™ã€‚

```sql
-- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»å‹•
INSERT INTO users_archive
SELECT * FROM users WHERE deleted_at IS NOT NULL;

-- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å¾Œã«ç‰©ç†å‰Šé™¤
DELETE FROM users WHERE deleted_at IS NOT NULL;
```

#### 6. ç‰©ç†å‰Šé™¤ï¼ˆHard Deleteï¼‰

ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚ŒãŸæ®µéšã§ã™ã€‚

```sql
-- ç‰©ç†å‰Šé™¤
DELETE FROM users WHERE id = 1;
```

### ãƒ‡ãƒ¼ã‚¿ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã®å®Ÿè£…

#### 1. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†

```sql
-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(255) NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  status ENUM('active', 'inactive', 'deleted', 'archived') DEFAULT 'active',
  status_changed_at TIMESTAMP NULL,
  deleted_at TIMESTAMP NULL,
  archived_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_status (status),
  INDEX idx_deleted_at (deleted_at)
);
```

#### 2. ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã®å®Ÿè£…

```javascript
// ãƒ‡ãƒ¼ã‚¿ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ã®å®Ÿè£…
class DataLifecycleService {
  // ãƒ‡ãƒ¼ã‚¿ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
  async deactivateUser(userId) {
    await db.query(
      `UPDATE users 
       SET status = 'inactive',
           status_changed_at = NOW()
       WHERE id = ?`,
      [userId]
    );
  }
  
  // ãƒ‡ãƒ¼ã‚¿ã‚’è«–ç†å‰Šé™¤
  async softDeleteUser(userId) {
    await db.query(
      `UPDATE users 
       SET status = 'deleted',
           deleted_at = NOW(),
           status_changed_at = NOW()
       WHERE id = ?`,
      [userId]
    );
  }
  
  // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
  async archiveUser(userId) {
    const connection = await db.getConnection();
    try {
      await connection.beginTransaction();
      
      // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»å‹•
      await connection.query(
        `INSERT INTO users_archive
         SELECT * FROM users WHERE id = ?`,
        [userId]
      );
      
      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
      await connection.query(
        `UPDATE users 
         SET status = 'archived',
             archived_at = NOW(),
             status_changed_at = NOW()
         WHERE id = ?`,
        [userId]
      );
      
      await connection.commit();
    } catch (error) {
      await connection.rollback();
      throw error;
    } finally {
      connection.release();
    }
  }
  
  // ãƒ‡ãƒ¼ã‚¿ã‚’ç‰©ç†å‰Šé™¤
  async hardDeleteUser(userId) {
    await db.query('DELETE FROM users WHERE id = ?', [userId]);
  }
}
```

### è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†

#### 1. ãƒãƒƒãƒå‡¦ç†ã§ã®è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–

```javascript
// ãƒãƒƒãƒå‡¦ç†: ä¸€å®šæœŸé–“å¾Œã«è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
async function autoArchiveUsers() {
  const connection = await db.getConnection();
  try {
    await connection.beginTransaction();
    
    // 1å¹´ä»¥ä¸Šå‰ã«å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
    const [users] = await connection.query(
      `SELECT * FROM users 
       WHERE status = 'deleted'
         AND deleted_at < DATE_SUB(NOW(), INTERVAL 1 YEAR)`
    );
    
    for (const user of users) {
      // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç§»å‹•
      await connection.query(
        `INSERT INTO users_archive 
         (id, name, email, deleted_at, archived_at)
         VALUES (?, ?, ?, ?, NOW())`,
        [user.id, user.name, user.email, user.deleted_at]
      );
      
      // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
      await connection.query(
        `UPDATE users 
         SET status = 'archived',
             archived_at = NOW()
         WHERE id = ?`,
        [user.id]
      );
    }
    
    await connection.commit();
    return { archivedCount: users.length };
  } catch (error) {
    await connection.rollback();
    throw error;
  } finally {
    connection.release();
  }
}

// æ¯æ—¥æ·±å¤œã«å®Ÿè¡Œ
cron.schedule('0 2 * * *', autoArchiveUsers);
```

#### 2. è‡ªå‹•ç‰©ç†å‰Šé™¤

```javascript
// ãƒãƒƒãƒå‡¦ç†: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‹ã‚‰ä¸€å®šæœŸé–“å¾Œã«ç‰©ç†å‰Šé™¤
async function autoPurgeArchivedUsers() {
  const connection = await db.getConnection();
  try {
    await connection.beginTransaction();
    
    // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‹ã‚‰5å¹´ä»¥ä¸ŠçµŒéã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç‰©ç†å‰Šé™¤
    const [users] = await connection.query(
      `SELECT id FROM users_archive 
       WHERE archived_at < DATE_SUB(NOW(), INTERVAL 5 YEAR)`
    );
    
    for (const user of users) {
      await connection.query('DELETE FROM users_archive WHERE id = ?', [user.id]);
    }
    
    await connection.commit();
    return { deletedCount: users.length };
  } catch (error) {
    await connection.rollback();
    throw error;
  } finally {
    connection.release();
  }
}

// æ¯é€±å®Ÿè¡Œ
cron.schedule('0 3 * * 0', autoPurgeArchivedUsers);
```

### ã¾ã¨ã‚

ãƒ‡ãƒ¼ã‚¿ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ï¼š

- **ä½œæˆ**: ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆ
- **ã‚¢ã‚¯ãƒ†ã‚£ãƒ–**: ãƒ‡ãƒ¼ã‚¿ã®ä½¿ç”¨
- **éã‚¢ã‚¯ãƒ†ã‚£ãƒ–**: ãƒ‡ãƒ¼ã‚¿ã®éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
- **è«–ç†å‰Šé™¤**: å‰Šé™¤ãƒ•ãƒ©ã‚°ã®è¨­å®š
- **ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–**: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ç§»å‹•
- **ç‰©ç†å‰Šé™¤**: ãƒ‡ãƒ¼ã‚¿ã®å®Œå…¨å‰Šé™¤

é©åˆ‡ãªãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®ä¿è­·ã¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®åŠ¹ç‡åŒ–ã‚’ä¸¡ç«‹ã§ãã¾ã™ã€‚

