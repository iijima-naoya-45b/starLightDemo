---
title: Turbopack完全ガイド
sidebar:
    label: Turbopack基礎
---

# Turbopack完全ガイド

Turbopackの実践的な実装方法を、実務で使える実装例とベストプラクティスとともに詳しく解説します。

## 1. Turbopackとは

### Turbopackの定義

Turbopackは、Next.jsが開発したRustベースの高速なバンドラーです。Webpackの後継として設計され、大規模なアプリケーションでも高速なビルドと開発サーバーを提供します。

```
Turbopackの特徴
   ├─ 高速なパフォーマンス（Webpackより700倍高速）
   ├─ Rust実装による最適化
   ├─ Next.jsとの統合
   ├─ インクリメンタルコンパイル
   ├─ 並列処理
   └─ 優れた開発体験
```

### Turbopackの背景

```markdown
## Turbopackが開発された背景

### 課題
- **Webpackのパフォーマンス**: 大規模プロジェクトでビルドが遅い
- **開発サーバーの起動時間**: 起動に時間がかかる
- **HMR（Hot Module Replacement）の遅延**: 変更の反映が遅い

### 解決策
- **Rustによる実装**: メモリ安全性とパフォーマンス
- **インクリメンタルコンパイル**: 変更された部分のみを再コンパイル
- **並列処理**: 複数のタスクを並列で実行
- **最適化されたアルゴリズム**: 効率的な依存関係の解決
```

## 2. Turbopackのアーキテクチャ

### アーキテクチャの特徴

```markdown
## Turbopackのアーキテクチャ

### 1. Rustベースの実装
- **メモリ安全性**: Rustの所有権システムによる安全性
- **パフォーマンス**: ネイティブコードレベルの高速性
- **並列処理**: Rustの並列処理機能を活用

### 2. インクリメンタルコンパイル
- **変更の検出**: 変更されたファイルのみを再コンパイル
- **キャッシュ**: コンパイル結果をキャッシュ
- **依存関係の追跡**: 依存関係の変更を追跡

### 3. 並列処理
- **マルチスレッド**: 複数のスレッドで並列処理
- **タスクの分割**: 大きなタスクを小さなタスクに分割
- **効率的なスケジューリング**: 最適な順序でタスクを実行
```

### Webpackとの比較

```markdown
## Turbopack vs Webpack

### パフォーマンス比較

| 項目 | Webpack | Turbopack | 改善率 |
|------|---------|-----------|--------|
| 初回ビルド | 基準 | 10倍高速 | 10x |
| インクリメンタルビルド | 基準 | 700倍高速 | 700x |
| HMR | 基準 | 20倍高速 | 20x |
| 開発サーバー起動 | 基準 | 5倍高速 | 5x |

### 技術的な違い

| 項目 | Webpack | Turbopack |
|------|---------|-----------|
| 実装言語 | JavaScript | Rust |
| 並列処理 | 限定的 | 完全サポート |
| インクリメンタルコンパイル | 部分的 | 完全サポート |
| メモリ使用量 | 高い | 低い |
```

## 3. 環境構築とセットアップ

### Next.jsでの使用

```bash
# Next.js 13+でTurbopackを使用
next dev --turbo

# または package.json に追加
{
  "scripts": {
    "dev": "next dev --turbo",
    "build": "next build"
  }
}
```

### 既存プロジェクトへの移行

```markdown
## 既存プロジェクトへの移行

### ステップ1: Next.jsのバージョン確認
- Next.js 13.0以上が必要
- `package.json`でバージョンを確認

### ステップ2: Turbopackの有効化
- `next dev --turbo`で起動
- 既存のWebpack設定は自動的に互換性が保たれる

### ステップ3: 動作確認
- 開発サーバーが正常に起動するか確認
- HMRが正常に動作するか確認
- ビルドエラーがないか確認
```

### 設定ファイル

```typescript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  // Turbopackはデフォルトで有効（Next.js 13+）
  // 明示的に無効化する場合
  // experimental: {
  //   turbo: false
  // }
  
  // Webpack設定の互換性
  webpack: (config, { isServer }) => {
    // Turbopackでは一部のWebpack設定が無視される場合がある
    return config;
  },
}

module.exports = nextConfig
```

## 4. Turbopackの機能

### インクリメンタルコンパイル

```markdown
## インクリメンタルコンパイル

### 仕組み
1. **変更の検出**: ファイルシステムの変更を監視
2. **影響範囲の特定**: 変更されたファイルとその依存関係を特定
3. **部分的な再コンパイル**: 影響を受けた部分のみを再コンパイル
4. **キャッシュの活用**: 変更されていない部分はキャッシュを使用

### メリット
- **高速なHMR**: 変更の反映が速い
- **効率的なビルド**: 不要な再コンパイルを避ける
- **リソースの節約**: CPUとメモリの使用量を削減
```

### 並列処理

```markdown
## 並列処理

### 並列化される処理
- **モジュールの解決**: 依存関係の解決を並列で実行
- **ローダーの実行**: 複数のローダーを並列で実行
- **プラグインの処理**: プラグインの処理を並列で実行
- **アセットの生成**: アセットの生成を並列で実行

### パフォーマンスへの影響
- **マルチコアの活用**: CPUの複数コアを最大限に活用
- **I/Oの並列化**: ファイル読み込みを並列で実行
- **効率的なスケジューリング**: 最適な順序でタスクを実行
```

### キャッシング

```markdown
## キャッシング

### キャッシュの種類
1. **ファイルシステムキャッシュ**: ファイルの内容をキャッシュ
2. **コンパイル結果キャッシュ**: コンパイル結果をキャッシュ
3. **依存関係キャッシュ**: 依存関係の解決結果をキャッシュ

### キャッシュの管理
- **自動管理**: Turbopackが自動的にキャッシュを管理
- **無効化**: ファイルが変更されると自動的に無効化
- **永続化**: 開発サーバーを再起動してもキャッシュが保持される
```

## 5. 実践的な使用例

### 基本的な使用

```bash
# 開発サーバーの起動（Turbopack使用）
next dev --turbo

# ビルド（Turbopackは本番ビルドでは使用されない）
next build

# 本番サーバーの起動
next start
```

### カスタム設定

```typescript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    turbo: {
      // Turbopack固有の設定
      rules: {
        // カスタムローダーの設定
        '*.svg': {
          loaders: ['@svgr/webpack'],
          as: '*.js',
        },
      },
      resolveAlias: {
        // エイリアスの設定
        '@components': './components',
        '@utils': './utils',
      },
      resolveExtensions: [
        '.js',
        '.jsx',
        '.ts',
        '.tsx',
        '.json',
      ],
    },
  },
}

module.exports = nextConfig
```

### 環境変数の使用

```bash
# .env.local
NEXT_PUBLIC_API_URL=http://localhost:3000/api
DATABASE_URL=postgresql://localhost:5432/mydb
```

```typescript
// 環境変数の使用
const apiUrl = process.env.NEXT_PUBLIC_API_URL;
const dbUrl = process.env.DATABASE_URL;
```

## 6. パフォーマンス最適化

### ビルド時間の最適化

```markdown
## ビルド時間の最適化

### 1. 不要な依存関係の削除
- **未使用のパッケージ**: 使用していないパッケージを削除
- **重複する依存関係**: 重複を解消
- **軽量な代替**: 軽量な代替パッケージを使用

### 2. コード分割の最適化
- **動的インポート**: 必要な時だけロード
- **ルートベースの分割**: ルートごとにコードを分割
- **共通チャンク**: 共通コードを抽出

### 3. キャッシュの活用
- **ビルドキャッシュ**: ビルド結果をキャッシュ
- **依存関係キャッシュ**: 依存関係をキャッシュ
- **ファイルシステムキャッシュ**: ファイルシステムのキャッシュを活用
```

### HMRの最適化

```markdown
## HMR（Hot Module Replacement）の最適化

### 1. 小さな変更の推奨
- **コンポーネント単位**: コンポーネント単位で変更
- **関数単位**: 関数単位で変更
- **ファイル単位**: ファイル単位で変更

### 2. 状態の保持
- **React Fast Refresh**: Reactコンポーネントの状態を保持
- **状態の外部化**: 状態を外部ストアに保存
- **再マウントの回避**: 不要な再マウントを避ける

### 3. パフォーマンスの監視
- **HMR時間の測定**: HMRにかかる時間を測定
- **ボトルネックの特定**: 遅い処理を特定
- **最適化の実施**: ボトルネックを最適化
```

## 7. Webpackからの移行

### 移行の手順

```markdown
## WebpackからTurbopackへの移行

### ステップ1: 互換性の確認
- **Next.js 13+**: Next.js 13.0以上が必要
- **プラグインの確認**: 使用しているWebpackプラグインの互換性を確認
- **ローダーの確認**: カスタムローダーの互換性を確認

### ステップ2: 段階的な移行
- **開発環境**: まず開発環境でTurbopackを試す
- **動作確認**: すべての機能が正常に動作するか確認
- **パフォーマンス測定**: パフォーマンスの改善を確認

### ステップ3: 本番環境への適用
- **ビルドの確認**: 本番ビルドが正常に動作するか確認
- **デプロイ**: ステージング環境にデプロイして確認
- **本番デプロイ**: 問題がなければ本番環境にデプロイ
```

### 互換性の問題

```markdown
## 互換性の問題と解決方法

### 1. Webpackプラグイン
- **問題**: 一部のWebpackプラグインが動作しない
- **解決**: Turbopack対応のプラグインを使用、または代替手段を検討

### 2. カスタムローダー
- **問題**: カスタムローダーが動作しない
- **解決**: Turbopackのルールシステムを使用

### 3. 設定の違い
- **問題**: Webpack設定がそのまま動作しない
- **解決**: Turbopackの設定形式に変換
```

## 8. トラブルシューティング

### よくある問題

```markdown
## よくある問題と解決方法

### 問題1: Turbopackが起動しない
**原因**: Next.jsのバージョンが古い、または設定の問題

**解決方法**:
```bash
# Next.jsのバージョンを確認
npm list next

# Next.jsを最新版に更新
npm install next@latest

# キャッシュをクリア
rm -rf .next
```

### 問題2: HMRが動作しない
**原因**: ファイルの変更が検出されない、または設定の問題

**解決方法**:
```bash
# 開発サーバーを再起動
# Ctrl+Cで停止してから再起動

# キャッシュをクリア
rm -rf .next

# ファイルウォッチャーの確認
# ファイルシステムのイベントが正常に動作しているか確認
```

### 問題3: ビルドエラー
**原因**: 互換性の問題、または設定の誤り

**解決方法**:
```bash
# エラーメッセージを確認
# 詳細なエラーメッセージを確認して原因を特定

# Webpackにフォールバック
# 一時的にWebpackを使用して問題を回避

# 設定の見直し
# next.config.jsの設定を見直す
```

### 問題4: パフォーマンスが改善しない
**原因**: プロジェクトの規模や構成による

**解決方法**:
- **コード分割**: コード分割を最適化
- **依存関係の見直し**: 不要な依存関係を削除
- **キャッシュの確認**: キャッシュが正常に動作しているか確認
```

## 9. ベストプラクティス

### 開発効率の向上

```markdown
## 開発効率を向上させるベストプラクティス

### 1. 適切なファイル構造
- **モジュール化**: 機能ごとにモジュールを分割
- **明確な依存関係**: 依存関係を明確にする
- **循環依存の回避**: 循環依存を避ける

### 2. コード分割
- **ルートベース**: ルートごとにコードを分割
- **動的インポート**: 必要な時だけロード
- **共通チャンク**: 共通コードを抽出

### 3. キャッシュの活用
- **ビルドキャッシュ**: ビルド結果をキャッシュ
- **依存関係キャッシュ**: 依存関係をキャッシュ
- **ファイルシステムキャッシュ**: ファイルシステムのキャッシュを活用
```

### パフォーマンスの最適化

```markdown
## パフォーマンスを最適化するベストプラクティス

### 1. 不要な処理の削減
- **未使用のコード**: 未使用のコードを削除
- **重複する処理**: 重複する処理を統合
- **最適化されたアルゴリズム**: 効率的なアルゴリズムを使用

### 2. 並列処理の活用
- **マルチスレッド**: 複数のスレッドを活用
- **非同期処理**: 非同期処理を適切に使用
- **効率的なスケジューリング**: 最適な順序でタスクを実行

### 3. メモリの最適化
- **メモリリークの回避**: メモリリークを避ける
- **効率的なデータ構造**: 効率的なデータ構造を使用
- **ガベージコレクション**: ガベージコレクションを最適化
```

## 10. 他のバンドラーとの比較

### Turbopack vs Vite

```markdown
## Turbopack vs Vite

### パフォーマンス
- **Turbopack**: Next.jsに最適化、大規模プロジェクトで優位
- **Vite**: 汎用的、中小規模プロジェクトで優位

### 統合
- **Turbopack**: Next.jsと完全統合
- **Vite**: フレームワークに依存しない

### 機能
- **Turbopack**: Next.jsの機能を最大限に活用
- **Vite**: 汎用的な機能を提供
```

### Turbopack vs esbuild

```markdown
## Turbopack vs esbuild

### パフォーマンス
- **Turbopack**: インクリメンタルコンパイルに優位
- **esbuild**: 単発のビルドで優位

### 機能
- **Turbopack**: 開発サーバー、HMR、プラグインシステム
- **esbuild**: 高速なトランスパイル、ミニファイ

### 用途
- **Turbopack**: Next.jsプロジェクトの開発
- **esbuild**: 汎用的なビルドツール
```

## 11. 今後の展望

### Turbopackのロードマップ

```markdown
## Turbopackの今後の展望

### 1. 機能の拡充
- **プラグインシステム**: より柔軟なプラグインシステム
- **カスタムローダー**: より多くのカスタムローダーに対応
- **最適化の改善**: さらなるパフォーマンスの向上

### 2. 互換性の向上
- **Webpack互換性**: より多くのWebpack機能に対応
- **既存ツールとの統合**: 既存のツールとの統合を改善

### 3. コミュニティの成長
- **ドキュメント**: より詳細なドキュメント
- **エコシステム**: プラグインやツールのエコシステムの成長
- **ベストプラクティス**: ベストプラクティスの共有
```

## まとめ

Turbopack完全ガイドのポイント：

- **Turbopackとは**: Next.jsが開発したRustベースの高速バンドラー
- **アーキテクチャ**: Rust実装、インクリメンタルコンパイル、並列処理
- **Webpackとの比較**: 700倍高速なインクリメンタルビルド
- **環境構築**: Next.js 13+で`--turbo`フラグで使用
- **機能**: インクリメンタルコンパイル、並列処理、キャッシング
- **実践的な使用**: カスタム設定、環境変数、パフォーマンス最適化
- **Webpackからの移行**: 段階的な移行、互換性の問題と解決方法
- **トラブルシューティング**: よくある問題と解決方法
- **ベストプラクティス**: 開発効率の向上、パフォーマンスの最適化
- **他のバンドラーとの比較**: Vite、esbuildとの比較
- **今後の展望**: 機能の拡充、互換性の向上、コミュニティの成長

適切なTurbopackの使用により、高速な開発が可能になります。

