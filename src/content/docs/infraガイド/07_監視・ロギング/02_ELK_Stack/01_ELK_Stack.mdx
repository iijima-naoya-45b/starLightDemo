---
title: ELK Stack
sidebar:
    label: ELK Stack
---

# ğŸ“Š ELK Stackå®Œå…¨ã‚¬ã‚¤ãƒ‰

`ELK Stack`ï¼ˆ`Elasticsearch`ã€`Logstash`ã€`Kibana`ï¼‰ã‚’ä½¿ç”¨ã—ãŸãƒ­ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰æ–¹æ³•ã‚’ã€å®Ÿå‹™ã§ä½¿ãˆã‚‹å®Ÿè£…ä¾‹ã¨ã¨ã‚‚ã«è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚

## ğŸ“Š 1. ELK Stackã¨ã¯

### ğŸ“Š ELK Stackã®æ§‹æˆ

`ELK Stack`ã¯ã€ãƒ­ã‚°ã®åé›†ã€å‡¦ç†ã€ä¿å­˜ã€å¯è¦–åŒ–ã‚’è¡Œã†ãŸã‚ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®ãƒ„ãƒ¼ãƒ«ã‚»ãƒƒãƒˆã§ã™ã€‚

```
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
   â†“ï¼ˆãƒ­ã‚°ã‚’é€ä¿¡ï¼‰
Logstashï¼ˆãƒ­ã‚°ã®åé›†ãƒ»å‡¦ç†ï¼‰
   â†“
Elasticsearchï¼ˆãƒ­ã‚°ã®ä¿å­˜ãƒ»æ¤œç´¢ï¼‰
   â†“
Kibanaï¼ˆãƒ­ã‚°ã®å¯è¦–åŒ–ï¼‰
```

### å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å½¹å‰²

#### Elasticsearch

- ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ãƒ»æ¤œç´¢ã™ã‚‹ãŸã‚ã®åˆ†æ•£æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³
- ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ã§é«˜é€Ÿãªæ¤œç´¢æ©Ÿèƒ½ã‚’æä¾›

#### Logstash

- ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ãƒ»å¤‰æ›ãƒ»é€ä¿¡ã™ã‚‹ãŸã‚ã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
- è¤‡æ•°ã®ã‚½ãƒ¼ã‚¹ã‹ã‚‰ãƒ­ã‚°ã‚’åé›†ã—ã€Elasticsearchã«é€ä¿¡

#### Kibana

- Elasticsearchã®ãƒ‡ãƒ¼ã‚¿ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- ãƒ­ã‚°ã®æ¤œç´¢ã€åˆ†æã€å¯è¦–åŒ–ã‚’æä¾›

## 2. Logstashã®è¨­å®š

### åŸºæœ¬çš„ãªè¨­å®š

```ruby
# logstash.conf
input {
  # ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ­ã‚°ã‚’èª­ã¿è¾¼ã‚€
  file {
    path => "/var/log/app/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
  }
  
  # Beatsã‹ã‚‰ãƒ­ã‚°ã‚’å—ä¿¡
  beats {
    port => 5044
  }
}

filter {
  # Grokãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒ­ã‚°ã‚’ãƒ‘ãƒ¼ã‚¹
  grok {
    match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{GREEDYDATA:message}" }
  }
  
  # æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›
  date {
    match => [ "timestamp", "ISO8601" ]
  }
  
  # ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ 
  mutate {
    add_field => { "environment" => "production" }
  }
}

output {
  # Elasticsearchã«é€ä¿¡
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "app-logs-%{+YYYY.MM.dd}"
  }
  
  # ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆæ¨™æº–å‡ºåŠ›ï¼‰
  stdout {
    codec => rubydebug
  }
}
```

### Grokãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä¾‹

```ruby
# ãƒ­ã‚°å½¢å¼: 2024-01-01 12:00:00 INFO User logged in
grok {
  match => { "message" => "%{TIMESTAMP_ISO8601:timestamp} %{LOGLEVEL:level} %{GREEDYDATA:message}" }
}

# ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³
grok {
  match => { "message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] \[%{LOGLEVEL:level}\] %{GREEDYDATA:message}" }
}
```

## 3. Filebeatã®è¨­å®š

### Filebeatã¨ã¯

Filebeatã¯ã€ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›£è¦–ã—ã€Logstashã‚„Elasticsearchã«é€ä¿¡ã™ã‚‹è»½é‡ãªã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ã™ã€‚

```yaml
# filebeat.yml
filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /var/log/app/*.log
    fields:
      app: my-app
      environment: production
    fields_under_root: false
    multiline.pattern: '^\d{4}-\d{2}-\d{2}'
    multiline.negate: true
    multiline.match: after

output.logstash:
  hosts: ["logstash:5044"]

# ã¾ãŸã¯ç›´æ¥Elasticsearchã«é€ä¿¡
# output.elasticsearch:
#   hosts: ["elasticsearch:9200"]
#   index: "app-logs-%{+yyyy.MM.dd}"
```

## 4. Elasticsearchã®è¨­å®š

### åŸºæœ¬çš„ãªè¨­å®š

```yaml
# elasticsearch.yml
cluster.name: my-cluster
node.name: node-1
network.host: 0.0.0.0
http.port: 9200

# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
index.number_of_shards: 1
index.number_of_replicas: 1
```

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

```json
{
  "index_patterns": ["app-logs-*"],
  "template": {
    "settings": {
      "number_of_shards": 1,
      "number_of_replicas": 1
    },
    "mappings": {
      "properties": {
        "@timestamp": {
          "type": "date"
        },
        "level": {
          "type": "keyword"
        },
        "message": {
          "type": "text"
        },
        "app": {
          "type": "keyword"
        }
      }
    }
  }
}
```

## 5. Kibanaã®è¨­å®š

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ä½œæˆ

```json
{
  "title": "app-logs-*",
  "timeFieldName": "@timestamp"
}
```

### ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ä½œæˆ

```json
{
  "title": "Application Logs Dashboard",
  "panels": [
    {
      "type": "visualization",
      "id": "log-level-distribution",
      "gridData": {
        "x": 0,
        "y": 0,
        "w": 24,
        "h": 15
      }
    },
    {
      "type": "visualization",
      "id": "error-logs",
      "gridData": {
        "x": 24,
        "y": 0,
        "w": 24,
        "h": 15
      }
    }
  ]
}
```

## 6. å®Ÿå‹™ã§ã®ãƒ­ã‚°ç®¡ç†æˆ¦ç•¥

### ãƒ­ã‚°ã®æ§‹é€ åŒ–

```json
{
  "@timestamp": "2024-01-01T12:00:00Z",
  "level": "INFO",
  "app": "my-app",
  "environment": "production",
  "message": "User logged in",
  "user_id": "12345",
  "ip_address": "192.168.1.1",
  "request_id": "abc-123-def"
}
```

### ãƒ­ã‚°ã®ä¿æŒæœŸé–“

```yaml
# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†ï¼ˆILMï¼‰
PUT _ilm/policy/log-policy
{
  "policy": {
    "phases": {
      "hot": {
        "actions": {
          "rollover": {
            "max_size": "50GB",
            "max_age": "7d"
          }
        }
      },
      "warm": {
        "min_age": "7d",
        "actions": {
          "shrink": {
            "number_of_shards": 1
          }
        }
      },
      "delete": {
        "min_age": "30d",
        "actions": {
          "delete": {}
        }
      }
    }
  }
}
```

## 7. ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–

### å•é¡Œ1: ãƒ­ã‚°ãŒåé›†ã•ã‚Œãªã„

**åŸå› :**
- Filebeatã®è¨­å®šãŒé–“é•ã£ã¦ã„ã‚‹
- ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ãŒæ­£ã—ããªã„

**è§£æ±ºç­–:**
```bash
# Filebeatã®çŠ¶æ…‹ã‚’ç¢ºèª
filebeat test config
filebeat test output

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’ç¢ºèª
ls -la /var/log/app/
```

### å•é¡Œ2: Elasticsearchã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒä½ã„

**åŸå› :**
- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚·ãƒ£ãƒ¼ãƒ‰æ•°ãŒå¤šã™ãã‚‹
- ãƒ¡ãƒ¢ãƒªãŒä¸è¶³ã—ã¦ã„ã‚‹

**è§£æ±ºç­–:**
```bash
# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª
curl http://localhost:9200/_cat/indices?v

# ã‚·ãƒ£ãƒ¼ãƒ‰æ•°ã‚’èª¿æ•´
PUT /app-logs-*/_settings
{
  "index": {
    "number_of_replicas": 0
  }
}
```

ã“ã‚Œã§ã€ELK Stackã‚’ä½¿ã£ãŸãƒ­ã‚°ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®æ§‹ç¯‰æ–¹æ³•ã‚’ç†è§£ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

